    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>Ø´Ø±ÙƒØ© Ø³Ø­Ø§Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ù‰</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <style>
            :root { --sahab-red: #8b1a1a; --border: #e2e8f0; --sahab-green: #2ecc71; --gold: #ffd700; --blue: #3498db; }
            * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
            
            body { 
                margin: 0; padding: 10px; background: #f4f7f6; 
                height: 100vh; width: 100vw; overflow: hidden;
                display: grid;
                grid-template-columns: 1fr 380px;
                grid-template-rows: 1fr 100px;
                gap: 10px;
                direction: ltr;
            }

            /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
            #login-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #f4f7f6; z-index: 9999; display: flex; align-items: center; justify-content: center;
                direction: rtl;
            }
            .login-box {
                background: white; padding: 40px; border-radius: 25px; border-top: 10px solid var(--sahab-red);
                box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 400px; text-align: center;
            }
            .login-input {
                width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px;
                font-size: 16px; text-align: center; outline: none;
            }
            .login-btn {
                width: 100%; padding: 12px; background: var(--sahab-red); color: white; border: none;
                border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px;
            }

            /* Ù‚Ø·Ø§Ø¹ 1: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ÙŠØ³Ø§Ø±) */
            #sector-1 {
                grid-column: 1; grid-row: 1;
                background: #fff; border-radius: 20px; border: 1px solid #ddd;
                display: flex; flex-direction: column; overflow: hidden;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 2: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ÙŠÙ…ÙŠÙ†) */
            #sector-2 {
                grid-column: 2; grid-row: 1;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--sahab-red);
                padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 3: Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) */
            #sector-3 {
                grid-column: 2; grid-row: 2;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--gold);
                padding: 10px; display: flex; flex-direction: column; gap: 5px;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 4: Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±) */
            #sector-4 {
                grid-column: 1; grid-row: 2;
                background: #fff; border-radius: 20px; border-bottom: 8px solid var(--sahab-red);
                display: flex; align-items: center; justify-content: space-evenly; padding: 0 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                direction: rtl;
            }

            .cmd-btn { 
                width: 100%; padding: 14px; margin-bottom: 10px; 
                border: 2px solid var(--border); border-right: 8px solid var(--sahab-red); 
                border-radius: 12px; background: white; text-align: right; 
                cursor: pointer; font-weight: 900; font-size: 14px;
            }
            .action-btn-main {
                flex: 1; margin: 0 5px; height: 50px; font-weight: 900; 
                cursor: pointer; background: white; border: 1px solid #ddd; 
                border-radius: 10px; transition: 0.2s;
            }
            .action-btn-main:hover:not(:disabled) { background: #f9f9f9; border-color: var(--sahab-red); }
            .action-btn-main:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
            
            /* Hover effects for icons */
            .cmd-btn i, .action-btn-main i { transition: all 0.3s ease; }
            .cmd-btn:hover i { color: var(--sahab-red); transform: scale(1.2); }
            .action-btn-main:hover:not(:disabled) i { color: var(--sahab-red); transform: scale(1.15); }
            
            /* Sector-3 button hover effects */
            #sector-3 button:hover { background: #f5f5f5 !important; border-color: var(--sahab-red) !important; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(139, 26, 26, 0.15); }
            #sector-3 button:hover i { color: #c71616; transform: scale(1.3); }

            .installment-card { background: white; border-radius: 15px; padding: 15px; border: 1px solid var(--border); margin-bottom: 10px; }
            .field-label { color: var(--sahab-red); margin-bottom: 3px; display: block; font-size: 13px; font-weight: 900; }
            .installment-input { width: 100%; padding: 8px; border: 1px solid var(--sahab-red); border-radius: 8px; font-weight: 900; text-align: center; font-size: 14px; }
            .res-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
            .res-table th { background: var(--sahab-red); color: white; padding: 8px; border: 1px solid #ddd; font-size: 12px; }
            .res-table td { padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; }

            .card-item { 
                background: #fff; border: 2px solid #eee; border-right: 10px solid var(--sahab-red); 
                padding: 15px; border-radius: 15px; cursor: pointer; transition: 0.2s; 
            }
            .card-item.selected { border-color: var(--gold); background: #fffdf0; }

            .unit-box {
                width: 80px; height: 80px; color: white; border-radius: 12px; 
                cursor: pointer; display: flex; flex-direction: column; 
                align-items: center; justify-content: center; font-weight: bold;
            }
            .unit-box.selected { border: 3px solid var(--gold); transform: scale(1.05); }

            .dashboard-card {
                background: #fff; border: 1px solid #ddd; border-radius: 15px; padding: 15px; text-align: center;
                border-top: 5px solid var(--sahab-red); cursor: pointer; transition: 0.3s;
            }
            .dashboard-card .value { font-size: 20px; font-weight: 900; color: var(--sahab-red); }
            .dashboard-card .label { font-size: 11px; font-weight: bold; color: #666; margin-top: 5px; }

            .tree-item { margin-right: 20px; border-right: 2px solid #eee; padding-right: 10px; margin-top: 5px; }
            .tree-header { cursor: pointer; font-weight: bold; color: var(--sahab-red); display: flex; align-items: center; gap: 5px; }
            .tree-content { display: none; margin-top: 5px; }
            .tree-content.active { display: block; }

            @media print { .no-print { display: none !important; } body { display: block; } }
            .card-item-row.selected { background: #fff5f5 !important; border-right: 4px solid var(--sahab-red); }
            
            /* New Styles for Expenses and Icons */
            .building-icon-card {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                padding: 20px; background: white; border: 2px solid #eee; border-radius: 15px;
                cursor: pointer; transition: 0.3s; border-bottom: 5px solid var(--sahab-red);
            }
            .building-icon-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            .building-icon-card i { font-size: 40px; color: var(--sahab-red); margin-bottom: 10px; }
            .building-icon-card span { font-weight: bold; font-size: 16px; }
        </style>
    </head>
    <body>

        <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="login-screen">
            <div class="login-box">
                <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:120px; margin-bottom:20px;">
                <h2 style="color:var(--sahab-red); margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <select id="user-type" class="login-input">
                    <option value="admin">Admin </option>
                    <option value="viewer">User </option>
                </select>
                <input type="password" id="login-pass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                <p id="login-error" style="color:red; font-size:12px; margin-top:10px; display:none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</p>
            </div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 1: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙŠØ³Ø§Ø±) -->
        <div id="sector-1">
            <div class="no-print" style="padding: 15px; border-bottom: 2px solid #e74c3c; display: flex; align-items: center; justify-content: space-between; background: #fff;">
                <div style="font-weight: 900; color: #333; font-size: 18px;">
                    <i class="fas fa-chevron-left" style="color: #e74c3c; margin-left: 10px; cursor:pointer;" onclick="goBack()"></i>
                    <span id="current-command-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; direction: ltr;">
                    <div style="text-align: right;">
                        <div style="font-weight: 900; color: #e74c3c; font-size: 18px; line-height: 1;">Ø³Ø­Ø§Ø¨ </div>
                        <div style="font-size: 9px; color: #666; font-weight: bold;">SAHAB </div>
                    </div>
                    <div style="width:60px; height:60px; background: #fff; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eee;">
                        <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:100%; height:100%; object-fit:contain;">
                    </div>
                </div>
            </div>
            <div id="main-content" style="flex: 1; padding:20px; background: #fafafa; overflow-y: auto;"></div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 4: Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±) -->
        <div id="sector-4" class="no-print">
            <button class="action-btn-main" id="btn-add" onclick="executeAction('Ø¥Ø¶Ø§ÙØ©')" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©"><i class="fas fa-plus" style="margin-left: 8px;"></i>Ø¥Ø¶Ø§ÙØ©</button>
            <button class="action-btn-main" id="btn-edit" onclick="executeAction('ØªØ¹Ø¯ÙŠÙ„')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action-btn-main" id="btn-delete" style="color:#e74c3c;" onclick="executeAction('Ø­Ø°Ù')" title="Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯"><i class="fas fa-trash" style="margin-left: 8px;"></i>Ø­Ø°Ù</button>
            <button class="action-btn-main" style="color:#3498db;" onclick="window.print()" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"><i class="fas fa-print" style="margin-left: 8px;"></i>Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="action-btn-main" style="color:#666;" onclick="goBack()" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"><i class="fas fa-arrow-left" style="margin-left: 8px;"></i>Ø±Ø¬ÙˆØ¹</button>
            <button onclick="renderExternalExpenses()" style="padding: 10px 20px; background: var(--sahab-green); color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©"><i class="fas fa-wallet" style="margin-left: 5px;"></i>Ù…ØµØ±ÙˆÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</button>
            <button onclick="showNotifications()" style="width:60px; height:50px; color:#e74c3c; background:white; border:1px solid #ddd; border-radius:10px; position:relative; transition: 0.3s;" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
                <i class="fas fa-bell" style="font-size: 20px;"></i>
                <span id="notif-count" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:9px; position:absolute; top:5px; right:5px; display:none; font-weight: bold;">0</span>
            </button>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 2: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ÙŠÙ…ÙŠÙ†) -->
        <div id="sector-2" class="no-print">
            <div style="font-weight: 900; color: #e74c3c; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</div>
            <div style="background: #fff; border: 3px solid #e74c3c; border-radius: 12px; padding: 10px; text-align: center;">
                <div id="clock" style="font-size: 28px; font-weight: 900; color: #e74c3c;">00:00:00</div>
                <div id="date" style="font-size: 12px; font-weight: 900; color: #555;">--/--/----</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px; flex: 1; margin-top: 10px;">
                <button class="cmd-btn" onclick="renderDashboard()" title="Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-chart-line" style="margin-left: 8px;"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <button class="cmd-btn" onclick="executeAction('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')" title="Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="cmd-btn" id="btn-collect" onclick="executeAction('ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·')" style="border-right-color: var(--sahab-green);" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-coins" style="margin-left: 8px;"></i>ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·</button>
                <div style="display: flex; gap: 5px;">
                    <button class="cmd-btn" onclick="exportBackup()" style="border-right-color: var(--blue); font-size: 10px; padding: 10px 5px; flex: 1;" title="Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"><i class="fas fa-download" style="margin-left: 3px;"></i> ØªØµØ¯ÙŠØ±</button>
                    <button class="cmd-btn" id="btn-import" onclick="document.getElementById('importFile').click()" style="border-right-color: var(--gold); font-size: 10px; padding: 10px 5px; flex: 1;" title="Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©"><i class="fas fa-upload" style="margin-left: 3px;"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                </div>
                <input type="file" id="importFile" style="display:none" onchange="handleImport(event)">
                <button class="cmd-btn" onclick="renderCollectionsManager()" style="border-right-color: #ff9800;" title="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª"><i class="fas fa-file-invoice-dollar" style="margin-left: 8px;"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</button>
                <button class="cmd-btn" id="btn-settings" onclick="renderSettings()" style="border-right-color: #666;" title="ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-cog" style="margin-left: 8px;"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button class="cmd-btn" onclick="logout()" style="border-right-color: #000; background: #f9f9f9;" title="Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-sign-out-alt" style="margin-left: 8px; color: #e74c3c;"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 3: Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) -->
        <div id="sector-3" class="no-print">
            <div style="font-weight: 900; font-size: 14px; text-align: center;">Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="renderRegions()" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><i class="fas fa-map" style="color: #e74c3c;"></i>Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´Ø±ÙƒØ©</button>
                <button id="btn-add-cust" onclick="executeAction('Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"><i class="fas fa-user-plus" style="color: #e74c3c;"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
                <button onclick="executeAction('Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><i class="fas fa-receipt" style="color: #e74c3c;"></i>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
                <button onclick="executeAction('Ø§Ù„Ø®Ø²ÙŠÙ†Ø©')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¹Ø±Ø¶ ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©"><i class="fas fa-vault" style="color: #e74c3c;"></i>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
            </div>
            <div id="tree-container" style="overflow-y: auto; flex: 1; margin-top: 5px; border-top: 1px solid #eee;"></div>
        </div>

        <!-- Style updates for better icon display -->
        <style>
            .cmd-btn { display: flex; align-items: center; justify-content: flex-end; }
            .action-btn-main { display: flex; align-items: center; justify-content: center; font-size: 13px; }
            .cmd-btn:hover { background: #f0f0f0; border-right-color: var(--sahab-red); }
            
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        </style>

        <script>
            // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† ---
            let currentUser = null;
            let passwords = JSON.parse(localStorage.getItem('sahab_passwords')) || { admin: '123', viewer: '456' };

            // --- Ù†Ø¸Ø§Ù… GitHub Cloud Sync ---
            let githubConfig = JSON.parse(localStorage.getItem('sahab_github_config')) || {
                enabled: true,
                owner: 'DrJOO4CODEING',
                repo: 'SAHAB-REAL-EST',
                token: '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',
                branch: 'main',
                filePath: 'DATA.JSON'
            };
            let lastGitHubSync = localStorage.getItem('sahab_last_sync') || null;
            let gitHubSyncInProgress = false;

            function login() {
                const type = document.getElementById('user-type').value;
                const pass = document.getElementById('login-pass').value;
                if (pass === passwords[type]) {
                    currentUser = type;
                    document.getElementById('login-screen').style.display = 'none';
                    applyPermissions();
                    renderDashboard();
                    renderTree();
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            }

            function logout() {
                currentUser = null;
                document.getElementById('login-pass').value = '';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('login-error').style.display = 'none';
            }

            function applyPermissions() {
                const isAdmin = currentUser === 'admin';
                const buttons = ['btn-add', 'btn-edit', 'btn-delete', 'btn-collect', 'btn-import', 'btn-settings', 'btn-add-cust'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = !isAdmin;
                        if (!isAdmin) btn.title = "Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡";
                    }
                });
            }

            // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù ---
            let embeddedDataJson = `{
    "regions": [],
    "customers": [],
    "expenses": [],
    "externalExpenses": [],
    "collections": [],
    "lastUpdate": "${new Date().toISOString()}"
    }`;

            let appData = {
                regions: [],
                customers: [],
                expenses: [],
                externalExpenses: [],
                collections: [],
                selected: { type: null, id: null, rid: null, bid: null, ucode: null, index: null },
                currentView: 'dashboard'
            };

            function initializeData() {
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage Ø£ÙˆÙ„Ø§Ù‹
                let hasLocalData = false;
                if (localStorage.getItem('sahab_regions')) {
                    appData.regions = JSON.parse(localStorage.getItem('sahab_regions'));
                    hasLocalData = true;
                }
                if (localStorage.getItem('sahab_customers')) {
                    appData.customers = JSON.parse(localStorage.getItem('sahab_customers'));
                }
                if (localStorage.getItem('sahab_expenses')) {
                    appData.expenses = JSON.parse(localStorage.getItem('sahab_expenses'));
                }
                if (localStorage.getItem('sahab_external_expenses')) {
                    appData.externalExpenses = JSON.parse(localStorage.getItem('sahab_external_expenses'));
                }
                if (localStorage.getItem('sahab_collections')) {
                    appData.collections = JSON.parse(localStorage.getItem('sahab_collections'));
                }
                
                // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
                if (!hasLocalData) {
                    try {
                        let embedded = JSON.parse(embeddedDataJson);
                        appData.regions = embedded.regions || [];
                        appData.customers = embedded.customers || [];
                        appData.expenses = embedded.expenses || [];
                        appData.externalExpenses = embedded.externalExpenses || [];
                        appData.collections = embedded.collections || [];
                        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù');
                    } catch(e) {
                        console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø¯ÙŠØ¯');
                    }
                }
            }

            function saveData() {
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ localStorage
                localStorage.setItem('sahab_regions', JSON.stringify(appData.regions));
                localStorage.setItem('sahab_customers', JSON.stringify(appData.customers));
                localStorage.setItem('sahab_expenses', JSON.stringify(appData.expenses));
                localStorage.setItem('sahab_external_expenses', JSON.stringify(appData.externalExpenses));
                localStorage.setItem('sahab_collections', JSON.stringify(appData.collections));
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ù…Ù„Ù
                embeddedDataJson = JSON.stringify({
                    regions: appData.regions,
                    customers: appData.customers,
                    expenses: appData.expenses,
                    externalExpenses: appData.externalExpenses,
                    collections: appData.collections,
                    lastUpdate: new Date().toISOString()
                }, null, 2);
                
                // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                showAutoSaveIndicator();
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
                if (githubConfig.enabled && githubConfig.token) {
                    syncDataToGitHub();
                }
                
                checkNotifications();
                renderTree();
            }

            function showAutoSaveIndicator() {
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø¤Ø´Ø± Ø­ÙØ¸ Ø³Ø§Ø¨Ù‚
                const oldIndicator = document.getElementById('auto-save-indicator');
                if (oldIndicator) oldIndicator.remove();
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯
                const indicator = document.createElement('div');
                indicator.id = 'auto-save-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #27ae60;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 25px;
                    font-size: 12px;
                    font-weight: bold;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    animation: slideIn 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    z-index: 10001;
                `;
                indicator.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
                document.body.appendChild(indicator);
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    indicator.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => indicator.remove(), 300);
                }, 2000);
            }

            // --- Ø¯ÙˆØ§Ù„ GitHub Cloud Sync ---
            async function syncDataToGitHub() {
                if (!githubConfig.enabled || !githubConfig.token) return;
                if (gitHubSyncInProgress) return; // ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                
                gitHubSyncInProgress = true;
                showGitHubSyncIndicator('syncing');
                
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù HTML Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
                    const fileContent = await generateHtmlWithData();
                    const encodedContent = btoa(unescape(encodeURIComponent(fileContent)));
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„ØªØ­Ø¯ÙŠØ«)
                    let sha = null;
                    try {
                        const getResponse = await fetch(
                            `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}?ref=${githubConfig.branch}`,
                            {
                                method: 'GET',
                                headers: {
                                    'Authorization': `token ${githubConfig.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        
                        if (getResponse.ok) {
                            const data = await getResponse.json();
                            sha = data.sha;
                        }
                    } catch (e) {
                        console.log('File does not exist yet - will create new');
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù
                    const commitMessage = `ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª SAHAB - ${new Date().toLocaleString('ar-EG')} (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${appData.customers.length}, Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${appData.collections.length})`;
                    
                    const body = {
                        message: commitMessage,
                        content: encodedContent,
                        branch: githubConfig.branch,
                        committer: {
                            name: 'SAHAB Auto Backup',
                            email: 'backup@sahab.local'
                        }
                    };
                    
                    if (sha) {
                        body.sha = sha;
                    }
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        }
                    );
                    
                    if (response.ok) {
                        lastGitHubSync = new Date().toISOString();
                        localStorage.setItem('sahab_last_sync', lastGitHubSync);
                        showGitHubSyncIndicator('success');
                    } else {
                        const error = await response.json();
                        console.error('GitHub sync error:', error);
                        showGitHubSyncIndicator('error', error.message);
                    }
                } catch (error) {
                    console.error('Sync failed:', error);
                    showGitHubSyncIndicator('error', error.message);
                } finally {
                    gitHubSyncInProgress = false;
                }
            }

            async function generateHtmlWithData() {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
                const response = await fetch(window.location.href);
                let htmlContent = await response.text();
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const finalData = {
                    regions: appData.regions,
                    customers: appData.customers,
                    expenses: appData.expenses,
                    externalExpenses: appData.externalExpenses,
                    collections: appData.collections,
                    lastUpdate: new Date().toISOString()
                };
                
                const escapedData = JSON.stringify(finalData, null, 2)
                    .replace(/`/g, '\\`')
                    .replace(/\$/g, '\\$');
                
                // ØªØ­Ø¯ÙŠØ« embeddedDataJson
                htmlContent = htmlContent.replace(
                    /let embeddedDataJson = `[\s\S]*?`;/,
                    `let embeddedDataJson = \`${escapedData}\`;`
                );
                
                return htmlContent;
            }

            function showGitHubSyncIndicator(status, message = '') {
                const oldIndicator = document.getElementById('github-sync-indicator');
                if (oldIndicator) oldIndicator.remove();
                
                let colors = {
                    'syncing': { bg: '#3498db', text: 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub...' },
                    'success': { bg: '#27ae60', text: 'â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub' },
                    'error': { bg: '#e74c3c', text: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸' }
                };
                
                const config = colors[status] || colors['syncing'];
                
                const indicator = document.createElement('div');
                indicator.id = 'github-sync-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 60px;
                    right: 20px;
                    background: ${config.bg};
                    color: white;
                    padding: 12px 18px;
                    border-radius: 25px;
                    font-size: 12px;
                    font-weight: bold;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    animation: slideIn 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    z-index: 10001;
                `;
                indicator.innerHTML = config.text;
                document.body.appendChild(indicator);
                
                if (status !== 'syncing') {
                    setTimeout(() => {
                        indicator.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => indicator.remove(), 300);
                    }, 3000);
                }
            }

            function generateSahabUnits(customUnits = null) {
                if (customUnits) return JSON.parse(JSON.stringify(customUnits));
                let units = [];
                // 2 Ground units
                units.push({ code: 'G1', type: 'Ø£Ø±Ø¶ÙŠ', status: 'available' });
                units.push({ code: 'G2', type: 'Ø£Ø±Ø¶ÙŠ', status: 'available' });
                // 8 Typical units (2 per floor for 4 floors)
                for(let f=1; f<=4; f++) {
                    units.push({ code: `${f}01`, type: 'Ù…ØªÙƒØ±Ø±', status: 'available' });
                    units.push({ code: `${f}02`, type: 'Ù…ØªÙƒØ±Ø±', status: 'available' });
                }
                // 2 Roof units
                units.push({ code: 'R1', type: 'Ø±ÙˆÙˆÙ', status: 'available' });
                units.push({ code: 'R2', type: 'Ø±ÙˆÙˆÙ', status: 'available' });
                return units;
            }

            // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„ ---
            function renderDashboard() {
                appData.currentView = 'dashboard';
                document.getElementById('current-command-text').innerText = "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
                let totalSold = appData.customers.length;
                let totalUnits = appData.regions.reduce((s, r) => s + r.buildings.reduce((ss, b) => ss + b.units.length, 0), 0);
                let totalIncome = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'paid') totalIncome += inst.a; }));

                let html = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                        <div class="dashboard-card" onclick="renderRegions()"><div class="value">${appData.regions.length}</div><div class="label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div></div>
                        <div class="dashboard-card" onclick="executeAction('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')"><div class="value">${totalSold}</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</div></div>
                        <div class="dashboard-card" onclick="renderAvailableUnitsByBuilding()"><div class="value">${totalUnits - totalSold}</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div></div>
                        <div class="dashboard-card" onclick="executeAction('Ø§Ù„Ø®Ø²ÙŠÙ†Ø©')"><div class="value">${totalIncome.toLocaleString()}</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div></div>
                    </div>
                    <div style="margin-top:20px; background:white; padding:20px; border-radius:15px; border:1px solid #ddd;">
                        <h3 style="color:var(--sahab-red); margin-top:0;">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>
                                ${appData.customers.slice(-5).reverse().map(c => `<tr><td>${c.qStart}</td><td>ØªØ¹Ø§Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯: ${c.name}</td><td>${c.total.toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderTree() {
                let html = '';
                appData.regions.forEach(r => {
                    html += `
                        <div class="tree-item">
                            <div class="tree-header" onclick="toggleTree(this)">
                                <i class="fas fa-folder"></i> ${r.name}
                            </div>
                            <div class="tree-content">
                                ${r.buildings.map(b => `
                                    <div class="tree-item" style="margin-right:15px;">
                                        <div class="tree-header" onclick="renderUnits(${r.id}, ${b.id})">
                                            <i class="fas fa-building"></i> ${b.name}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('tree-container').innerHTML = html;
            }

            function toggleTree(el) {
                const content = el.nextElementSibling;
                content.classList.toggle('active');
                el.querySelector('i').classList.toggle('fa-folder-open');
            }

            function handleItemClick(el, type, id, rid = null, bid = null) {
                document.querySelectorAll('.card-item, .card-item-row, .unit-box').forEach(x => x.classList.remove('selected'));
                el.classList.add('selected');
                appData.selected = { type, id, rid, bid, ucode: type === 'unit' ? id : null, index: type === 'customer' ? id : null };
            }

            // --- Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„Ø¹Ù…Ø§Ø±Ø§Øª ---
            function renderRegions() {
                appData.currentView = 'regions';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©";
                let html = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    ${appData.regions.map(r => `
                        <div class="card-item" onclick="handleItemClick(this, 'region', ${r.id})" ondblclick="renderBuildings(${r.id})">
                            <div style="font-weight:900; color:var(--sahab-red);">${r.name}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª: ${r.buildings.length}</div>
                        </div>
                    `).join('')}
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildings(rid) {
                appData.currentView = 'buildings';
                appData.selected.rid = rid;
                const reg = appData.regions.find(r => r.id === rid);
                document.getElementById('current-command-text').innerText = "Ø¹Ù…Ø§Ø±Ø§Øª Ù…Ù†Ø·Ù‚Ø©: " + reg.name;
                let html = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    ${reg.buildings.map(b => `
                        <div class="card-item" onclick="handleItemClick(this, 'building', ${b.id}, ${rid})" ondblclick="renderUnits(${rid}, ${b.id})">
                            <div style="font-weight:900; color:var(--sahab-red);">${b.name}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${b.units.length}</div>
                        </div>
                    `).join('')}
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderUnits(rid, bid) {
                appData.currentView = 'units';
                appData.selected.rid = rid;
                appData.selected.bid = bid;
                const b = appData.regions.find(r => r.id === rid).buildings.find(b => b.id === bid);
                document.getElementById('current-command-text').innerText = "ÙˆØ­Ø¯Ø§Øª Ø¹Ù…Ø§Ø±Ø©: " + b.name;
                let html = `<div style="background:#fff; padding:20px; border-radius:20px; border:1px solid #ddd; text-align:center;">
                    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">${renderUnitBox(b.units[10], rid, bid)} ${renderUnitBox(b.units[11], rid, bid)}</div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; max-width:400px; margin:0 auto 15px auto;">${b.units.slice(2, 10).map(u => renderUnitBox(u, rid, bid)).join('')}</div>
                    <div style="display:flex; gap:10px; justify-content:center;">${renderUnitBox(b.units[0], rid, bid)} ${renderUnitBox(b.units[1], rid, bid)}</div>
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderUnitBox(u, rid, bid) {
                let color = u.status === 'available' ? 'var(--sahab-green)' : 'var(--sahab-red)';
                let customer = appData.customers.find(c => c.unit === u.code && c.building === appData.regions.find(r=>r.id===rid).buildings.find(b=>b.id===bid).name);
                let dblClick = u.status === 'available' ? `executeAction('Ø¥Ø¶Ø§ÙØ©')` : `viewCustomerDetail(${appData.customers.indexOf(customer)})`;
                return `<div class="unit-box" style="background:${color};" onclick="handleItemClick(this, 'unit', '${u.code}', ${rid}, ${bid})" ondblclick="${dblClick}">
                    <span style="font-size:14px;">${u.code}</span>
                    <small style="font-size:8px;">${u.type}</small>
                </div>`;
            }

            // --- Ø§Ù„ØªØ¹Ø§Ù‚Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· ---
            function renderInstallmentForm(editIndex = null) {
                if (currentUser !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Admin ÙÙ‚Ø·");
                let editData = editIndex !== null ? appData.customers[editIndex] : null;
                let unitCode = editData ? editData.unit : (appData.selected.ucode || '');
                let buildingName = editData ? editData.building : (appData.selected.bid ? appData.regions.find(r => r.id === appData.selected.rid).buildings.find(b => b.id === appData.selected.bid).name : '');
                let regionName = editData ? editData.region : (appData.selected.rid ? appData.regions.find(r => r.id === appData.selected.rid).name : '');

                document.getElementById('current-command-text').innerText = editData ? "ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ø§Ù‚Ø¯" : "Ø¬Ø¯ÙˆÙ„Ø© Ø£Ù‚Ø³Ø§Ø·";
                
                let html = `
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span><input type="text" id="custName" class="installment-input" value="${editData ? editData.name : ''}"></div>
                            <div><span class="field-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span><input type="text" id="phone" class="installment-input" value="${editData ? editData.phone : ''}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
                                <select id="selRegion" class="installment-input" onchange="updateBuildingSelect(this.value)">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                                    ${appData.regions.map(r => `<option value="${r.id}" ${regionName === r.name ? 'selected' : ''}>${r.name}</option>`).join('')}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span>
                                <select id="selBuilding" class="installment-input" onchange="updateUnitSelect(this.value)">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>
                                    ${appData.selected.rid ? appData.regions.find(r => r.id == appData.selected.rid).buildings.map(b => `<option value="${b.id}" ${buildingName === b.name ? 'selected' : ''}>${b.name}</option>`).join('') : ''}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <select id="selUnit" class="installment-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>
                                    ${appData.selected.bid ? appData.regions.find(r => r.id == appData.selected.rid).buildings.find(b => b.id == appData.selected.bid).units.map(u => `<option value="${u.code}" ${unitCode === u.code ? 'selected' : ''}>${u.code}</option>`).join('') : ''}
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                            <input type="number" id="totalPrice" class="installment-input" value="${editData ? editData.total : ''}">
                        </div>
                    </div>
                    <div class="installment-card">
                        <span class="field-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</span>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                            <div><small>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</small><input type="number" id="qCount" class="installment-input" value="${editData ? editData.qCount : 28}"></div>
                            <div><small>Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø³Ø·</small>
                                <select id="qFreq" class="installment-input">
                                    <option value="1" ${editData && editData.qFreq == 1 ? 'selected' : ''}>Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="3" ${editData && editData.qFreq == 3 ? 'selected' : ''}>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div><small>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù‚Ø³Ø·</small><input type="date" id="qStart" class="installment-input" value="${editData ? editData.qStart : new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="number" id="downPayment" class="installment-input" value="${editData ? editData.downPayment : ''}"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="date" id="downPaymentDate" class="installment-input" value="${editData ? editData.downPaymentDate : new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                            <div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="number" id="deliveryPayment" class="installment-input" value="${editData ? editData.deliveryPayment : ''}"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="date" id="deliveryPaymentDate" class="installment-input" value="${editData ? editData.deliveryPaymentDate : ''}"></div>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø¯ÙØ¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                            <div id="extra-payments-container">
                                ${editData && editData.extraPayments ? editData.extraPayments.map((ex, i) => `
                                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:5px; margin-bottom:5px;">
                                        <input type="date" class="installment-input ex-date" value="${ex.d}">
                                        <input type="number" class="installment-input ex-amt" value="${ex.a}">
                                        <input type="text" class="installment-input ex-note" value="${ex.t}">
                                        <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <button onclick="addExtraPaymentRow()" style="width:100%; padding:5px; background:#eee; border:1px dashed #ccc; border-radius:5px; cursor:pointer; font-size:12px;">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©/Ù…Ù‚Ø¯Ù…</button>
                        </div>
                        <button onclick="processInstallments(${editIndex})" style="width:100%; padding:12px; background:var(--sahab-red); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</button>
                    </div>
                    ${editData ? `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red); font-size:16px;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            <table class="res-table">
                                <thead style="position: sticky; top: 0; z-index: 10;"><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                                <tbody>
                                    ${editData.installments.map((inst, i) => `
                                        <tr style="${inst.status === 'paid' ? 'background:#e8f5e9;' : ''}">
                                            <td>${i+1}</td><td>${inst.d}</td><td>${inst.a.toLocaleString()}</td><td>${inst.t}</td>
                                            <td style="color:${inst.status === 'paid' ? 'green' : 'red'}">${inst.status === 'paid' ? 'Ù…Ø³Ø¯Ø¯' : 'Ù…Ø¹Ù„Ù‚'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function addExtraPaymentRow() {
                const container = document.getElementById('extra-payments-container');
                const row = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:5px; margin-bottom:5px;">
                        <input type="date" class="installment-input ex-date">
                        <input type="number" class="installment-input ex-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                        <input type="text" class="installment-input ex-note" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ù‚Ø¯Ù…/Ø¯ÙØ¹Ø©)">
                        <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', row);
            }

            function updateBuildingSelect(rid) {
                const reg = appData.regions.find(r => r.id == rid);
                const sel = document.getElementById('selBuilding');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>' + reg.buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                appData.selected.rid = rid;
            }

            function updateUnitSelect(bid) {
                const rid = document.getElementById('selRegion').value;
                const reg = appData.regions.find(r => r.id == rid);
                const bld = reg.buildings.find(b => b.id == bid);
                const sel = document.getElementById('selUnit');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>' + bld.units.map(u => `<option value="${u.code}">${u.code}</option>`).join('');
                appData.selected.bid = bid;
            }

            function processInstallments(editIndex = null) {
                let name = document.getElementById('custName').value;
                let phone = document.getElementById('phone').value;
                let total = parseFloat(document.getElementById('totalPrice').value) || 0;
                let rid = document.getElementById('selRegion').value;
                let bid = document.getElementById('selBuilding').value;
                let ucode = document.getElementById('selUnit').value;

                if(!name || !phone || !rid || !bid || !ucode) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

                let regionObj = appData.regions.find(r => r.id == rid);
                let buildingObj = regionObj.buildings.find(b => b.id == bid);

                let qCount = parseInt(document.getElementById('qCount').value) || 1;
                let qFreq = parseInt(document.getElementById('qFreq').value);
                let qStart = document.getElementById('qStart').value;
                let downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                let downPaymentDate = document.getElementById('downPaymentDate').value;
                let deliveryPayment = parseFloat(document.getElementById('deliveryPayment').value) || 0;
                let deliveryPaymentDate = document.getElementById('deliveryPaymentDate').value;

                let extraPayments = [];
                document.querySelectorAll('#extra-payments-container > div').forEach(div => {
                    let d = div.querySelector('.ex-date').value;
                    let a = parseFloat(div.querySelector('.ex-amt').value) || 0;
                    let t = div.querySelector('.ex-note').value || 'Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©';
                    if(d && a > 0) extraPayments.push({ d, a, t, status: 'pending' });
                });

                let installments = [];
                if (downPayment > 0 && downPaymentDate) installments.push({ d: downPaymentDate, a: downPayment, t: "Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯", status: 'pending' });
                if (deliveryPayment > 0 && deliveryPaymentDate) installments.push({ d: deliveryPaymentDate, a: deliveryPayment, t: "Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…", status: 'pending' });
                
                let extraTotal = extraPayments.reduce((s, p) => s + p.a, 0) + downPayment + deliveryPayment;
                let remaining = total - extraTotal;
                let instAmt = Math.round((remaining / qCount) * 100) / 100;

                extraPayments.forEach(p => installments.push({ ...p }));
                for(let i=0; i<qCount; i++) {
                    let d = new Date(qStart);
                    d.setMonth(d.getMonth() + (i * qFreq));
                    installments.push({ d: d.toISOString().split('T')[0], a: instAmt, t: "Ù‚Ø³Ø· Ø¯ÙˆØ±ÙŠ", status: 'pending' });
                }

                installments.sort((a, b) => new Date(a.d) - new Date(b.d));

                let customerData = { 
                    name, phone, total, qCount, qFreq, qStart, 
                    downPayment, downPaymentDate, deliveryPayment, deliveryPaymentDate,
                    region: regionObj.name, building: buildingObj.name, unit: ucode, 
                    installments, extraPayments 
                };

                if(editIndex !== null) { 
                    appData.customers[editIndex] = customerData; 
                } 
                else { appData.customers.push(customerData); }
                
                buildingObj.units.find(u => u.code === ucode).status = 'sold';
                saveData();
                renderCustomerRegistry();
            }

            function renderCustomerRegistry() {
                appData.currentView = 'registry';
                document.getElementById('current-command-text').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡";
                let html = `
                    <div class="installment-card" style="margin-bottom:10px;">
                        <input type="text" class="installment-input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©..." oninput="filterCustomerRegistry(this.value)">
                    </div>
                    <div id="registry-table-container">
                        ${generateRegistryTable(appData.customers)}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function filterCustomerRegistry(val) {
                let filtered = appData.customers.filter(c => 
                    c.name.includes(val) || 
                    c.phone.includes(val) || 
                    c.unit.includes(val) ||
                    c.building.includes(val)
                );
                document.getElementById('registry-table-container').innerHTML = generateRegistryTable(filtered);
            }

            function generateRegistryTable(data) {
                return `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th></tr></thead>
                    <tbody>
                        ${data.map((c, i) => `
                            <tr class="card-item-row" onclick="handleItemClick(this, 'customer', ${appData.customers.indexOf(c)})" ondblclick="viewCustomerDetail(${appData.customers.indexOf(c)})" style="cursor:pointer;">
                                <td>${c.name}</td><td>${c.phone}</td><td>${c.region}</td><td>${c.building}</td><td>${c.unit}</td><td>${c.total.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            }

            function viewCustomerDetail(index) {
                const c = appData.customers[index];
                document.getElementById('current-command-text').innerText = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: " + c.name;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                let totalPaid = 0;
                let totalPending = 0;
                c.installments.forEach(inst => {
                    if (inst.status === 'paid') totalPaid += inst.a;
                    else totalPending += inst.a;
                });
                
                let html = `
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ø§Ø³Ù…</span><div class="installment-input">${c.name}</div></div>
                            <div><span class="field-label">Ø§Ù„Ù‡Ø§ØªÙ</span><div class="installment-input">${c.phone}</div></div>
                            <div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span><div class="installment-input">${c.building} / ${c.unit}</div></div>
                            <div><span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</span><div class="installment-input">${c.total.toLocaleString()}</div></div>
                        </div>
                        ${currentUser === 'admin' ? `
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button onclick="renderInstallmentForm(${index})" style="flex:1; padding:10px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>` : ''}
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="dashboard-card" style="border-top-color:var(--sahab-green);"><div class="value">${totalPaid.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯</div></div>
                        <div class="dashboard-card" style="border-top-color:var(--sahab-red);"><div class="value">${totalPending.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³ØªØ­Ù‚</div></div>
                        <div class="dashboard-card" style="border-top-color:var(--blue);"><div class="value">${c.installments.length}</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div></div>
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red); font-size:16px;"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                        <table class="res-table">
                            <thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody>
                                ${c.installments.map((inst, i) => `
                                    <tr style="${inst.status === 'paid' ? 'background:#e8f5e9;' : 'background:#fff3f3;'}">
                                        <td>${i+1}</td><td>${inst.d}</td><td style="font-weight:bold; color:${inst.status === 'paid' ? '#27ae60' : '#e74c3c'}">${inst.a.toLocaleString()}</td><td>${inst.t}</td>
                                        <td style="color:${inst.status === 'paid' ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${inst.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}</td>
                                        <td>
                                            <button onclick="editInstallment(${index}, ${i})" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteInstallment(${index}, ${i})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px; margin-left:5px;"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            // --- Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ù† ---
            function renderCollection() {
                document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·";
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-search" style="margin-left: 8px;"></i>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªØ­ØµÙŠÙ„</h3>
                        <input type="text" class="installment-input" placeholder="ğŸ” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©..." oninput="searchCollection(this.value)">
                    </div>
                    <div id="searchResult" style="margin-top:10px;"></div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function searchCollection(val) {
                if(!val) { document.getElementById('searchResult').innerHTML = ''; return; }
                let filtered = appData.customers.filter(c => c.name.includes(val) || c.phone.includes(val) || c.unit.includes(val));
                
                if(filtered.length === 0) {
                    document.getElementById('searchResult').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ù„Ø§Ø¡</div>';
                    return;
                }
                
                document.getElementById('searchResult').innerHTML = filtered.map(c => {
                    let totalPending = c.installments.filter(x => x.status === 'pending').reduce((sum, x) => sum + x.a, 0);
                    return `
                        <div class="card-item" style="margin-bottom:8px; cursor:pointer; border-left: 5px solid var(--sahab-green);" onclick="renderCollectionForCustomer(${appData.customers.indexOf(c)})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--sahab-red); font-size: 14px;">${c.name}</strong><br>
                                    <small style="color: #666;">ğŸ“ ${c.phone} | ğŸ  ${c.building} / ${c.unit}</small>
                                </div>
                                <div style="text-align: center;">
                                    <small style="color: #999;">Ø§Ù„Ù…Ø³ØªØ­Ù‚</small><br>
                                    <strong style="color: var(--sahab-red); font-size: 14px;">${totalPending.toLocaleString()}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderCollectionForCustomer(index) {
                const c = appData.customers[index];
                document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù…Ù†: " + c.name;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ÙÙ‚Ø·
                let pendingInstallments = c.installments.filter(x => x.status === 'pending');
                let totalPending = pendingInstallments.reduce((sum, x) => sum + x.a, 0);
                let totalPaid = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-user-circle" style="margin-left: 8px;"></i>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„Ø§Ø³Ù…</small><br><strong>${c.name}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„Ù‡Ø§ØªÙ</small><br><strong>${c.phone}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„ÙˆØ­Ø¯Ø©</small><br><strong>${c.building} / ${c.unit}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</small><br><strong>${c.total.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="dashboard-card" style="border-top-color:#27ae60;"><div class="value" style="color:#27ae60;">${totalPaid.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯ âœ…</div></div>
                        <div class="dashboard-card" style="border-top-color:#e74c3c;"><div class="value" style="color:#e74c3c;">${totalPending.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³ØªØ­Ù‚ â³</div></div>
                        <div class="dashboard-card" style="border-top-color:#3498db;"><div class="value" style="color:#3498db;">${pendingInstallments.length}</div><div class="label">Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹Ù„Ù‚Ø©</div></div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-coins" style="margin-left: 8px;"></i>ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº Ù…Ø±Ù†</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input type="number" id="collectAmt" class="installment-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº..." min="0" step="0.01"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„</span><input type="date" id="collectDate" class="installment-input" value="${new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <button onclick="processFlexibleCollection(${index})" style="width:100%; padding:12px; background:var(--sahab-green); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; margin-top:10px; font-size:14px;"><i class="fas fa-check-circle" style="margin-left: 8px;"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ÙˆØ§Ù„Ù…Ø³Ø¯Ø¯Ø©</h3>
                        <table class="res-table">
                            <thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody>
                                ${c.installments.map((x, i) => `
                                    <tr style="${x.status === 'paid' ? 'background:#e8f5e9; opacity:0.8;' : 'background:#fff3f3;'}">
                                        <td><strong>${i+1}</strong></td>
                                        <td><strong>${x.d}</strong></td>
                                        <td style="font-weight:bold; color:${x.status === 'paid' ? '#27ae60' : '#e74c3c'}; font-size:12px;">${x.a.toLocaleString()}</td>
                                        <td style="font-size:11px;">${x.t}</td>
                                        <td style="color:${x.status === 'paid' ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${x.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}</td>
                                        <td>
                                            <button onclick="editInstallment(${appData.customers.indexOf(c)}, ${i})" style="background:#ff9800; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:10px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function processFlexibleCollection(custIndex) {
                let amount = parseFloat(document.getElementById('collectAmt').value);
                let collectDate = document.getElementById('collectDate').value;
                if(!amount || amount <= 0) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
                if(!collectDate) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®");

                let c = appData.customers[custIndex];
                let remainingToPay = amount;
                let paidCount = 0;

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                let collectionRecord = {
                    id: Date.now(),
                    customerIndex: custIndex,
                    customerName: c.name,
                    building: c.building,
                    region: c.region,
                    unit: c.unit,
                    amount: amount,
                    date: collectDate,
                    status: 'completed',
                    createdAt: new Date().toISOString()
                };
                
                appData.collections.push(collectionRecord);

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­ØµÙŠÙ„
                for(let i=0; i<c.installments.length; i++) {
                    if(c.installments[i].status === 'pending') {
                        if(remainingToPay >= c.installments[i].a) {
                            remainingToPay -= c.installments[i].a;
                            c.installments[i].status = 'paid';
                            paidCount++;
                        } else if (remainingToPay > 0) {
                            let originalAmt = c.installments[i].a;
                            c.installments[i].a = remainingToPay;
                            c.installments[i].status = 'paid';
                            c.installments.splice(i+1, 0, {
                                d: c.installments[i].d,
                                a: originalAmt - remainingToPay,
                                t: c.installments[i].t + " (Ù…ØªØ¨Ù‚ÙŠ)",
                                status: 'pending'
                            });
                            paidCount++;
                            remainingToPay = 0;
                            break;
                        }
                    }
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                saveData();
                
                // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…ÙØµÙ„Ø©
                let message = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n`;
                message += `ğŸ“Š Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
                message += `â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${amount.toLocaleString()}\n`;
                message += `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©: ${paidCount}\n`;
                message += `â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${collectDate}\n`;
                
                if(remainingToPay > 0) {
                    message += `â€¢ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: ${remainingToPay.toLocaleString()} (Ø²ÙŠØ§Ø¯Ø©)\n`;
                }
                
                alert(message);
                viewCustomerDetail(custIndex);
            }

            // --- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø®Ø²ÙŠÙ†Ø© ---
            function renderExpenses() {
                appData.currentView = 'expenses';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ";
                let html = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:15px; margin-bottom:20px;">
                        ${appData.regions.flatMap(r => r.buildings.map(b => `
                            <div class="building-icon-card" onclick="renderBuildingExpenses('${b.name}')">
                                <i class="fas fa-building"></i>
                                <span>${b.name}</span>
                            </div>
                        `)).join('')}
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="exAmt" class="installment-input"></div>
                            <div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span>
                                <select id="exBld" class="installment-input">
                                    ${appData.regions.flatMap(r => r.buildings.map(b => `<option value="${b.name}">${b.name}</option>`)).join('')}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="exNote" class="installment-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ø³Ø¨Ø§ÙƒØ©..."></div>
                        </div>
                        <button onclick="addExpense()" style="width:100%; padding:10px; background:var(--sahab-red); color:white; border:none; border-radius:10px; margin-top:10px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                    </div>
                    <div id="expenses-list-container">
                        ${generateExpensesTable(appData.expenses)}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingExpenses(bName) {
                let filtered = appData.expenses.filter(e => e.building === bName);
                document.getElementById('current-command-text').innerText = "Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ù…Ø§Ø±Ø©: " + bName;
                document.getElementById('main-content').innerHTML = `
                    <button onclick="renderExpenses()" style="margin-bottom:10px; padding:5px 15px; background:#eee; border:1px solid #ccc; border-radius:5px; cursor:pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙƒØ§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                    ${generateExpensesTable(filtered)}
                `;
            }

            function generateExpensesTable(data) {
                return `
                    <div class="installment-card">
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>
                                ${data.map(e => `<tr><td>${e.date}</td><td>${e.building}</td><td>${e.note}</td><td>${e.amount.toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function addExpense() {
                const amount = parseFloat(document.getElementById('exAmt').value);
                const building = document.getElementById('exBld').value;
                const note = document.getElementById('exNote').value || 'Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù…';
                if(!amount) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
                appData.expenses.push({ date: new Date().toISOString().split('T')[0], amount, building, note });
                saveData();
                renderExpenses();
            }

            function renderTreasury() {
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©";
                let totalIncome = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'paid') totalIncome += inst.a; }));
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ù…Ø±ØªØ¨Ø·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø±ØºØ¨Ø©)
                // ÙˆÙ„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ Ø­Ø¯Ø¯ "Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·"ØŒ Ù„Ø°Ø§ Ø³Ù†ÙƒØªÙÙŠ Ø¨Ù…Ø§ ØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                
                let totalOut = appData.expenses.reduce((s, e) => s + e.amount, 0);
                let balance = totalIncome - totalOut;
                
                let html = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                        <div class="dashboard-card" style="border-top-color:var(--sahab-green); cursor:pointer; transition:0.3s;" onclick="renderTreasuryDetails('income')" ondblclick="renderTreasuryDetails('income')" title="Ø§Ø¶ØºØ· Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                            <div class="value" style="color:var(--sahab-green);">ğŸ“Š ${totalIncome.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:var(--sahab-red); cursor:pointer; transition:0.3s;" onclick="renderExpenses()" title="Ø§Ø¶ØºØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª">
                            <div class="value" style="color:var(--sahab-red);">ğŸ’¸ ${totalOut.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:var(--blue);">
                            <div class="value" style="color:var(--blue);">ğŸ’° ${balance.toLocaleString()}</div>
                            <div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</div>
                        </div>
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-chart-bar" style="margin-left: 8px;"></i>Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                            <div style="background:#f0f8ff; padding:15px; border-radius:10px; border-left:4px solid #3498db;">
                                <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>
                                <strong style="font-size:18px; color:#3498db;">${appData.customers.length}</strong>
                            </div>
                            <div style="background:#f0fff0; padding:15px; border-radius:10px; border-left:4px solid var(--sahab-green);">
                                <small style="color:#666;">Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</small><br>
                                <strong style="font-size:18px; color:var(--sahab-green);">${appData.customers.reduce((sum, c) => sum + c.installments.filter(x => x.status === 'paid').length, 0)}</strong>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderAvailableUnitsByBuilding() {
                document.getElementById('current-command-text').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©";
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-door-open" style="margin-left: 8px;"></i>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©</h3>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                        ${appData.regions.flatMap(r => r.buildings.map(b => {
                            let availableUnits = b.units.filter(u => u.status === 'available');
                            if(availableUnits.length === 0) return '';
                            return `
                                <div class="building-icon-card" onclick="renderUnits(${r.id}, ${b.id})">
                                    <i class="fas fa-building" style="color:var(--sahab-green);"></i>
                                    <strong>${b.name}</strong>
                                    <div style="margin-top:5px; font-size:12px; color:#666;">
                                        ${availableUnits.length} ÙˆØ­Ø¯Ø© Ù…ØªØ§Ø­Ø©
                                    </div>
                                    <div style="margin-top:5px; display:flex; flex-wrap:wrap; gap:2px; justify-content:center;">
                                        ${availableUnits.slice(0, 5).map(u => `<span style="font-size:9px; background:#e8f5e9; padding:2px 4px; border-radius:3px;">${u.code}</span>`).join('')}
                                        ${availableUnits.length > 5 ? '...' : ''}
                                    </div>
                                </div>
                            `;
                        })).join('')}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderTreasuryDetails(type) {
                if(type === 'income') {
                    document.getElementById('current-command-text').innerText = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØµÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©";
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©
                    let buildingIncome = {};
                    appData.customers.forEach(c => {
                        const key = `${c.building} (${c.region})`;
                        if(!buildingIncome[key]) buildingIncome[key] = { income: 0, customers: [] };
                        let custIncome = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                        buildingIncome[key].income += custIncome;
                        buildingIncome[key].customers.push(c);
                    });
                    
                    let totalIncome = Object.values(buildingIncome).reduce((sum, b) => sum + b.income, 0);
                    
                    let html = `
                        <div class="installment-card">
                            <h3 style="color:var(--sahab-red);"><i class="fas fa-building" style="margin-left: 8px;"></i>Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©</h3>
                            <p style="color:#666; font-size:12px; margin:5px 0;">âºï¸ Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† (Double Click) Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ø§Ø±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</p>
                        </div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">
                            ${Object.entries(buildingIncome).map(([building, data]) => {
                                let percentage = (data.income / totalIncome * 100).toFixed(1);
                                return `
                                    <div class="building-icon-card" style="border-bottom: 5px solid var(--sahab-green); cursor:pointer; transition:0.3s;" onclick="renderBuildingCollectionDetails('${building}')" ondblclick="renderBuildingCollectionForm('${building}')">
                                        <i class="fas fa-building" style="font-size: 40px; color: var(--sahab-green); margin-bottom: 10px;"></i>
                                        <strong style="font-size:14px; color:var(--sahab-red);">${building}</strong><br>
                                        <div style="margin-top:8px; font-size:12px; background:#e8f5e9; padding:8px; border-radius:5px; width:100%;">
                                            <strong style="color:var(--sahab-green); font-size:14px;">${data.income.toLocaleString()}</strong><br>
                                            <small style="color:#666;">${percentage}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</small>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    document.getElementById('main-content').innerHTML = html;
                }
            }

            function renderBuildingCollectionDetails(building) {
                document.getElementById('current-command-text').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØµÙˆÙ„: ${building}`;
                
                // Ø¬Ù„Ø¨ Ø¹Ù…Ù„Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø­ØµÙˆÙ„ Ù…Ù†Ù‡Ù…
                let buildingCustomers = appData.customers.filter(c => `${c.building} (${c.region})` === building);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-building" style="margin-left: 8px;"></i>${building}</h3>
                        <p style="color:#666; font-size:12px;">Ø§Ø¶ØºØ· Ù…Ø±ØªÙŠÙ† Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ù†Ù‡</p>
                    </div>
                    <div class="installment-card">
                        <table class="res-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø§Ù„Ù…Ø­ØµÙ„</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingCustomers.map((c, i) => {
                                    let paid = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                                    let pending = c.installments.filter(x => x.status === 'pending').reduce((sum, x) => sum + x.a, 0);
                                    return `
                                        <tr style="cursor:pointer; transition:0.2s;" ondblclick="renderCollectionForCustomer(${appData.customers.indexOf(c)})" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                                            <td style="font-weight:bold;">${c.name}</td>
                                            <td>${c.unit}</td>
                                            <td style="color:var(--sahab-green); font-weight:bold;">${paid.toLocaleString()}</td>
                                            <td style="color:var(--sahab-red); font-weight:bold;">${pending.toLocaleString()}</td>
                                            <td>${c.total.toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingCollectionForm(building) {
                document.getElementById('current-command-text').innerText = `ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…Ø§Ø±Ø©: ${building}`;
                
                let buildingCustomers = appData.customers.filter(c => `${c.building} (${c.region})` === building);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-cash-register" style="margin-left: 8px;"></i>ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…Ø§Ø±Ø© ${building}</h3>
                        <p style="color:#666; font-size:12px;">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                    </div>
                    <div class="installment-card">
                        <span class="field-label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                        <select id="collectionCustomer" class="installment-input" onchange="loadCustomerForCollection()">
                            <option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>
                            ${buildingCustomers.map((c, i) => 
                                `<option value="${appData.customers.indexOf(c)}">${c.name} - ${c.unit} (${c.phone})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div id="customerCollectionForm"></div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function loadCustomerForCollection() {
                const custIndex = document.getElementById('collectionCustomer').value;
                if(!custIndex) return;
                renderCollectionForCustomer(parseInt(custIndex));
            }

            function editInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const inst = c.installments[instIndex];
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ø·</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                                <div class="installment-input" style="background:#f5f5f5;">${c.name}</div>
                            </div>
                            <div>
                                <span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <div class="installment-input" style="background:#f5f5f5;">${c.building} / ${c.unit}</div>
                            </div>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                            <input type="date" id="editDate" class="installment-input" value="${inst.d}">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span>
                            <input type="number" id="editAmount" class="installment-input" value="${inst.a}" step="0.01" min="0">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span>
                            <input type="text" id="editNote" class="installment-input" value="${inst.t}">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                            <select id="editStatus" class="installment-input">
                                <option value="paid" ${inst.status === 'paid' ? 'selected' : ''}>âœ… Ù…Ø³Ø¯Ø¯</option>
                                <option value="pending" ${inst.status === 'pending' ? 'selected' : ''}>â³ Ù…Ø¹Ù„Ù‚</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="saveEditInstallment(${custIndex}, ${instIndex})" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="viewCustomerDetail(${custIndex})" style="flex:1; padding:10px; background:#ccc; color:#333; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('current-command-text').innerText = `ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ø· - ${c.name}`;
                document.getElementById('main-content').innerHTML = html;
            }

            function saveEditInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const newDate = document.getElementById('editDate').value;
                const newAmount = parseFloat(document.getElementById('editAmount').value);
                const newNote = document.getElementById('editNote').value;
                const newStatus = document.getElementById('editStatus').value;
                
                if(!newDate || !newAmount || newAmount <= 0) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldStatus = c.installments[instIndex].status;
                const oldAmount = c.installments[instIndex].a;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                c.installments[instIndex] = {
                    d: newDate,
                    a: newAmount,
                    t: newNote,
                    status: newStatus
                };
                
                saveData();
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª:\nâ€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${newDate}\nâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${newAmount.toLocaleString()}\nâ€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${newStatus === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}`);
                viewCustomerDetail(custIndex);
            }

            function deleteInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const inst = c.installments[instIndex];
                
                if(!confirm(`âš ï¸ Ù‡Ù„ ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ø·ØŸ\n\nØ§Ù„Ù…Ø¨Ù„Øº: ${inst.a.toLocaleString()}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${inst.d}\nØ§Ù„Ø­Ø§Ù„Ø©: ${inst.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}`)) {
                    return;
                }
                
                c.installments.splice(instIndex, 1);
                saveData();
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­');
                viewCustomerDetail(custIndex);
            }

            function renderCollectionsManager() {
                appData.currentView = 'collections';
                document.getElementById('current-command-text').innerText = "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©";
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©
                let buildingCollections = {};
                appData.collections.forEach(col => {
                    const key = `${col.building} (${col.region})`;
                    if(!buildingCollections[key]) {
                        buildingCollections[key] = { 
                            total: 0, 
                            count: 0, 
                            lastCollection: '',
                            collections: [] 
                        };
                    }
                    buildingCollections[key].total += col.amount;
                    buildingCollections[key].count += 1;
                    buildingCollections[key].collections.push(col);
                    buildingCollections[key].lastCollection = new Date(col.date) > new Date(buildingCollections[key].lastCollection) ? col.date : buildingCollections[key].lastCollection;
                });
                
                let totalCollections = appData.collections.reduce((sum, c) => sum + c.amount, 0);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-chart-pie" style="margin-left: 8px;"></i>Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:10px;">
                            <div style="background:#f0fff0; padding:15px; border-radius:10px; border-left:4px solid var(--sahab-green);">
                                <small style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>
                                <strong style="font-size:18px; color:var(--sahab-green);">${totalCollections.toLocaleString()}</strong>
                            </div>
                            <div style="background:#f0f8ff; padding:15px; border-radius:10px; border-left:4px solid #3498db;">
                                <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</small><br>
                                <strong style="font-size:18px; color:#3498db;">${Object.keys(buildingCollections).length}</strong>
                            </div>
                            <div style="background:#fff8f0; padding:15px; border-radius:10px; border-left:4px solid #ff9800;">
                                <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>
                                <strong style="font-size:18px; color:#ff9800;">${appData.collections.length}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-building" style="margin-left: 8px;"></i>Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©</h3>
                        <p style="color:#666; font-size:12px; margin:5px 0;">âºï¸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ø§Ø±Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ | ğŸ“ Double Click Ù„Ø¥Ø¶Ø§ÙØ© ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:10px;">
                        ${Object.entries(buildingCollections).length === 0 ? 
                            '<div style="grid-column: 1/-1; padding:30px; text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­ØµÙŠÙ„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>' :
                            Object.entries(buildingCollections).map(([building, data]) => {
                                let percentage = (data.total / totalCollections * 100).toFixed(1);
                                return `
                                    <div class="building-icon-card" style="border-bottom: 5px solid var(--sahab-green); cursor:pointer; transition:0.3s;" onclick="renderBuildingCollectionsDetails('${building}')" title="Ø§Ø¶ØºØ· Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                        <i class="fas fa-building" style="font-size: 40px; color: var(--sahab-green); margin-bottom: 10px;"></i>
                                        <strong style="font-size:14px; color:var(--sahab-red);">${building}</strong><br>
                                        <div style="margin-top:8px; font-size:12px; background:#e8f5e9; padding:8px; border-radius:5px; width:100%;">
                                            <strong style="color:var(--sahab-green); font-size:14px;">${data.total.toLocaleString()}</strong><br>
                                            <small style="color:#666;">${data.count} ØªØ­ØµÙŠÙ„ (${percentage}%)</small><br>
                                            <small style="color:#999; font-size:10px;">Ø¢Ø®Ø±: ${data.lastCollection}</small>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingCollectionsDetails(building) {
                document.getElementById('current-command-text').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${building}`;
                
                let buildingCollections = appData.collections.filter(c => `${c.building} (${c.region})` === building);
                buildingCollections.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalAmount = buildingCollections.reduce((sum, c) => sum + c.amount, 0);
                
                let html = `
                    <div class="installment-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h3 style="color:var(--sahab-red); margin:0;"><i class="fas fa-building" style="margin-left: 8px;"></i>${building}</h3>
                                <small style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: <strong style="color:var(--sahab-green);">${totalAmount.toLocaleString()}</strong></small>
                            </div>
                            <button onclick="renderCollectionsManager()" style="padding:8px 15px; background:#ddd; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Ø±Ø¬ÙˆØ¹</button>
                        </div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h3>
                        <table class="res-table">
                            <thead>
                                <tr>
                                    <th>Ù…</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingCollections.map((col, idx) => `
                                    <tr style="background:#f9f9f9;">
                                        <td><strong>${idx+1}</strong></td>
                                        <td style="font-weight:bold; color:var(--sahab-red);">${col.customerName}</td>
                                        <td>${col.unit}</td>
                                        <td style="font-weight:bold; color:var(--sahab-green); font-size:13px;">${col.amount.toLocaleString()}</td>
                                        <td>${col.date}</td>
                                        <td style="display:flex; gap:5px;">
                                            <button onclick="editCollection(${col.id})" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteCollection(${col.id})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function editCollection(collectionId) {
                let collection = appData.collections.find(c => c.id === collectionId);
                if(!collection) return alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„');
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„</h3>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                                <div class="installment-input" style="background:#f5f5f5;">${collection.customerName}</div>
                            </div>
                            <div>
                                <span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <div class="installment-input" style="background:#f5f5f5;">${collection.building} / ${collection.unit}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
                            <input type="number" id="editColAmount" class="installment-input" value="${collection.amount}" step="0.01" min="0">
                        </div>
                        
                        <div style="margin-top:10px;">
                            <span class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„</span>
                            <input type="date" id="editColDate" class="installment-input" value="${collection.date}">
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="saveEditCollection(${collectionId})" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="renderCollectionsManager()" style="flex:1; padding:10px; background:#ccc; color:#333; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('current-command-text').innerText = `ØªØ¹Ø¯ÙŠÙ„ ØªØ­ØµÙŠÙ„ - ${collection.customerName}`;
                document.getElementById('main-content').innerHTML = html;
            }

            function saveEditCollection(collectionId) {
                let newAmount = parseFloat(document.getElementById('editColAmount').value);
                let newDate = document.getElementById('editColDate').value;
                
                if(!newAmount || newAmount <= 0) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                }
                if(!newDate) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®');
                }
                
                let collection = appData.collections.find(c => c.id === collectionId);
                let oldAmount = collection.amount;
                
                collection.amount = newAmount;
                collection.date = newDate;
                
                saveData();
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª:\nâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${oldAmount.toLocaleString()} â†’ ${newAmount.toLocaleString()}\nâ€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${newDate}`);
                renderCollectionsManager();
            }

            function deleteCollection(collectionId) {
                let collection = appData.collections.find(c => c.id === collectionId);
                if(!collection) return alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„');
                
                if(!confirm(`âš ï¸ Ù‡Ù„ ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ\n\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${collection.customerName}\nØ§Ù„Ù…Ø¨Ù„Øº: ${collection.amount.toLocaleString()}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${collection.date}`)) {
                    return;
                }
                
                appData.collections = appData.collections.filter(c => c.id !== collectionId);
                saveData();
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                renderCollectionsManager();
            }

            // --- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ---
            function renderExternalExpenses() {
                appData.currentView = 'external';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©)";
                let html = `
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input type="date" id="ext-date" class="installment-input" value="${new Date().toISOString().split('T')[0]}"></div>
                            <div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="ext-desc" class="installment-input"></div>
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="ext-amount" class="installment-input"></div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="addExternalRow()" style="flex:2; padding:10px; background:var(--sahab-red); color:white; border:none; border-radius:10px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                            <button onclick="exportExternalToExcel()" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:10px; cursor:pointer;"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„</button>
                        </div>
                    </div>
                    <div class="installment-card">
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="ext-table-body">
                                ${appData.externalExpenses.map((ex, i) => `
                                    <tr>
                                        <td>${ex.d}</td><td>${ex.t}</td><td>${ex.a.toLocaleString()}</td>
                                        <td><button onclick="deleteExternalExpense(${i})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function addExternalRow() {
                const d = document.getElementById('ext-date').value;
                const t = document.getElementById('ext-desc').value;
                const a = parseFloat(document.getElementById('ext-amount').value);
                if(d && t && a) {
                    appData.externalExpenses.unshift({ d, t, a });
                    saveData();
                    renderExternalExpenses();
                } else {
                    alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                }
            }

            function deleteExternalExpense(index) {
                if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) {
                    appData.externalExpenses.splice(index, 1);
                    saveData();
                    renderExternalExpenses();
                }
            }

            async function exportExternalToExcel() {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©');
                worksheet.columns = [
                    { header: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', key: 'd', width: 15 },
                    { header: 'Ø§Ù„Ø¨ÙŠØ§Ù†', key: 't', width: 30 },
                    { header: 'Ø§Ù„Ù…Ø¨Ù„Øº', key: 'a', width: 15 }
                ];
                appData.externalExpenses.forEach(ex => worksheet.addRow(ex));
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `Ù…ØµØ±ÙˆÙØ§Øª_Ø®Ø§Ø±Ø¬ÙŠØ©_${new Date().getMonth()+1}_${new Date().getFullYear()}.xlsx`);
            }

            // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ---
            function executeAction(name) {
                if (currentUser !== 'admin' && ['Ø¥Ø¶Ø§ÙØ©', 'ØªØ¹Ø¯ÙŠÙ„', 'Ø­Ø°Ù', 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·', 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„', 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©', 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ø§Ø±Ø©'].includes(name)) {
                    return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·)");
                }
                if (name === 'Ø¥Ø¶Ø§ÙØ©') {
                    if (appData.currentView === 'regions') addRegion();
                    else if (appData.currentView === 'buildings') addBuilding();
                    else renderInstallmentForm();
                } else if (name === 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„') {
                    renderInstallmentForm();
                } else if (name === 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡') {
                    renderCustomerRegistry();
                } else if (name === 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ') {
                    renderExpenses();
                } else if (name === 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·') {
                    renderCollection();
                } else if (name === 'ØªØ¹Ø¯ÙŠÙ„') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') renderInstallmentForm(appData.selected.index);
                    else if (appData.selected.type === 'region') editRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') editBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø­Ø°Ù') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') deleteCustomer(appData.selected.index);
                    else if (appData.selected.type === 'region') deleteRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') deleteBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„Ù‰') {
                    renderInstallmentReport('month');
                } else if (name === 'Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©') {
                    renderInstallmentReport('late');
                } else if (name === 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©') {
                    renderTreasury();
                }
            }

            function addRegion() {
                let name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if(name) { appData.regions.push({ id: Date.now(), name, buildings: [] }); saveData(); renderRegions(); }
            }

            function addBuilding() {
                let rid = appData.selected.rid;
                if(!rid && appData.regions.length > 0) {
                    let choice = prompt("Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:\n" + appData.regions.map((r, i) => `${i+1}- ${r.name}`).join('\n'));
                    if(choice && appData.regions[choice-1]) rid = appData.regions[choice-1].id;
                }
                if(!rid) return alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹");
                let name = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if(!name) return;
                const reg = appData.regions.find(r => r.id === rid);
                reg.buildings.push({ id: Date.now(), name, units: generateSahabUnits() });
                saveData();
                renderBuildings(rid);
            }

            function editRegion(id) {
                let reg = appData.regions.find(r => r.id === id);
                let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:", reg.name);
                if (newName) { reg.name = newName; saveData(); renderRegions(); }
            }

            function editBuilding(rid, bid) {
                let reg = appData.regions.find(r => r.id === rid);
                let bld = reg.buildings.find(b => b.id === bid);
                let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©:", bld.name);
                if (newName) { bld.name = newName; saveData(); renderBuildings(rid); }
            }

            function deleteRegion(id) {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { appData.regions = appData.regions.filter(r => r.id !== id); saveData(); renderRegions(); }
            }

            function deleteBuilding(rid, bid) {
                if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©ØŸ")) {
                    let reg = appData.regions.find(r => r.id === rid);
                    reg.buildings = reg.buildings.filter(b => b.id !== bid);
                    saveData();
                    renderBuildings(rid);
                }
            }

            function deleteCustomer(index) {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    const c = appData.customers[index];
                    appData.regions.forEach(r => r.buildings.forEach(b => {
                        let u = b.units.find(u => u.code === c.unit && b.name === c.building);
                        if(u) u.status = 'available';
                    }));
                    appData.customers.splice(index, 1);
                    saveData();
                    renderCustomerRegistry();
                }
            }

            function renderInstallmentReport(type) {
                const today = new Date();
                document.getElementById('current-command-text').innerText = type === 'month' ? "Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ" : "Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©";
                let list = [];
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if(inst.status === 'pending') {
                            const d = new Date(inst.d);
                            if(type === 'month' && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear()) list.push({ ...inst, cust: c.name, unit: c.unit });
                            if(type === 'late' && d < today) list.push({ ...inst, cust: c.name, unit: c.unit });
                        }
                    });
                });
                let html = `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody>
                        ${list.map(x => `<tr><td>${x.cust}</td><td>${x.unit}</td><td>${x.d}</td><td>${x.a.toLocaleString()}</td></tr>`).join('')}
                    </tbody>
                </table>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function checkNotifications() {
                let today = new Date().toISOString().split('T')[0];
                let count = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'pending' && inst.d <= today) count++; }));
                const badge = document.getElementById('notif-count');
                if(badge) { badge.innerText = count; badge.style.display = count > 0 ? 'block' : 'none'; }
            }

            function showNotifications() {
                let today = new Date().toISOString().split('T')[0];
                let notifications = [];
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if(inst.status === 'pending' && inst.d <= today) {
                            notifications.push({ cust: c.name, unit: c.unit, date: inst.d, amount: inst.a });
                        }
                    });
                });
                
                if(notifications.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù…Ø³ØªØ­Ù‚Ø©');
                    return;
                }
                
                document.getElementById('current-command-text').innerText = 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©';
                let html = `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody>
                        ${notifications.map(n => `<tr><td>${n.cust}</td><td>${n.unit}</td><td>${n.date}</td><td>${n.amount.toLocaleString()}</td></tr>`).join('')}
                    </tbody>
                </table>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function goBack() {
                if(appData.currentView === 'units') renderBuildings(appData.selected.rid);
                else if(appData.currentView === 'buildings') renderRegions();
                else renderDashboard();
            }

            function updateClock() {
                const now = new Date();
                const clockEl = document.getElementById('clock');
                const dateEl = document.getElementById('date');
                if(clockEl) clockEl.innerText = now.toLocaleTimeString('ar-EG');
                if(dateEl) dateEl.innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            setInterval(updateClock, 1000);
            updateClock();

            function exportBackup() {
                // ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù…Ù„Ù JSON
                const dataToExport = {
                    timestamp: new Date().toISOString(),
                    regions: appData.regions,
                    customers: appData.customers,
                    expenses: appData.expenses,
                    externalExpenses: appData.externalExpenses
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'sahab_backup_' + new Date().toISOString().split('T')[0] + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            }

            function saveDataToFile() {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù HTML Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
                alert('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø¢Ø®Ø± Ø­Ø§Ù„Ø©
                let finalEmbeddedData = {
                    regions: appData.regions,
                    customers: appData.customers,
                    expenses: appData.expenses,
                    externalExpenses: appData.externalExpenses,
                    collections: appData.collections,
                    lastUpdate: new Date().toISOString()
                };
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
                fetch(window.location.href)
                    .then(response => response.text())
                    .then(htmlContent => {
                        // ØªØ­Ø¯ÙŠØ« embeddedDataJson ÙÙŠ Ø§Ù„Ù…Ù„Ù
                        const escapedData = JSON.stringify(finalEmbeddedData, null, 2)
                            .replace(/`/g, '\\`')
                            .replace(/\$/g, '\\$');
                        
                        let updatedHtml = htmlContent.replace(
                            /let embeddedDataJson = `[\s\S]*?`;/,
                            `let embeddedDataJson = \`${escapedData}\`;`
                        );
                        
                        // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«
                        const blob = new Blob([updatedHtml], { type: 'text/html;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `sahab_data_${new Date().toISOString().split('T')[0]}.html`;
                        link.click();
                        
                        alert(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø©:\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª: ${appData.regions.length}\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${appData.customers.length}\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${appData.collections.length}\n\nğŸ“¤ Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„\n\nğŸ’¡ Ø§Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø£ÙŠ Ø¬Ù‡Ø§Ø² ÙˆÙØªØ­Ù‡ = Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©!`);
                    })
                    .catch(err => {
                        console.error(err);
                        // Ø¨Ø¯ÙŠÙ„: ØªØµØ¯ÙŠØ± ÙƒÙ€ JSON Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                        const dataToExport = finalEmbeddedData;
                        const dataStr = JSON.stringify(dataToExport, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', `sahab_data_${new Date().toISOString().split('T')[0]}.json`);
                        linkElement.click();
                        alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON\n\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø­Ù‚Ø§Ù‹');
                    });
            }

            function handleImport(event) {
                // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù
                        if (imported.regions !== undefined && imported.customers !== undefined) {
                            appData.regions = imported.regions || [];
                            appData.customers = imported.customers || [];
                            appData.expenses = imported.expenses || [];
                            appData.externalExpenses = imported.externalExpenses || [];
                            
                            saveData();
                            alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©...");
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            alert("âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯");
                        }
                    } catch (err) { 
                        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message); 
                    }
                };
                reader.readAsText(file);
            }

            function showAutoSaveStatus() {
                // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const lastSaveTime = new Date().toLocaleString('ar-EG');
                const statsHtml = `
                    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.2); max-width:500px; z-index:10000; border:3px solid #27ae60;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="font-size:48px; color:#27ae60; margin-bottom:10px;">âœ…</div>
                            <strong style="font-size:18px; color:#27ae60;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</strong>
                        </div>
                        
                        <div style="background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:20px;">
                            <strong style="color:#1b5e20; display:block; margin-bottom:10px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:13px;">
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #27ae60;">
                                    <small style="color:#666;">ğŸ¢ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</small><br>
                                    <strong style="color:#27ae60; font-size:16px;">${appData.regions.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #27ae60;">
                                    <small style="color:#666;">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>
                                    <strong style="color:#27ae60; font-size:16px;">${appData.customers.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #ff9800;">
                                    <small style="color:#666;">ğŸ’° Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>
                                    <strong style="color:#ff9800; font-size:16px;">${appData.collections.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #2196F3;">
                                    <small style="color:#666;">ğŸ’³ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©</small><br>
                                    <strong style="color:#2196F3; font-size:16px;">${appData.customers.reduce((sum, c) => sum + (c.installments ? c.installments.length : 0), 0)}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:10px; margin-bottom:20px; border-left:4px solid #ff9800;">
                            <strong style="color:#e65100;">â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong>
                            <div style="color:#666; margin-top:5px; font-size:12px;">${lastSaveTime}</div>
                        </div>
                        
                        <div style="background:#e3f2fd; padding:12px; border-radius:10px; margin-bottom:20px;">
                            <strong style="color:#1976d2; display:block; margin-bottom:8px;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong>
                            <small style="color:#666; line-height:1.6;">
                                âœ“ ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ<br>
                                âœ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„<br>
                                âœ“ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­Ù„ÙŠ<br>
                                âœ“ Ø§Ø³ØªØ®Ø¯Ù… "Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©" Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
                            </small>
                        </div>
                        
                        <button onclick="document.querySelector('[style*=\"position:fixed\"]').remove()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">Ø£ØºÙ„Ù‚ âœ“</button>
                    </div>
                `;
                // Ø¥Ù†Ø´Ø§Ø¡ overlay Ø´ÙØ§Ù
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;';
                overlay.onclick = () => overlay.remove();
                document.body.appendChild(overlay);
                
                const popup = document.createElement('div');
                popup.innerHTML = statsHtml;
                document.body.appendChild(popup.firstElementChild);
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ overlay
                overlay.addEventListener('click', () => {
                    overlay.remove();
                    document.querySelector('[style*="position:fixed"][style*="top:50%"]')?.remove();
                });
            }

            function renderSettings() {
                if (currentUser !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Admin ÙÙ‚Ø·");
                appData.currentView = 'settings';
                document.getElementById('current-command-text').innerText = "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…";
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">âš™ï¸ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± Admin</span><input type="text" id="new-admin-pass" class="installment-input" value="${passwords.admin}"></div>
                            <div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± User</span><input type="text" id="new-viewer-pass" class="installment-input" value="${passwords.viewer}"></div>
                        </div>
                        <button onclick="updatePasswords()" style="width:100%; padding:12px; background:var(--sahab-green); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; margin-top:20px;"><i class="fas fa-check" style="margin-left: 8px;"></i>Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">ğŸ’¾ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <div style="background:#e8f5e9; border:3px solid #27ae60; border-radius:15px; padding:18px; margin-bottom:15px; text-align:center;">
                            <div style="font-size:32px; margin-bottom:10px;">âœ…</div>
                            <strong style="color:#27ae60; font-size:16px; display:block;">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹</strong>
                            <small style="color:#666; display:block; margin-top:8px;">Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„ÙØ¹Ù„ Ø£ÙŠ Ø´ÙŠØ¡ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</small>
                        </div>
                        
                        <div style="display:flex; flex-direction: column; gap:10px;">
                            <button onclick="showAutoSaveStatus()" style="width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:13px;"><i class="fas fa-check-circle"></i>â„¹ï¸ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                            <button onclick="exportBackup()" style="width:100%; padding:12px; background:#9b59b6; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:13px;"><i class="fas fa-download"></i>ğŸ“¥ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button>
                            <button onclick="document.getElementById('settingsImportFile').click()" style="width:100%; padding:12px; background:#e67e22; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:13px;"><i class="fas fa-upload"></i>ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button>
                            <input type="file" id="settingsImportFile" style="display:none" accept=".json" onchange="handleImport(event)">
                        </div>
                        
                        <div style="background:#e3f2fd; border:2px solid #2196F3; border-radius:10px; padding:15px; margin-top:15px;">
                            <strong style="color:#1976d2; font-size:13px; display:block; margin-bottom:10px;">ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px;">
                                <div style="background:#fff; padding:10px; border-radius:5px; border-left:3px solid #2196F3;">
                                    <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</small><br>
                                    <strong id="stat-regions">0</strong>
                                </div>
                                <div style="background:#fff; padding:10px; border-radius:5px; border-left:3px solid #2196F3;">
                                    <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>
                                    <strong id="stat-customers">0</strong>
                                </div>
                                <div style="background:#fff; padding:10px; border-radius:5px; border-left:3px solid #ff9800;">
                                    <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>
                                    <strong id="stat-collections">0</strong>
                                </div>
                                <div style="background:#fff; padding:10px; border-radius:5px; border-left:3px solid #27ae60;">
                                    <small style="color:#666;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</small><br>
                                    <strong id="stat-lastupdate">Ø§Ù„Ø¢Ù†</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:#fff3e0; border:2px solid #ff9800; border-radius:10px; padding:12px; margin-top:12px; font-size:11px;">
                            <strong style="color:#e65100;">ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:</strong><br>
                            â€¢ <strong>ÙƒÙ„ ØªØºÙŠÙŠØ±</strong> (Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ØŒ ØªØ­ØµÙŠÙ„ØŒ Ø­Ø°Ù) ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹<br>
                            â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø­ØªÙ‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ ØªÙØ±ÙŠØº Ø§Ù„Ø°Ø§ÙƒØ±Ø©<br>
                            â€¢ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª - ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„<br>
                            â€¢ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙÙ‚Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
                        </div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">â˜ï¸ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub (Ø§Ù„Ø³Ø­Ø§Ø¨Ø©)</h3>
                        <div style="background:${githubConfig.enabled ? '#e8f5e9' : '#f5f5f5'}; border:2px solid ${githubConfig.enabled ? '#27ae60' : '#ddd'}; border-radius:15px; padding:15px; margin-bottom:15px;">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <input type="checkbox" id="github-enable" ${githubConfig.enabled ? 'checked' : ''} onchange="toggleGithubSync()" style="width:20px; height:20px; cursor:pointer;">
                                <label style="cursor:pointer; font-size:14px;">
                                    <strong>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub</strong>
                                    <br>
                                    <small style="color:#666;">ÙƒÙ„ ØªØºÙŠÙŠØ± ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ GitHub ÙÙˆØ±Ø§Ù‹ â˜ï¸</small>
                                </label>
                            </div>
                        </div>
                        
                        <div id="github-config" style="display:${githubConfig.enabled ? 'block' : 'none'};">
                            <div style="background:#e3f2fd; border:1px solid #2196F3; border-radius:10px; padding:12px; margin-bottom:15px;">
                                <strong style="color:#1976d2; display:block; margin-bottom:8px;">ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:</strong>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; font-size:12px;">
                                    <div>
                                        <small style="color:#666;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ù€ Organization</small>
                                        <input type="text" id="github-owner" placeholder="username" class="installment-input" value="${githubConfig.owner}" style="font-size:12px;">
                                    </div>
                                    <div>
                                        <small style="color:#666;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Repository)</small>
                                        <input type="text" id="github-repo" placeholder="sahab-backup" class="installment-input" value="${githubConfig.repo}" style="font-size:12px;">
                                    </div>
                                    <div style="grid-column:1/-1;">
                                        <small style="color:#666;">Personal Access Token (Ø§Ù„Ø±Ù…Ø²)</small>
                                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="installment-input" value="${githubConfig.token}" style="font-size:12px;">
                                    </div>
                                    <div>
                                        <small style="color:#666;">Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ (Branch)</small>
                                        <input type="text" id="github-branch" placeholder="main" class="installment-input" value="${githubConfig.branch}" style="font-size:12px;">
                                    </div>
                                    <div>
                                        <small style="color:#666;">Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù</small>
                                        <input type="text" id="github-filepath" placeholder="sahab_data.html" class="installment-input" value="${githubConfig.filePath}" style="font-size:12px;">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background:#fff3e0; border:1px solid #ff9800; border-radius:10px; padding:12px; margin-bottom:15px; font-size:12px;">
                                <strong style="color:#e65100; display:block; margin-bottom:8px;">ğŸ“š ÙƒÙŠÙÙŠØ© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>
                                <ol style="margin:5px 0; padding-left:20px;">
                                    <li>Ø§Ø¯Ø®Ù„ Ø¹Ù„Ù‰ <a href="https://github.com/settings/tokens" target="_blank" style="color:#2196F3;">GitHub Settings</a></li>
                                    <li>Ø§Ø®ØªØ± Developer settings â†’ Personal access tokens</li>
                                    <li>Ø§Ø¶ØºØ· "Generate new token (classic)"</li>
                                    <li>Ø­Ø¯Ø¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: <strong>repo</strong> (ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª)</li>
                                    <li>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§</li>
                                </ol>
                            </div>
                            
                            <button onclick="saveGithubConfig()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-bottom:10px;"><i class="fas fa-save"></i>ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub</button>
                            
                            <button onclick="testGithubConnection()" style="width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;"><i class="fas fa-plug"></i>ğŸ”Œ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
                        </div>
                        
                        ${githubConfig.enabled && lastGitHubSync ? `
                            <div style="background:#e8f5e9; border:1px solid #27ae60; border-radius:10px; padding:10px; margin-top:15px; font-size:11px; color:#27ae60;">
                                <strong>âœ… Ø¢Ø®Ø± Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub:</strong><br>
                                ${new Date(lastGitHubSync).toLocaleString('ar-EG')}
                            </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function toggleGithubSync() {
                const checkbox = document.getElementById('github-enable');
                const configDiv = document.getElementById('github-config');
                if (checkbox.checked) {
                    configDiv.style.display = 'block';
                } else {
                    configDiv.style.display = 'none';
                }
            }

            function saveGithubConfig() {
                const owner = document.getElementById('github-owner').value.trim();
                const repo = document.getElementById('github-repo').value.trim();
                const token = document.getElementById('github-token').value.trim();
                const branch = document.getElementById('github-branch').value.trim() || 'main';
                const filePath = document.getElementById('github-filepath').value.trim() || 'sahab_data.html';
                
                if (!owner || !repo || !token) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                }
                
                githubConfig = {
                    enabled: true,
                    owner,
                    repo,
                    token,
                    branch,
                    filePath
                };
                
                localStorage.setItem('sahab_github_config', JSON.stringify(githubConfig));
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ø¨Ù†Ø¬Ø§Ø­!\n\nØ³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ ÙƒÙ„ ØªØºÙŠÙŠØ±.');
            }

            async function testGithubConnection() {
                if (!githubConfig.token) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Personal Access Token Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                const testBtn = event.target;
                testBtn.disabled = true;
                testBtn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`,
                        {
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        alert('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:\n' + `${githubConfig.owner}/${githubConfig.repo}\n\nÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ GitHub.`);
                    } else if (response.status === 404) {
                        alert('âŒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n\nØªØ£ÙƒØ¯ Ù…Ù†:\nâ€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ­ÙŠØ­\nâ€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØµØ­ÙŠØ­\nâ€¢ Ø£Ù†Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„');
                    } else if (response.status === 401) {
                        alert('âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­\n\nØªØ£ÙƒØ¯ Ù…Ù†:\nâ€¢ Ø§Ù„Ø±Ù…Ø² (Token) ØµØ­ÙŠØ­\nâ€¢ Ø§Ù„Ø±Ù…Ø² Ù„Ù… ÙŠÙ†ØªÙ‡ÙŠ\nâ€¢ Ø§Ù„Ø±Ù…Ø² Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§ÙÙŠØ©');
                    } else {
                        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + response.status);
                    }
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:\n' + error.message);
                } finally {
                    testBtn.disabled = false;
                    testBtn.innerText = 'ğŸ”Œ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„';
                }
            }

            function updatePasswords() {
                const adminP = document.getElementById('new-admin-pass').value;
                const viewerP = document.getElementById('new-viewer-pass').value;
                if (!adminP || !viewerP) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±");
                passwords.admin = adminP; 
                passwords.viewer = viewerP;
                localStorage.setItem('sahab_passwords', JSON.stringify(passwords));
                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­');
            }

            window.onload = () => { 
                initializeData();
                checkNotifications(); 
            };
        </script>
    </body>
    </html>
