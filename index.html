<!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>Ø´Ø±ÙƒØ© Ø³Ø­Ø§Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ù‰</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <style>
            :root { --sahab-red: #8b1a1a; --border: #e2e8f0; --sahab-green: #2ecc71; --gold: #ffd700; --blue: #3498db; }
            * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
            
            body { 
                margin: 0; padding: 10px; background: #f4f7f6; 
                height: 100vh; width: 100vw; overflow: hidden;
                display: grid;
                grid-template-columns: 1fr 380px;
                grid-template-rows: 1fr 100px;
                gap: 10px;
                direction: ltr;
            }

            /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
            #login-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #f4f7f6; z-index: 9999; display: flex; align-items: center; justify-content: center;
                direction: rtl;
            }
            .login-box {
                background: white; padding: 40px; border-radius: 25px; border-top: 10px solid var(--sahab-red);
                box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 400px; text-align: center;
            }
            .login-input {
                width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px;
                font-size: 16px; text-align: center; outline: none;
            }
            .login-btn {
                width: 100%; padding: 12px; background: var(--sahab-red); color: white; border: none;
                border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px;
            }

            /* Ù‚Ø·Ø§Ø¹ 1: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ÙŠØ³Ø§Ø±) */
            #sector-1 {
                grid-column: 1; grid-row: 1;
                background: #fff; border-radius: 20px; border: 1px solid #ddd;
                display: flex; flex-direction: column; overflow: hidden;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 2: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ÙŠÙ…ÙŠÙ†) */
            #sector-2 {
                grid-column: 2; grid-row: 1;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--sahab-red);
                padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 3: Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) */
            #sector-3 {
                grid-column: 2; grid-row: 2;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--gold);
                padding: 10px; display: flex; flex-direction: column; gap: 5px;
                direction: rtl;
            }

            /* Ù‚Ø·Ø§Ø¹ 4: Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±) */
            #sector-4 {
                grid-column: 1; grid-row: 2;
                background: #fff; border-radius: 20px; border-bottom: 8px solid var(--sahab-red);
                display: flex; align-items: center; justify-content: space-evenly; padding: 0 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                direction: rtl;
            }

            .cmd-btn { 
                width: 100%; padding: 14px; margin-bottom: 10px; 
                border: 2px solid var(--border); border-right: 8px solid var(--sahab-red); 
                border-radius: 12px; background: white; text-align: right; 
                cursor: pointer; font-weight: 900; font-size: 14px;
            }
            .action-btn-main {
                flex: 1; margin: 0 5px; height: 50px; font-weight: 900; 
                cursor: pointer; background: white; border: 1px solid #ddd; 
                border-radius: 10px; transition: 0.2s;
            }
            .action-btn-main:hover:not(:disabled) { background: #f9f9f9; border-color: var(--sahab-red); }
            .action-btn-main:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
            
            /* Hover effects for icons */
            .cmd-btn i, .action-btn-main i { transition: all 0.3s ease; }
            .cmd-btn:hover i { color: var(--sahab-red); transform: scale(1.2); }
            .action-btn-main:hover:not(:disabled) i { color: var(--sahab-red); transform: scale(1.15); }
            
            /* Sector-3 button hover effects */
            #sector-3 button:hover { background: #f5f5f5 !important; border-color: var(--sahab-red) !important; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(139, 26, 26, 0.15); }
            #sector-3 button:hover i { color: #c71616; transform: scale(1.3); }

            .installment-card { background: white; border-radius: 15px; padding: 15px; border: 1px solid var(--border); margin-bottom: 10px; }
            .field-label { color: var(--sahab-red); margin-bottom: 3px; display: block; font-size: 13px; font-weight: 900; }
            .installment-input { width: 100%; padding: 8px; border: 1px solid var(--sahab-red); border-radius: 8px; font-weight: 900; text-align: center; font-size: 14px; }
            .res-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
            .res-table th { background: var(--sahab-red); color: white; padding: 8px; border: 1px solid #ddd; font-size: 12px; }
            .res-table td { padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; }

            .card-item { 
                background: #fff; border: 2px solid #eee; border-right: 10px solid var(--sahab-red); 
                padding: 15px; border-radius: 15px; cursor: pointer; transition: 0.2s; 
            }
            .card-item.selected { border-color: var(--gold); background: #fffdf0; }

            .unit-box {
                width: 80px; height: 80px; color: white; border-radius: 12px; 
                cursor: pointer; display: flex; flex-direction: column; 
                align-items: center; justify-content: center; font-weight: bold;
            }
            .unit-box.selected { border: 3px solid var(--gold); transform: scale(1.05); }

            .dashboard-card {
                background: #fff; border: 1px solid #ddd; border-radius: 15px; padding: 15px; text-align: center;
                border-top: 5px solid var(--sahab-red); cursor: pointer; transition: 0.3s;
            }
            .dashboard-card .value { font-size: 20px; font-weight: 900; color: var(--sahab-red); }
            .dashboard-card .label { font-size: 11px; font-weight: bold; color: #666; margin-top: 5px; }

            .tree-item { margin-right: 20px; border-right: 2px solid #eee; padding-right: 10px; margin-top: 5px; }
            .tree-header { cursor: pointer; font-weight: bold; color: var(--sahab-red); display: flex; align-items: center; gap: 5px; }
            .tree-content { display: none; margin-top: 5px; }
            .tree-content.active { display: block; }

            @media print { .no-print { display: none !important; } body { display: block; } }
            .card-item-row.selected { background: #fff5f5 !important; border-right: 4px solid var(--sahab-red); }
            
            /* New Styles for Expenses and Icons */
            .building-icon-card {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                padding: 20px; background: white; border: 2px solid #eee; border-radius: 15px;
                cursor: pointer; transition: 0.3s; border-bottom: 5px solid var(--sahab-red);
            }
            .building-icon-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            .building-icon-card i { font-size: 40px; color: var(--sahab-red); margin-bottom: 10px; }
            .building-icon-card span { font-weight: bold; font-size: 16px; }
        </style>
    </head>
    <body>

        <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="login-screen">
            <div class="login-box">
                <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:120px; margin-bottom:20px;">
                <h2 style="color:var(--sahab-red); margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <select id="user-type" class="login-input">
                    <option value="admin">Admin </option>
                    <option value="viewer">User </option>
                </select>
                <input type="password" id="login-pass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                <p id="login-error" style="color:red; font-size:12px; margin-top:10px; display:none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</p>
            </div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 1: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙŠØ³Ø§Ø±) -->
        <div id="sector-1">
            <div class="no-print" style="padding: 15px; border-bottom: 2px solid #e74c3c; display: flex; align-items: center; justify-content: space-between; background: #fff;">
                <div style="font-weight: 900; color: #333; font-size: 18px;">
                    <i class="fas fa-chevron-left" style="color: #e74c3c; margin-left: 10px; cursor:pointer;" onclick="goBack()"></i>
                    <span id="current-command-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; direction: ltr;">
                    <div style="text-align: right;">
                        <div style="font-weight: 900; color: #e74c3c; font-size: 18px; line-height: 1;">Ø³Ø­Ø§Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ù‰ </div>
                        <div style="font-size: 9px; color: #666; font-weight: bold;">SAHAB REAL ESTATES </div>
                    </div>
                    <div style="width:60px; height:60px; background: #fff; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eee;">
                        <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:100%; height:100%; object-fit:contain;">
                    </div>
                </div>
            </div>
            <div id="main-content" style="flex: 1; padding:20px; background: #fafafa; overflow-y: auto;"></div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 4: Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±) -->
        <div id="sector-4" class="no-print">
            <button class="action-btn-main" id="btn-add" onclick="executeAction('Ø¥Ø¶Ø§ÙØ©')" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©"><i class="fas fa-plus" style="margin-left: 8px;"></i>Ø¥Ø¶Ø§ÙØ©</button>
            <button class="action-btn-main" id="btn-edit" onclick="executeAction('ØªØ¹Ø¯ÙŠÙ„')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action-btn-main" id="btn-delete" style="color:#e74c3c;" onclick="executeAction('Ø­Ø°Ù')" title="Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯"><i class="fas fa-trash" style="margin-left: 8px;"></i>Ø­Ø°Ù</button>
            <button class="action-btn-main" style="color:#3498db;" onclick="window.print()" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"><i class="fas fa-print" style="margin-left: 8px;"></i>Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="action-btn-main" style="color:#666;" onclick="goBack()" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"><i class="fas fa-arrow-left" style="margin-left: 8px;"></i>Ø±Ø¬ÙˆØ¹</button>
            <button onclick="renderExternalExpenses()" style="padding: 10px 20px; background: var(--sahab-green); color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©"><i class="fas fa-wallet" style="margin-left: 5px;"></i>Ù…ØµØ±ÙˆÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</button>
            <button onclick="showNotifications()" style="width:60px; height:50px; color:#e74c3c; background:white; border:1px solid #ddd; border-radius:10px; position:relative; transition: 0.3s;" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
                <i class="fas fa-bell" style="font-size: 20px;"></i>
                <span id="notif-count" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:9px; position:absolute; top:5px; right:5px; display:none; font-weight: bold;">0</span>
            </button>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 2: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ÙŠÙ…ÙŠÙ†) -->
        <div id="sector-2" class="no-print">
            <div style="font-weight: 900; color: #e74c3c; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</div>
            <div style="background: #fff; border: 3px solid #e74c3c; border-radius: 12px; padding: 10px; text-align: center;">
                <div id="clock" style="font-size: 28px; font-weight: 900; color: #e74c3c;">00:00:00</div>
                <div id="date" style="font-size: 12px; font-weight: 900; color: #555;">--/--/----</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px; flex: 1; margin-top: 10px;">
                <button class="cmd-btn" onclick="renderDashboard()" title="Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-chart-line" style="margin-left: 8px;"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <button class="cmd-btn" onclick="executeAction('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')" title="Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="cmd-btn" id="btn-collect" onclick="executeAction('ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·')" style="border-right-color: var(--sahab-green);" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-coins" style="margin-left: 8px;"></i>ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·</button>
                <button class="cmd-btn" id="btn-import" onclick="document.getElementById('importFile').click()" style="border-right-color: var(--gold);" title="Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©"><i class="fas fa-upload" style="margin-left: 8px;"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="importFile" style="display:none" onchange="handleImport(event)">
                <button class="cmd-btn" onclick="renderCollectionsManager()" style="border-right-color: #ff9800;" title="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª"><i class="fas fa-file-invoice-dollar" style="margin-left: 8px;"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</button>
                <button class="cmd-btn" id="btn-settings" onclick="renderSettings()" style="border-right-color: #666;" title="ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-cog" style="margin-left: 8px;"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button class="cmd-btn" onclick="logout()" style="border-right-color: #000; background: #f9f9f9;" title="Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-sign-out-alt" style="margin-left: 8px; color: #e74c3c;"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù‚Ø·Ø§Ø¹ 3: Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) -->
        <div id="sector-3" class="no-print">
            <div style="font-weight: 900; font-size: 14px; text-align: center;">Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="renderRegions()" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><i class="fas fa-map" style="color: #e74c3c;"></i>Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´Ø±ÙƒØ©</button>
                <button id="btn-add-cust" onclick="executeAction('Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"><i class="fas fa-user-plus" style="color: #e74c3c;"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
                <button onclick="executeAction('Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><i class="fas fa-receipt" style="color: #e74c3c;"></i>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
                <button onclick="executeAction('Ø§Ù„Ø®Ø²ÙŠÙ†Ø©')" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;" title="Ø¹Ø±Ø¶ ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©"><i class="fas fa-vault" style="color: #e74c3c;"></i>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
            </div>
            <div id="tree-container" style="overflow-y: auto; flex: 1; margin-top: 5px; border-top: 1px solid #eee;"></div>
        </div>

        <!-- Style updates for better icon display -->
        <style>
            .cmd-btn { display: flex; align-items: center; justify-content: flex-end; }
            .action-btn-main { display: flex; align-items: center; justify-content: center; font-size: 13px; }
            .cmd-btn:hover { background: #f0f0f0; border-right-color: var(--sahab-red); }
            
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        </style>

        <script>
            // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† ---
            let currentUser = null;
            let passwords = JSON.parse(localStorage.getItem('sahab_passwords')) || { admin: '123', viewer: '456' };



// === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Upstash Redis ===
let upstashConfig = JSON.parse(localStorage.getItem('sahab_upstash_config')) || {
    enabled: true, // Ù…ÙØ¹Ù‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    url: 'https://distinct-bull-37854.upstash.io',
    token: 'AZPeAAIncDFmMTBlMGE5YzBlNmI0ZTgwYTkxNWRmOGYzMjk4NTYwY3AxMzc4NTQ',
    key: 'sahab_data'
};

let lastCloudSync = localStorage.getItem('sahab_last_sync') || null;
let cloudSyncInProgress = false;

/**
 * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Upstash Redis
 */
async function loadFromUpstash() {
    try {
        const response = await fetch(`${upstashConfig.url}/get/${upstashConfig.key}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${upstashConfig.token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.result) {
                return JSON.parse(data.result);
            }
        }
        return null;
    } catch (error) {
        console.error('Upstash Load Error:', error);
        throw error;
    }
}

/**
 * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Upstash Redis
 */
async function saveToUpstash() {
    if (!upstashConfig.enabled || !upstashConfig.url || !upstashConfig.token) return;
    if (cloudSyncInProgress) return;

    cloudSyncInProgress = true;
    showCloudSyncIndicator('syncing');

    try {
        const dataToSave = {
            regions: appData.regions,
            customers: appData.customers,
            expenses: appData.expenses,
            externalExpenses: appData.externalExpenses,
            collections: appData.collections,
            lastUpdate: new Date().toISOString()
        };

        const response = await fetch(`${upstashConfig.url}/set/${upstashConfig.key}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${upstashConfig.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSave)
        });

        if (response.ok) {
            lastCloudSync = new Date().toISOString();
            localStorage.setItem('sahab_last_sync', lastCloudSync);
            showCloudSyncIndicator('success');
            console.log("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Upstash Redis");
        } else {
            const error = await response.text();
            console.error('Upstash Save Error:', error);
            showCloudSyncIndicator('error', error);
        }
    } catch (error) {
        console.error('Upstash Sync Failed:', error);
        showCloudSyncIndicator('error', error.message);
    } finally {
        cloudSyncInProgress = false;
    }
}

/**
 * Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
 */
function showCloudSyncIndicator(status, message = '') {
    const oldIndicator = document.getElementById('cloud-sync-indicator');
    if (oldIndicator) oldIndicator.remove();
    
    let colors = {
        'syncing': { bg: '#3498db', text: 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...' },
        'success': { bg: '#27ae60', text: 'â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' },
        'error': { bg: '#e74c3c', text: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸' }
    };
    
    const config = colors[status] || colors['syncing'];
    
    const indicator = document.createElement('div');
    indicator.id = 'cloud-sync-indicator';
    indicator.style.cssText = `
        position: fixed;
        bottom: 60px;
        right: 20px;
        background: ${config.bg};
        color: white;
        padding: 12px 18px;
        border-radius: 25px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 10001;
    `;
    indicator.innerHTML = config.text;
    document.body.appendChild(indicator);
    
    if (status !== 'syncing') {
        setTimeout(() => {
            indicator.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => indicator.remove(), 300);
        }, 3000);
    }
}

/**
 * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Upstash
 * Ø§Ø³ØªØ¨Ø¯Ù„ ÙˆØ¸ÙŠÙØ© initializeData() Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡
 */
async function initializeData() {
    try {
        // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Upstash Redis
        if (upstashConfig.enabled && upstashConfig.url && upstashConfig.token) {
            try {
                console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Upstash Redis...");
                const cloudData = await loadFromUpstash();
                
                if (cloudData && cloudData.regions) {
                    appData.regions = cloudData.regions || [];
                    appData.customers = cloudData.customers || [];
                    appData.expenses = cloudData.expenses || [];
                    appData.externalExpenses = cloudData.externalExpenses || [];
                    appData.collections = cloudData.collections || [];
                    
                    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
                    saveToLocalStorage();
                    
                    if (cloudData.lastUpdate) {
                        lastCloudSync = cloudData.lastUpdate;
                        localStorage.setItem('sahab_last_sync', lastCloudSync);
                    }
                    
                    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Upstash Redis");
                    showCloudSyncIndicator('success');
                    renderDashboard();
                    renderTree();
                    return;
                }
            } catch (e) {
                console.error("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Upstash:", e.message);
                showCloudSyncIndicator('error', e.message);
            }
        }

        // 2. ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        try {
            const localRegions = localStorage.getItem('sahab_regions');
            const localCustomers = localStorage.getItem('sahab_customers');
            const localExpenses = localStorage.getItem('sahab_expenses');
            const localExtExpenses = localStorage.getItem('sahab_external_expenses');
            const localCollections = localStorage.getItem('sahab_collections');
            
            if (localRegions) appData.regions = JSON.parse(localRegions);
            if (localCustomers) appData.customers = JSON.parse(localCustomers);
            if (localExpenses) appData.expenses = JSON.parse(localExpenses);
            if (localExtExpenses) appData.externalExpenses = JSON.parse(localExtExpenses);
            if (localCollections) appData.collections = JSON.parse(localCollections);
            
            console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ");
        } catch (e) {
            console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:", e.message);
            // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© ÙƒØ­Ù„ Ø£Ø®ÙŠØ±
            appData = {
                regions: [],
                customers: [],
                expenses: [],
                externalExpenses: [],
                collections: [],
                selected: { type: null, id: null, rid: null, bid: null, ucode: null, index: null },
                currentView: 'dashboard'
            };
        }
        
        renderDashboard();
        renderTree();
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø­Ø±Ø¬ ÙÙŠ initializeData:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©.");
        renderDashboard();
        renderTree();
    }
}

/**
 * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
 */
function saveToLocalStorage() {
    try {
        localStorage.setItem('sahab_regions', JSON.stringify(appData.regions));
        localStorage.setItem('sahab_customers', JSON.stringify(appData.customers));
        localStorage.setItem('sahab_expenses', JSON.stringify(appData.expenses));
        localStorage.setItem('sahab_external_expenses', JSON.stringify(appData.externalExpenses));
        localStorage.setItem('sahab_collections', JSON.stringify(appData.collections));
        localStorage.setItem('sahab_last_modified', new Date().toISOString());
    } catch (error) {
        console.error('LocalStorage Save Error:', error);
    }
}

/**
 * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø­Ù„ÙŠ + Ø³Ø­Ø§Ø¨ÙŠ)
 * Ø§Ø³ØªØ¨Ø¯Ù„ ÙˆØ¸ÙŠÙØ© saveData() Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡
 */
function saveData() {
    try {
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!appData.regions || !Array.isArray(appData.regions)) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }
        
        // 2. Ø­ÙØ¸ ÙÙŠ localStorage
        saveToLocalStorage();
        
        // 3. Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
        showAutoSaveIndicator();
        
        // 4. Ù…Ø²Ø§Ù…Ù†Ø© Upstash (Ù…Ø¹ debounce)
        if (upstashConfig.enabled) {
            clearTimeout(window._syncTimeout);
            window._syncTimeout = setTimeout(() => saveToUpstash(), 3000);
        }
        
        // 5. ØªØ­Ø¯ÙŠØ« UI
        checkNotifications();
        renderTree();
        
        return true;
    } catch (error) {
        console.error('Save Error:', error);
        showError('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', error.message);
        return false;
    }
}

/**
 * Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ
 */
function showAutoSaveIndicator() {
    const oldIndicator = document.getElementById('auto-save-indicator');
    if (oldIndicator) oldIndicator.remove();
    
    const indicator = document.createElement('div');
    indicator.id = 'auto-save-indicator';
    indicator.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 10px 15px;
        border-radius: 25px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 10001;
    `;
    indicator.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
    document.body.appendChild(indicator);
    
    setTimeout(() => {
        indicator.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => indicator.remove(), 300);
    }, 2000);
}

/**
 * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
 */
function showError(title, details = '') {
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10002;
        min-width: 300px;
        border: 3px solid #e74c3c;
    `;
    popup.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 48px; color: #e74c3c;">âŒ</div>
            <strong style="color: #e74c3c; font-size: 18px;">${title}</strong>
            ${details ? `<div style="margin-top: 10px; color: #666; font-size: 12px;">${details}</div>` : ''}
            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    `;
    document.body.appendChild(popup);
    
    setTimeout(() => popup.remove(), 5000);
}

/**
 * ØªØ­Ø³ÙŠÙ† processFlexibleCollection Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ
 * Ø§Ø³ØªØ¨Ø¯Ù„ ÙˆØ¸ÙŠÙØ© processFlexibleCollection() Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡
 */
function processFlexibleCollection(custIndex) {
    try {
        let amount = parseFloat(document.getElementById('collectAmt').value);
        let collectDate = document.getElementById('collectDate').value;
        
        if(!amount || amount <= 0) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
        if(!collectDate) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®");

        let c = appData.customers[custIndex];
        let remainingToPay = amount;
        let paidCount = 0;

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„
        let collectionRecord = {
            id: Date.now(),
            customerIndex: custIndex,
            customerName: c.name,
            building: c.building,
            region: c.region,
            unit: c.unit,
            amount: amount,
            date: collectDate,
            status: 'completed',
            createdAt: new Date().toISOString()
        };
        
        appData.collections.push(collectionRecord);

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ
        for(let i=0; i<c.installments.length; i++) {
            if(remainingToPay <= 0) break;
            if(c.installments[i].status === 'pending') {
                if(remainingToPay >= c.installments[i].a) {
                    // Ø³Ø¯Ø§Ø¯ ÙƒØ§Ù…Ù„
                    remainingToPay -= c.installments[i].a;
                    c.installments[i].status = 'paid';
                    c.installments[i].paidDate = collectDate;
                    paidCount++;
                } else {
                    // Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ - ØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ partialPayments
                    if (!c.installments[i].partialPayments) {
                        c.installments[i].partialPayments = [];
                    }
                    c.installments[i].partialPayments.push({
                        amount: remainingToPay,
                        date: collectDate,
                        remaining: c.installments[i].a - remainingToPay
                    });
                    c.installments[i].a = Math.round((c.installments[i].a - remainingToPay) * 100) / 100;
                    c.installments[i].t = c.installments[i].t.replace(' (Ù…ØªØ¨Ù‚ÙŠ)', '') + ' (Ù…ØªØ¨Ù‚ÙŠ)';
                    remainingToPay = 0;
                }
            }
        }
        
        saveData();
        
        let totalPaid = c.installments.filter(x => x.status === 'paid').reduce((s,x)=>s+x.a, 0);
        let totalPending = c.installments.filter(x => x.status === 'pending').reduce((s,x)=>s+x.a, 0);

        let message = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n`;
        message += `ğŸ“Š Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
        message += `â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${amount.toLocaleString()}\n`;
        message += `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© ÙƒØ§Ù…Ù„Ø§Ù‹: ${paidCount}\n`;
        message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯: ${totalPaid.toLocaleString()}\n`;
        message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${totalPending.toLocaleString()}\n`;
        message += `â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${collectDate}\n`;
        
        alert(message);
        viewCustomerDetail(custIndex);
    } catch (error) {
        console.error('Collection Error:', error);
        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„', error.message);
    }
}

/**
 * ØªØ­Ø³ÙŠÙ† processInstallments Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
 * Ø£Ø¶Ù try-catch Ù„Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
 */
function processInstallments(editIndex = null) {
    try {
        // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹...
        // Ø£Ø¶Ù ÙÙ‚Ø· try-catch wrapper Ø­ÙˆÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        
    } catch (error) {
        console.error('Process Installments Error:', error);
        showError('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', error.message);
    }
}

/**
 * ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù…Ù† Upstash
 */
async function manualSyncFromCloud() {
    if (!upstashConfig.enabled || !upstashConfig.token) {
        return alert('âŒ Upstash ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. Ø§Ø·Ù„Ø¨ Ù…Ù† Admin Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    }
    const btn = document.getElementById('sync-cloud-btn');
    if (btn) { btn.disabled = true; btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; }
    
    try {
        const cloudData = await loadFromUpstash();
        if (cloudData && cloudData.regions) {
            appData.regions = cloudData.regions;
            appData.customers = cloudData.customers;
            appData.expenses = cloudData.expenses;
            appData.externalExpenses = cloudData.externalExpenses;
            appData.collections = cloudData.collections;
            
            lastCloudSync = cloudData.lastUpdate || new Date().toISOString();
            localStorage.setItem('sahab_last_sync', lastCloudSync);
            saveToLocalStorage();
            
            renderDashboard();
            renderTree();
            renderSettings();
            alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nØ¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date(lastCloudSync).toLocaleString('ar-EG'));
        } else {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
        }
    } catch(e) {
        alert('âŒ Ø®Ø·Ø£: ' + e.message);
    } finally {
        if (btn) { btn.disabled = false; btn.innerText = 'â˜ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†'; }
    }
}

/**
 * Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Upstash
 */
async function testUpstashConnection(event) {
    const testBtn = event ? event.target : null;
    if (testBtn) { testBtn.disabled = true; testBtn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...'; }

    try {
        const response = await fetch(`${upstashConfig.url}/ping`, {
            headers: {
                'Authorization': `Bearer ${upstashConfig.token}`
            }
        });

        if (response.ok) {
            alert('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!\n\nUpstash Redis Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
            await initializeData();
        } else {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù…Ø² (Token) ÙˆØ§Ù„Ù€ URL');
        }
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ' + error.message);
    } finally {
        if (testBtn) { testBtn.disabled = false; testBtn.innerText = 'ğŸ”Œ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„'; }
    }
}

// === Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===

function renderSettings() {
    appData.currentView = 'settings';
    document.getElementById('current-command-text').innerText = currentUser === 'admin' ? "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" : "Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø³Ø­Ø§Ø¨Ø©";

    let syncStatus = upstashConfig.enabled
        ? (lastCloudSync
            ? '<span style="color:#27ae60;">âœ… Ù…ØªØµÙ„ â€” Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date(lastCloudSync).toLocaleString('ar-EG') + '</span>'
            : '<span style="color:#ff9800;">âš ï¸ Ù…ÙØ¹Ù‘Ù„ â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¹Ø¯</span>')
        : '<span style="color:#e74c3c;">âŒ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</span>';

    let totalPaid = 0;
    appData.customers.forEach(function(c){ c.installments.forEach(function(i){ if(i.status==='paid') totalPaid+=i.a; }); });
    let totalBuildings = appData.regions.reduce(function(s,r){ return s+r.buildings.length; }, 0);

    let sharedHtml =
        '<div class="installment-card">' +
            '<h3 style="color:var(--sahab-red); margin-top:0;">â˜ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>' +
            '<div style="background:#f0f8ff; border:2px solid #3498db; border-radius:12px; padding:15px; margin-bottom:15px;">' +
                '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">' +
                    '<div style="background:#fff;padding:12px;border-radius:8px;border-right:4px solid var(--sahab-red);text-align:center;">' +
                        '<small style="color:#666;">ğŸ¢ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</small><br>' +
                        '<strong style="font-size:20px;color:var(--sahab-red);">' + totalBuildings + '</strong>' +
                    '</div>' +
                    '<div style="background:#fff;padding:12px;border-radius:8px;border-right:4px solid #3498db;text-align:center;">' +
                        '<small style="color:#666;">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>' +
                        '<strong style="font-size:20px;color:#3498db;">' + appData.customers.length + '</strong>' +
                    '</div>' +
                    '<div style="background:#fff;padding:12px;border-radius:8px;border-right:4px solid #27ae60;text-align:center;">' +
                        '<small style="color:#666;">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</small><br>' +
                        '<strong style="font-size:16px;color:#27ae60;">' + totalPaid.toLocaleString() + '</strong>' +
                    '</div>' +
                    '<div style="background:#fff;padding:12px;border-radius:8px;border-right:4px solid #ff9800;text-align:center;">' +
                        '<small style="color:#666;">ğŸ“‹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>' +
                        '<strong style="font-size:20px;color:#ff9800;">' + appData.collections.length + '</strong>' +
                    '</div>' +
                '</div>' +
                '<div style="background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;">' +
                    '<small style="color:#666;">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:</small><br>' +
                    '<strong style="font-size:13px;">' + syncStatus + '</strong>' +
                '</div>' +
                '<button id="sync-cloud-btn" onclick="manualSyncFromCloud()" style="width:100%;padding:12px;background:var(--sahab-red);color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;font-size:14px;">â˜ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†</button>' +
            '</div>' +
        '</div>';

    let adminHtml = '';
    if (currentUser === 'admin') {
        adminHtml =
            '<div class="installment-card">' +
                '<h3 style="color:var(--sahab-red);">âš™ï¸ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</h3>' +
                '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">' +
                    '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± Admin</span><input type="password" id="new-admin-pass" class="installment-input" value="' + passwords.admin + '"></div>' +
                    '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± User</span><input type="password" id="new-viewer-pass" class="installment-input" value="' + passwords.viewer + '"></div>' +
                '</div>' +
                '<button onclick="updatePasswords()" style="width:100%;padding:12px;background:var(--sahab-green);color:white;border:none;border-radius:10px;font-weight:900;cursor:pointer;margin-top:20px;"><i class="fas fa-check" style="margin-left:8px;"></i>Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</button>' +
            '</div>' +
            '<div class="installment-card">' +
                '<h3 style="color:var(--sahab-red);">ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Upstash Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</h3>' +
                '<div style="background:' + (upstashConfig.enabled ? '#e8f5e9' : '#f5f5f5') + '; border:2px solid ' + (upstashConfig.enabled ? '#27ae60' : '#ddd') + '; border-radius:15px; padding:15px; margin-bottom:15px;">' +
                    '<div style="display:flex; align-items:center; gap:10px;">' +
                        '<input type="checkbox" id="upstash-enable" ' + (upstashConfig.enabled ? 'checked' : '') + ' onchange="toggleUpstashSync()" style="width:20px;height:20px;cursor:pointer;">' +
                        '<label style="cursor:pointer;font-size:14px;"><strong>ØªÙØ¹ÙŠÙ„ Upstash Cloud</strong><br><small style="color:#666;">ÙƒÙ„ ØªØºÙŠÙŠØ± ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â˜ï¸</small></label>' +
                    '</div>' +
                '</div>' +
                '<div style="background:#e3f2fd;border:1px solid #2196F3;border-radius:10px;padding:12px;margin-bottom:15px;">' +
                    '<strong style="color:#1976d2;display:block;margin-bottom:8px;">ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø­ÙÙˆØ¸Ø©):</strong>' +
                    '<div style="font-size:12px;color:#666;">' +
                        '<div style="margin-bottom:8px;">ğŸ“ URL: ' + upstashConfig.url + '</div>' +
                        '<div style="margin-bottom:8px;">ğŸ” Token: AZPeAAInc... (Ù…Ø®ÙÙŠ)</div>' +
                        '<div>ğŸ’¾ Key: ' + upstashConfig.key + '</div>' +
                    '</div>' +
                '</div>' +
                '<button onclick="testUpstashConnection(event)" style="width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:10px;">ğŸ”Œ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>' +
                '<button onclick="exportBackup()" style="width:100%;padding:12px;background:#9b59b6;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;"><i class="fas fa-download" style="margin-left:8px;"></i>ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>' +
            '</div>';
    }

    document.getElementById('main-content').innerHTML = sharedHtml + adminHtml;
}

function toggleUpstashSync() {
    const checkbox = document.getElementById('upstash-enable');
    upstashConfig.enabled = checkbox.checked;
    localStorage.setItem('sahab_upstash_config', JSON.stringify(upstashConfig));
    renderSettings();
}

console.log("âœ… Upstash Integration Loaded Successfully!");
            function login() {
                const type = document.getElementById('user-type').value;
                const pass = document.getElementById('login-pass').value;
                if (pass === passwords[type]) {
                    currentUser = type;
                    document.getElementById('login-screen').style.display = 'none';
                    applyPermissions();
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                    showCloudLoadingScreen();
                    initializeData();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            }

            function showCloudLoadingScreen() {
                document.getElementById('main-content').innerHTML =
                    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;gap:20px;">' +
                    '<div style="font-size:48px;">â˜ï¸</div>' +
                    '<div style="font-size:18px;font-weight:bold;color:var(--sahab-red);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>' +
                    '<div style="width:200px;height:6px;background:#eee;border-radius:3px;overflow:hidden;">' +
                    '<div style="height:100%;background:var(--sahab-red);border-radius:3px;animation:slideIn 1.5s ease infinite;width:60%;"></div>' +
                    '</div>' +
                    '</div>';
            }

            function logout() {
                currentUser = null;
                document.getElementById('login-pass').value = '';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('login-error').style.display = 'none';
            }

            function applyPermissions() {
                const isAdmin = currentUser === 'admin';
                const buttons = ['btn-add', 'btn-edit', 'btn-delete', 'btn-collect', 'btn-import', 'btn-add-cust'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = !isAdmin;
                        if (!isAdmin) btn.title = "Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡";
                    }
                });
            }

            // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù ---
            let embeddedDataJson = `{
    "regions": [],
    "customers": [],
    "expenses": [],
    "externalExpenses": [],
    "collections": [],
    "lastUpdate": "${new Date().toISOString()}"
    }`;

            let appData = {
                regions: [],
                customers: [],
                expenses: [],
                externalExpenses: [],
                collections: [],
                selected: { type: null, id: null, rid: null, bid: null, ucode: null, index: null },
                currentView: 'dashboard'
            };

////
            function generateSahabUnits(customUnits = null) {
                if (customUnits) return JSON.parse(JSON.stringify(customUnits));
                let units = [];
                // 2 Ground units
                units.push({ code: 'G1', type: 'Ø£Ø±Ø¶ÙŠ', status: 'available' });
                units.push({ code: 'G2', type: 'Ø£Ø±Ø¶ÙŠ', status: 'available' });
                // 8 Typical units (2 per floor for 4 floors)
                for(let f=1; f<=4; f++) {
                    units.push({ code: `${f}01`, type: 'Ù…ØªÙƒØ±Ø±', status: 'available' });
                    units.push({ code: `${f}02`, type: 'Ù…ØªÙƒØ±Ø±', status: 'available' });
                }
                // 2 Roof units
                units.push({ code: 'R1', type: 'Ø±ÙˆÙˆÙ', status: 'available' });
                units.push({ code: 'R2', type: 'Ø±ÙˆÙˆÙ', status: 'available' });
                return units;
            }

            // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„ ---
            // ===== ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© =====
            function fixOldDownPayments() {
                let fixed = 0;
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if (inst.status === 'pending' && (inst.t === 'Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯' || inst.t === 'Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…' || inst.t.includes('Ø¯ÙØ¹Ø©') || inst.t.includes('Ù…Ù‚Ø¯Ù…'))) {
                            inst.status = 'paid';
                            fixed++;
                        }
                    });
                });
                if (fixed > 0) {
                    saveData();
                    alert('âœ… ØªÙ… ØªØµØ­ÙŠØ­ ' + fixed + ' Ø¨Ù†Ø¯ Ù…Ù‚Ø¯Ù…/Ø¯ÙØ¹Ø© ÙˆØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙƒÙ€ "Ù…Ø³Ø¯Ø¯" Ø¨Ù†Ø¬Ø§Ø­!');
                    renderDashboard();
                } else {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ØªØ­ØªØ§Ø¬ ØªØµØ­ÙŠØ­.');
                }
            }

            function renderDashboard() {
                appData.currentView = 'dashboard';
                document.getElementById('current-command-text').innerText = "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
                let totalSold = appData.customers.length;
                let totalUnits = appData.regions.reduce((s, r) => s + r.buildings.reduce((ss, b) => ss + b.units.length, 0), 0);
                let totalIncome = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'paid') totalIncome += inst.a; }));

                // ÙØ­Øµ Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø¯Ù…Ø§Øª ØºÙŠØ± Ù…ØµØ­Ø­Ø©
                let needsFix = appData.customers.some(c => c.installments.some(inst =>
                    inst.status === 'pending' && (inst.t === 'Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯' || inst.t === 'Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…' || inst.t.includes('Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©'))
                ));

                let html = `
                    ${needsFix && currentUser === 'admin' ? `
                    <div style="background:#fff3cd; border:1px solid #ff9800; border-radius:10px; padding:12px; margin-bottom:15px; display:flex; align-items:center; justify-content:space-between;">
                        <span style="color:#856404; font-weight:bold;">âš ï¸ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙƒÙ€ Ù…Ø¹Ù„Ù‚Ø© Ø¨ÙŠÙ†Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙÙˆØ¹Ø©. Ø§Ø¶ØºØ· Ù„ØªØµØ­ÙŠØ­Ù‡Ø§.</span>
                        <button onclick="fixOldDownPayments()" style="background:#ff9800; color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold; cursor:pointer; margin-right:10px;">ğŸ”§ ØªØµØ­ÙŠØ­ Ø§Ù„Ø¢Ù†</button>
                    </div>` : ''}
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                        <div class="dashboard-card" onclick="renderRegions()"><div class="value">${appData.regions.length}</div><div class="label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div></div>
                        <div class="dashboard-card" onclick="executeAction('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')"><div class="value">${totalSold}</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</div></div>
                        <div class="dashboard-card" onclick="renderAvailableUnitsByBuilding()"><div class="value">${totalUnits - totalSold}</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div></div>
                        <div class="dashboard-card" onclick="executeAction('Ø§Ù„Ø®Ø²ÙŠÙ†Ø©')"><div class="value">${totalIncome.toLocaleString()}</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div></div>
                    </div>
                    <div style="margin-top:20px; background:white; padding:20px; border-radius:15px; border:1px solid #ddd;">
                        <h3 style="color:var(--sahab-red); margin-top:0;">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>
                                ${appData.customers.slice(-5).reverse().map(c => `<tr><td>${c.qStart}</td><td>ØªØ¹Ø§Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯: ${c.name}</td><td>${c.total.toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderTree() {
                let html = '';
                appData.regions.forEach(r => {
                    html += `
                        <div class="tree-item">
                            <div class="tree-header" onclick="toggleTree(this)">
                                <i class="fas fa-folder"></i> ${r.name}
                            </div>
                            <div class="tree-content">
                                ${r.buildings.map(b => `
                                    <div class="tree-item" style="margin-right:15px;">
                                        <div class="tree-header" onclick="renderUnits(${r.id}, ${b.id})">
                                            <i class="fas fa-building"></i> ${b.name}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('tree-container').innerHTML = html;
            }

            function toggleTree(el) {
                const content = el.nextElementSibling;
                content.classList.toggle('active');
                el.querySelector('i').classList.toggle('fa-folder-open');
            }

            function handleItemClick(el, type, id, rid = null, bid = null) {
                document.querySelectorAll('.card-item, .card-item-row, .unit-box').forEach(x => x.classList.remove('selected'));
                el.classList.add('selected');
                appData.selected = { type, id, rid, bid, ucode: type === 'unit' ? id : null, index: type === 'customer' ? id : null };
            }

            // --- Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„Ø¹Ù…Ø§Ø±Ø§Øª ---
            function renderRegions() {
                appData.currentView = 'regions';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©";
                let html = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    ${appData.regions.map(r => `
                        <div class="card-item" onclick="handleItemClick(this, 'region', ${r.id})" ondblclick="renderBuildings(${r.id})">
                            <div style="font-weight:900; color:var(--sahab-red);">${r.name}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª: ${r.buildings.length}</div>
                        </div>
                    `).join('')}
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildings(rid) {
                appData.currentView = 'buildings';
                appData.selected.rid = rid;
                const reg = appData.regions.find(r => r.id === rid);
                document.getElementById('current-command-text').innerText = "Ø¹Ù…Ø§Ø±Ø§Øª Ù…Ù†Ø·Ù‚Ø©: " + reg.name;
                let html = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    ${reg.buildings.map(b => `
                        <div class="card-item" onclick="handleItemClick(this, 'building', ${b.id}, ${rid})" ondblclick="renderUnits(${rid}, ${b.id})">
                            <div style="font-weight:900; color:var(--sahab-red);">${b.name}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${b.units.length}</div>
                        </div>
                    `).join('')}
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderUnits(rid, bid) {
                appData.currentView = 'units';
                appData.selected.rid = rid;
                appData.selected.bid = bid;
                const b = appData.regions.find(r => r.id === rid).buildings.find(b => b.id === bid);
                document.getElementById('current-command-text').innerText = "ÙˆØ­Ø¯Ø§Øª Ø¹Ù…Ø§Ø±Ø©: " + b.name;

                // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                let groundUnits = b.units.filter(u => u.type === 'Ø£Ø±Ø¶ÙŠ');
                let roofUnits   = b.units.filter(u => u.type === 'Ø±ÙˆÙˆÙ');
                let typicalUnits = b.units.filter(u => u.type !== 'Ø£Ø±Ø¶ÙŠ' && u.type !== 'Ø±ÙˆÙˆÙ');

                // Ø¹Ø±Ø¶ Ù…Ù†Ù…Ù‚ ÙˆÙ…ÙˆØ­Ø¯ Ù„Ù„ÙˆØ­Ø¯Ø§Øª
                let unitsHtml = '';
                
                // Ø±ÙˆÙˆÙ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
                if (roofUnits.length) {
                    unitsHtml += `
                        <div style="margin-bottom:20px;">
                            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:8px 15px; border-radius:10px 10px 0 0; font-weight:bold; font-size:13px; text-align:center;">
                                <i class="fas fa-building" style="margin-left:5px;"></i>Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø±ÙˆÙ
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; padding:15px; background:#f8f9fa; border:2px solid #667eea; border-top:none; border-radius:0 0 10px 10px;">
                                ${roofUnits.map(u => renderUnitBox(u, rid, bid)).join('')}
                            </div>
                        </div>`;
                }
                
                // Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                if (typicalUnits.length) {
                    unitsHtml += `
                        <div style="margin-bottom:20px;">
                            <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:8px 15px; border-radius:10px 10px 0 0; font-weight:bold; font-size:13px; text-align:center;">
                                <i class="fas fa-layer-group" style="margin-left:5px;"></i>Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                            </div>
                            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap:10px; padding:15px; background:#f8f9fa; border:2px solid #f093fb; border-top:none; border-radius:0 0 10px 10px; max-width:600px; margin:0 auto;">
                                ${typicalUnits.map(u => renderUnitBox(u, rid, bid)).join('')}
                            </div>
                        </div>`;
                }
                
                // Ø§Ù„Ø£Ø±Ø¶ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
                if (groundUnits.length) {
                    unitsHtml += `
                        <div style="margin-bottom:20px;">
                            <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:8px 15px; border-radius:10px 10px 0 0; font-weight:bold; font-size:13px; text-align:center;">
                                <i class="fas fa-home" style="margin-left:5px;"></i>Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; padding:15px; background:#f8f9fa; border:2px solid #4facfe; border-top:none; border-radius:0 0 10px 10px;">
                                ${groundUnits.map(u => renderUnitBox(u, rid, bid)).join('')}
                            </div>
                        </div>`;
                }

                // Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
                let legendHtml = `
                    <div style="display:flex; gap:20px; justify-content:center; margin-top:20px; padding:15px; background:white; border-radius:15px; border:2px solid #e0e0e0; font-size:13px; font-weight:bold;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="display:inline-block; width:20px; height:20px; background:var(--sahab-green); border-radius:5px; box-shadow:0 2px 5px rgba(46,204,113,0.3);"></span>
                            <span>Ù…ØªØ§Ø­Ø© Ù„Ù„Ø­Ø¬Ø²</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="display:inline-block; width:20px; height:20px; background:var(--sahab-red); border-radius:5px; box-shadow:0 2px 5px rgba(231,76,60,0.3);"></span>
                            <span>Ù…Ø­Ø¬ÙˆØ²Ø©</span>
                        </div>
                    </div>`;

                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©
                let availableCount = b.units.filter(u => u.status === 'available').length;
                let reservedCount = b.units.filter(u => u.status === 'reserved').length;
                let statsHtml = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
                            <div style="font-size:28px; font-weight:900; margin-bottom:5px;">${b.units.length}</div>
                            <div style="font-size:12px; opacity:0.9;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div style="background:var(--sahab-green); color:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 4px 15px rgba(46,204,113,0.3);">
                                <div style="font-size:24px; font-weight:900; margin-bottom:5px;">${availableCount}</div>
                                <div style="font-size:10px; opacity:0.9;">Ù…ØªØ§Ø­Ø©</div>
                            </div>
                            <div style="background:var(--sahab-red); color:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 4px 15px rgba(231,76,60,0.3);">
                                <div style="font-size:24px; font-weight:900; margin-bottom:5px;">${reservedCount}</div>
                                <div style="font-size:10px; opacity:0.9;">Ù…Ø­Ø¬ÙˆØ²Ø©</div>
                            </div>
                        </div>
                    </div>`;

                let html = `<div style="background:#fff; padding:25px; border-radius:20px; border:1px solid #ddd;">
                    ${statsHtml}
                    ${unitsHtml}
                    ${legendHtml}
                </div>`;
                document.getElementById('main-content').innerHTML = html;
            }

  function renderUnitBox(u, rid, bid) {
  let color = u.status === 'available' ? 'var(--sahab-green)' : 'var(--sahab-red)';
  let region = appData.regions.find(r=>r.id===rid);
  let building = region ? region.buildings.find(b=>b.id===bid) : null;
  let buildingName = building ? building.name : '';
  let customer = appData.customers.find(c => c.unit === u.code && c.building === buildingName);
  let dblClick = u.status === 'available' ? `executeAction('Ø¥Ø¶Ø§ÙØ©')` : `viewCustomerDetail(${appData.customers.indexOf(customer)})`;
  let statusIcon = u.status === 'available' ? '<i class="fas fa-check-circle" style="font-size:10px;"></i>' : '<i class="fas fa-lock" style="font-size:10px;"></i>';
                return `<div class="unit-box" style="background:${color}; box-shadow:0 3px 10px rgba(0,0,0,0.15); transition:all 0.3s ease;" onclick="handleItemClick(this, 'unit', '${u.code}', ${rid}, ${bid})" ondblclick="${dblClick}" onmouseover="this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.25)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.15)';">
                    <div style="font-size:16px; font-weight:900; margin-bottom:3px;">${u.code}</div>
                    <div style="font-size:9px; opacity:0.9; margin-bottom:3px;">${u.type}</div>
                    <div style="font-size:10px; opacity:0.85;">${statusIcon}</div>
                </div>`;
            }

            // --- Ø§Ù„ØªØ¹Ø§Ù‚Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· ---
            function renderInstallmentForm(editIndex = null) {
                if (currentUser !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Admin ÙÙ‚Ø·");
                let editData = editIndex !== null ? appData.customers[editIndex] : null;
                
                // ØªØ­Ø¯ÙŠØ« appData.selected Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                if (editData) {
                    const region = appData.regions.find(r => r.name === editData.region);
                    if (region) {
                        appData.selected.rid = region.id;
                        const building = region.buildings.find(b => b.name === editData.building);
                        if (building) {
                            appData.selected.bid = building.id;
                        }
                    }
                }

                let unitCode = editData ? editData.unit : (appData.selected.ucode || '');
                let buildingName = editData ? editData.building : (appData.selected.bid ? appData.regions.find(r => r.id == appData.selected.rid).buildings.find(b => b.id == appData.selected.bid).name : '');
                let regionName = editData ? editData.region : (appData.selected.rid ? appData.regions.find(r => r.id == appData.selected.rid).name : '');

                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø¹Ø±Ø¶ ÙƒÙ„ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ø±Ø© (Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ù…ØªØ§Ø­Ø©)
                let unitOptions = '';
                if (appData.selected.bid) {
                    const bldForUnits = appData.regions.find(r => r.id == appData.selected.rid).buildings.find(b => b.id == appData.selected.bid);
                    const unitsToShow = editData ? bldForUnits.units : bldForUnits.units.filter(u => u.status === 'available');
                    unitOptions = unitsToShow.map(u => `<option value="${u.code}" ${unitCode === u.code ? 'selected' : ''}>${u.code} (${u.type})</option>`).join('');
                }

                document.getElementById('current-command-text').innerText = editData ? "ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ø§Ù‚Ø¯" : "Ø¬Ø¯ÙˆÙ„Ø© Ø£Ù‚Ø³Ø§Ø·";
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø¯Ø¯ ÙˆÙ…ØªØ¨Ù‚ÙŠ Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                let summaryHtml = '';
                if (editData) {
                    let totalPaid = editData.installments.filter(x => x.status === 'paid').reduce((s,x) => s+x.a, 0);
                    let totalPending = editData.installments.filter(x => x.status === 'pending').reduce((s,x) => s+x.a, 0);
                    let paidCount = editData.installments.filter(x => x.status === 'paid').length;
                    let lateCount = editData.installments.filter(x => x.status === 'pending' && x.d < new Date().toISOString().split('T')[0]).length;
                    let payRate = editData.total > 0 ? ((totalPaid / editData.total) * 100).toFixed(1) : 0;
                    summaryHtml = `
                    <div class="installment-card" style="background:#fafafa;">
                        <span class="field-label" style="font-size:15px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-top:8px;">
                            <div style="background:#e8f5e9; border-radius:8px; padding:10px; text-align:center;">
                                <small style="color:#555;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø¯Ø¯</small><br>
                                <strong style="color:#27ae60; font-size:15px;">${totalPaid.toLocaleString()}</strong>
                            </div>
                            <div style="background:#fff3f3; border-radius:8px; padding:10px; text-align:center;">
                                <small style="color:#555;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><br>
                                <strong style="color:#e74c3c; font-size:15px;">${totalPending.toLocaleString()}</strong>
                            </div>
                            <div style="background:#f0f8ff; border-radius:8px; padding:10px; text-align:center;">
                                <small style="color:#555;">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯</small><br>
                                <strong style="color:#3498db; font-size:15px;">${payRate}%</strong>
                            </div>
                            <div style="background:${lateCount > 0 ? '#fff3cd' : '#f0fff0'}; border-radius:8px; padding:10px; text-align:center;">
                                <small style="color:#555;">Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©</small><br>
                                <strong style="color:${lateCount > 0 ? '#e67e22' : '#27ae60'}; font-size:15px;">${lateCount}</strong>
                            </div>
                        </div>
                    </div>`;
                }

                let html = `
                    ${summaryHtml}
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span><input type="text" id="custName" class="installment-input" value="${editData ? editData.name : ''}"></div>
                            <div><span class="field-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span><input type="text" id="phone" class="installment-input" value="${editData ? editData.phone : ''}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
                                <select id="selRegion" class="installment-input" onchange="updateBuildingSelect(this.value, null, null)">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                                    ${appData.regions.map(r => `<option value="${r.id}" ${regionName === r.name ? 'selected' : ''}>${r.name}</option>`).join('')}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span>
                                <select id="selBuilding" class="installment-input" onchange="updateUnitSelect(this.value, ${editData ? `'${editData.unit}'` : 'null'})">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>
                                    ${appData.selected.rid ? appData.regions.find(r => r.id == appData.selected.rid).buildings.map(b => `<option value="${b.id}" ${buildingName === b.name ? 'selected' : ''}>${b.name}</option>`).join('') : ''}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <select id="selUnit" class="installment-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>
                                    ${unitOptions}
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                            <input type="number" id="totalPrice" class="installment-input" value="${editData ? editData.total : ''}">
                        </div>
                    </div>
                    <div class="installment-card">
                        <span class="field-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</span>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                            <div><small>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</small><input type="number" id="qCount" class="installment-input" value="${editData ? editData.qCount : 28}"></div>
                            <div><small>Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø³Ø·</small>
                                <select id="qFreq" class="installment-input">
                                    <option value="1" ${editData && editData.qFreq == 1 ? 'selected' : ''}>Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="3" ${editData && editData.qFreq == 3 ? 'selected' : ''}>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div><small>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù‚Ø³Ø·</small><input type="date" id="qStart" class="installment-input" value="${editData ? editData.qStart : new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="number" id="downPayment" class="installment-input" value="${editData ? editData.downPayment : ''}"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="date" id="downPaymentDate" class="installment-input" value="${editData ? editData.downPaymentDate : new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                            <div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="number" id="deliveryPayment" class="installment-input" value="${editData ? editData.deliveryPayment : ''}"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="date" id="deliveryPaymentDate" class="installment-input" value="${editData ? editData.deliveryPaymentDate : ''}"></div>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø¯ÙØ¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                            <div id="extra-payments-container">
                                ${editData && editData.extraPayments ? editData.extraPayments.map((ex, i) => `
                                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:5px; margin-bottom:5px;">
                                        <input type="date" class="installment-input ex-date" value="${ex.d}">
                                        <input type="number" class="installment-input ex-amt" value="${ex.a}">
                                        <input type="text" class="installment-input ex-note" value="${ex.t}">
                                        <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <button onclick="addExtraPaymentRow()" style="width:100%; padding:5px; background:#eee; border:1px dashed #ccc; border-radius:5px; cursor:pointer; font-size:12px;">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©/Ù…Ù‚Ø¯Ù…</button>
                        </div>
                        <button onclick="processInstallments(${editIndex})" style="width:100%; padding:12px; background:var(--sahab-red); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</button>
                    </div>
                    ${editData ? `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red); font-size:16px;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            <table class="res-table">
                                <thead style="position: sticky; top: 0; z-index: 10;"><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                                <tbody>
                                    ${editData.installments.map((inst, i) => `
                                        <tr style="${inst.status === 'paid' ? 'background:#e8f5e9;' : ''}">
                                            <td>${i+1}</td><td>${inst.d}</td><td>${inst.a.toLocaleString()}</td><td>${inst.t}</td>
                                            <td style="color:${inst.status === 'paid' ? 'green' : 'red'}">${inst.status === 'paid' ? 'Ù…Ø³Ø¯Ø¯' : 'Ù…Ø¹Ù„Ù‚'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('main-content').innerHTML = html;

                // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ HTML: Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø£Ù† onchange Ù„Ø§ ÙŠÙØ·Ù„Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                if (editData && appData.selected.bid) {
                    setTimeout(() => {
                        const selUnit = document.getElementById('selUnit');
                        if (selUnit) {
                            const bldForUnits = appData.regions.find(r => r.id == appData.selected.rid).buildings.find(b => b.id == appData.selected.bid);
                            selUnit.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>' +
                                bldForUnits.units.map(u =>
                                    `<option value="${u.code}" ${u.code === unitCode ? 'selected' : ''}>${u.code} (${u.type})</option>`
                                ).join('');
                        }
                    }, 50);
                }
            }

            function addExtraPaymentRow() {
                const container = document.getElementById('extra-payments-container');
                const row = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:5px; margin-bottom:5px;">
                        <input type="date" class="installment-input ex-date">
                        <input type="number" class="installment-input ex-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                        <input type="text" class="installment-input ex-note" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ù‚Ø¯Ù…/Ø¯ÙØ¹Ø©)">
                        <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', row);
            }

            function updateBuildingSelect(rid, editBuildingName = null, editUnitCode = null) {
                const reg = appData.regions.find(r => r.id == rid);
                const sel = document.getElementById('selBuilding');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>' + reg.buildings.map(b => `<option value="${b.id}" ${editBuildingName === b.name ? 'selected' : ''}>${b.name}</option>`).join('');
                appData.selected.rid = rid;
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ù…Ø§Ø±Ø© Ù…Ø­Ø¯Ø¯Ø©ØŒ Ù†Ø­Ù…Ù„ ÙˆØ­Ø¯Ø§ØªÙ‡Ø§
                if(editBuildingName) {
                    const bld = reg.buildings.find(b => b.name === editBuildingName);
                    if(bld) updateUnitSelect(bld.id, editUnitCode);
                }
            }

            function updateUnitSelect(bid, editUnit = null) {
                const rid = document.getElementById('selRegion').value;
                const reg = appData.regions.find(r => r.id == rid);
                const bld = reg.buildings.find(b => b.id == bid);
                const sel = document.getElementById('selUnit');
                // Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·ØŒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø¹Ø±Ø¶ ÙƒÙ„Ù‡Ø§
                let filteredUnits = editUnit
                    ? bld.units
                    : bld.units.filter(u => u.status === 'available');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>' +
                    filteredUnits.map(u => `<option value="${u.code}" ${editUnit === u.code ? 'selected' : ''}>${u.code} (${u.type})</option>`).join('');
                appData.selected.bid = bid;
            }

            function processInstallments(editIndex = null) {
                let name = document.getElementById('custName').value;
                let phone = document.getElementById('phone').value;
                let total = parseFloat(document.getElementById('totalPrice').value) || 0;
                let rid = document.getElementById('selRegion').value;
                let bid = document.getElementById('selBuilding').value;
                let ucode = document.getElementById('selUnit').value;

                if(!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
                if(!phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
                if(!rid) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");
                if(!bid) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©");
                if(!ucode) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø©");
                if(!total || total <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©");

                let regionObj = appData.regions.find(r => r.id == rid);
                let buildingObj = regionObj.buildings.find(b => b.id == bid);

                // Ù…Ù†Ø¹ Ø­Ø¬Ø² ÙˆØ­Ø¯Ø© Ù…Ø±ØªÙŠÙ†: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²Ø© Ù„Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±
                let conflictCustomer = appData.customers.find((c, idx) => 
                    c.unit === ucode && c.building === buildingObj.name && idx !== editIndex
                );
                if(conflictCustomer) return alert(`âŒ Ø§Ù„ÙˆØ­Ø¯Ø© ${ucode} Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ø¹Ù…ÙŠÙ„: ${conflictCustomer.name}`);

                let qCount = parseInt(document.getElementById('qCount').value) || 1;
                let qFreq = parseInt(document.getElementById('qFreq').value);
                let qStart = document.getElementById('qStart').value;
                let downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                let downPaymentDate = document.getElementById('downPaymentDate').value;
                let deliveryPayment = parseFloat(document.getElementById('deliveryPayment').value) || 0;
                let deliveryPaymentDate = document.getElementById('deliveryPaymentDate').value;

                let extraPayments = [];
                document.querySelectorAll('#extra-payments-container > div').forEach(div => {
                    let d = div.querySelector('.ex-date').value;
                    let a = parseFloat(div.querySelector('.ex-amt').value) || 0;
                    let t = div.querySelector('.ex-note').value || 'Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©';
                    if(d && a > 0) extraPayments.push({ d, a, t, status: 'pending' });
                });

                if(editIndex !== null && editIndex !== undefined) {
                    // ===== ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© =====
                    let oldCustomer = appData.customers[editIndex];
                    let paidInstallments = oldCustomer.installments.filter(x => x.status === 'paid');
                    let totalPaid = paidInstallments.reduce((s, x) => s + x.a, 0);

                    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ù…Ø³Ø¯Ø¯
                    let newInstallments = [];
                    if (downPayment > 0 && downPaymentDate) {
                        let existing = paidInstallments.find(x => x.t === 'Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯');
                        if(!existing) newInstallments.push({ d: downPaymentDate, a: downPayment, t: "Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯", status: 'pending' });
                    }
                    if (deliveryPayment > 0 && deliveryPaymentDate) {
                        let existing = paidInstallments.find(x => x.t === 'Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…');
                        if(!existing) newInstallments.push({ d: deliveryPaymentDate, a: deliveryPayment, t: "Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…", status: 'pending' });
                    }
                    extraPayments.forEach(p => {
                        let existing = paidInstallments.find(x => x.t === p.t && x.d === p.d);
                        if(!existing) newInstallments.push({ ...p });
                    });

                    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¯ÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
                    let fixedTotal = downPayment + deliveryPayment + extraPayments.reduce((s,p) => s+p.a, 0);
                    let remaining = total - totalPaid - Math.max(0, fixedTotal - paidInstallments.filter(x => x.t !== 'Ù‚Ø³Ø· Ø¯ÙˆØ±ÙŠ').reduce((s,x)=>s+x.a,0));
                    if(remaining < 0) remaining = 0;
                    let instAmt = qCount > 0 ? Math.round((remaining / qCount) * 100) / 100 : 0;

                    for(let i=0; i<qCount; i++) {
                        let d = new Date(qStart);
                        d.setMonth(d.getMonth() + (i * qFreq));
                        newInstallments.push({ d: d.toISOString().split('T')[0], a: instAmt, t: "Ù‚Ø³Ø· Ø¯ÙˆØ±ÙŠ", status: 'pending' });
                    }

                    // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø³Ø¯Ø¯ Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ±ØªÙŠØ¨
                    let allInstallments = [...paidInstallments, ...newInstallments];
                    allInstallments.sort((a, b) => new Date(a.d) - new Date(b.d));

                    // ØªØ­Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ØªØºÙŠØ±Øª
                    if(oldCustomer.unit !== ucode || oldCustomer.building !== buildingObj.name) {
                        appData.regions.forEach(r => r.buildings.forEach(b => {
                            let oldUnit = b.units.find(u => u.code === oldCustomer.unit && b.name === oldCustomer.building);
                            if(oldUnit) oldUnit.status = 'available';
                        }));
                    }

                    appData.customers[editIndex] = {
                        name, phone, total, qCount, qFreq, qStart,
                        downPayment, downPaymentDate, deliveryPayment, deliveryPaymentDate,
                        region: regionObj.name, building: buildingObj.name, unit: ucode,
                        installments: allInstallments, extraPayments
                    };
                } else {
                    // ===== ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =====
                    let installments = [];
                    if (downPayment > 0 && downPaymentDate) installments.push({ d: downPaymentDate, a: downPayment, t: "Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯", status: 'paid' });
                    if (deliveryPayment > 0 && deliveryPaymentDate) installments.push({ d: deliveryPaymentDate, a: deliveryPayment, t: "Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…", status: 'paid' });
                    
                    let extraTotal = extraPayments.reduce((s, p) => s + p.a, 0) + downPayment + deliveryPayment;
                    let remaining = total - extraTotal;
                    let instAmt = Math.round((remaining / qCount) * 100) / 100;

                    extraPayments.forEach(p => installments.push({ ...p, status: 'paid' }));
                    for(let i=0; i<qCount; i++) {
                        let d = new Date(qStart);
                        d.setMonth(d.getMonth() + (i * qFreq));
                        installments.push({ d: d.toISOString().split('T')[0], a: instAmt, t: "Ù‚Ø³Ø· Ø¯ÙˆØ±ÙŠ", status: 'pending' });
                    }

                    installments.sort((a, b) => new Date(a.d) - new Date(b.d));

                    appData.customers.push({ 
                        name, phone, total, qCount, qFreq, qStart, 
                        downPayment, downPaymentDate, deliveryPayment, deliveryPaymentDate,
                        region: regionObj.name, building: buildingObj.name, unit: ucode, 
                        installments, extraPayments 
                    });
                }
                
                buildingObj.units.find(u => u.code === ucode).status = 'sold';
                saveData();
                renderCustomerRegistry();
            }

            function renderCustomerRegistry() {
                appData.currentView = 'registry';
                document.getElementById('current-command-text').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡";
                let html = `
                    <div class="installment-card" style="margin-bottom:10px;">
                        <input type="text" class="installment-input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©..." oninput="filterCustomerRegistry(this.value)">
                    </div>
                    <div id="registry-table-container">
                        ${generateRegistryTable(appData.customers)}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function filterCustomerRegistry(val) {
                let filtered = appData.customers.filter(c => 
                    c.name.includes(val) || 
                    c.phone.includes(val) || 
                    c.unit.includes(val) ||
                    c.building.includes(val)
                );
                document.getElementById('registry-table-container').innerHTML = generateRegistryTable(filtered);
            }

            function generateRegistryTable(data) {
                return `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th></tr></thead>
                    <tbody>
                        ${data.map((c, i) => `
                            <tr class="card-item-row" onclick="handleItemClick(this, 'customer', ${appData.customers.indexOf(c)})" ondblclick="viewCustomerDetail(${appData.customers.indexOf(c)})" style="cursor:pointer;">
                                <td>${c.name}</td><td>${c.phone}</td><td>${c.region}</td><td>${c.building}</td><td>${c.unit}</td><td>${c.total.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            }

            function viewCustomerDetail(index) {
                const c = appData.customers[index];
                document.getElementById('current-command-text').innerText = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: " + c.name;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                let totalPaid = 0;
                let totalPending = 0;
                let today = new Date().toISOString().split('T')[0];
                let lateCount = 0;
                let onTimeCount = 0;
                c.installments.forEach(inst => {
                    if (inst.status === 'paid') { totalPaid += inst.a; onTimeCount++; }
                    else { 
                        totalPending += inst.a;
                        if(inst.d < today) lateCount++;
                    }
                });
                let payRate = c.total > 0 ? ((totalPaid / c.total) * 100).toFixed(1) : 0;
                let commitStatus = lateCount === 0 ? 'âœ… Ù…Ù„ØªØ²Ù…' : `âš ï¸ Ù…ØªØ£Ø®Ø± (${lateCount} Ù‚Ø³Ø·)`;
                let commitColor = lateCount === 0 ? '#27ae60' : '#e74c3c';
                
                let html = `
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ø§Ø³Ù…</span><div class="installment-input">${c.name}</div></div>
                            <div><span class="field-label">Ø§Ù„Ù‡Ø§ØªÙ</span><div class="installment-input">${c.phone}</div></div>
                            <div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span><div class="installment-input">${c.building} / ${c.unit}</div></div>
                            <div><span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</span><div class="installment-input">${c.total.toLocaleString()}</div></div>
                        </div>
                        ${currentUser === 'admin' ? `
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button onclick="renderInstallmentForm(${index})" style="flex:1; padding:10px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>` : ''}
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="dashboard-card" style="border-top-color:var(--sahab-green);"><div class="value">${totalPaid.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯</div></div>
                        <div class="dashboard-card" style="border-top-color:var(--sahab-red);"><div class="value">${totalPending.toLocaleString()}</div><div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>
                        <div class="dashboard-card" style="border-top-color:var(--blue);"><div class="value">${c.installments.length}</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div></div>
                        <div class="dashboard-card" style="border-top-color:#ff9800;"><div class="value" style="font-size:16px;">${payRate}%</div><div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯</div></div>
                        <div class="dashboard-card" style="border-top-color:${commitColor};"><div class="value" style="font-size:13px; color:${commitColor};">${commitStatus}</div><div class="label">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div></div>
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red); font-size:16px;"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                        <table class="res-table">
                            <thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody>
                                ${c.installments.map((inst, i) => `
                                    <tr style="${inst.status === 'paid' ? 'background:#e8f5e9;' : (inst.d < today ? 'background:#fff0f0;' : 'background:#fff3f3;')}">
                                        <td>${i+1}</td><td>${inst.d}</td><td style="font-weight:bold; color:${inst.status === 'paid' ? '#27ae60' : '#e74c3c'}">${inst.a.toLocaleString()}</td><td>${inst.t}</td>
                                        <td style="color:${inst.status === 'paid' ? '#27ae60' : (inst.d < today ? '#e74c3c' : '#e67e22')}; font-weight: bold;">${inst.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : (inst.d < today ? 'ğŸ”´ Ù…ØªØ£Ø®Ø±' : 'â³ Ù…Ø¹Ù„Ù‚')}</td>
                                        <td>
                                            <button onclick="editInstallment(${index}, ${i})" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteInstallment(${index}, ${i})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px; margin-left:5px;"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            // --- Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ù† ---
            function renderCollection() {
                document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·";
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-search" style="margin-left: 8px;"></i>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªØ­ØµÙŠÙ„</h3>
                        <input type="text" class="installment-input" placeholder="ğŸ” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©..." oninput="searchCollection(this.value)">
                    </div>
                    <div id="searchResult" style="margin-top:10px;"></div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function searchCollection(val) {
                if(!val) { document.getElementById('searchResult').innerHTML = ''; return; }
                let filtered = appData.customers.filter(c => c.name.includes(val) || c.phone.includes(val) || c.unit.includes(val));
                
                if(filtered.length === 0) {
                    document.getElementById('searchResult').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ù„Ø§Ø¡</div>';
                    return;
                }
                
                document.getElementById('searchResult').innerHTML = filtered.map(c => {
                    let totalPending = c.installments.filter(x => x.status === 'pending').reduce((sum, x) => sum + x.a, 0);
                    return `
                        <div class="card-item" style="margin-bottom:8px; cursor:pointer; border-left: 5px solid var(--sahab-green);" onclick="renderCollectionForCustomer(${appData.customers.indexOf(c)})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--sahab-red); font-size: 14px;">${c.name}</strong><br>
                                    <small style="color: #666;">ğŸ“ ${c.phone} | ğŸ  ${c.building} / ${c.unit}</small>
                                </div>
                                <div style="text-align: center;">
                                    <small style="color: #999;">Ø§Ù„Ù…Ø³ØªØ­Ù‚</small><br>
                                    <strong style="color: var(--sahab-red); font-size: 14px;">${totalPending.toLocaleString()}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderCollectionForCustomer(index) {
                const c = appData.customers[index];
                document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù…Ù†: " + c.name;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ÙÙ‚Ø·
                let pendingInstallments = c.installments.filter(x => x.status === 'pending');
                let totalPending = pendingInstallments.reduce((sum, x) => sum + x.a, 0);
                let totalPaid = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-user-circle" style="margin-left: 8px;"></i>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„Ø§Ø³Ù…</small><br><strong>${c.name}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„Ù‡Ø§ØªÙ</small><br><strong>${c.phone}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø§Ù„ÙˆØ­Ø¯Ø©</small><br><strong>${c.building} / ${c.unit}</strong>
                            </div>
                            <div style="padding:10px; background:#f5f5f5; border-radius:5px; text-align:center;">
                                <small style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</small><br><strong>${c.total.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="dashboard-card" style="border-top-color:#27ae60;"><div class="value" style="color:#27ae60;">${totalPaid.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯ âœ…</div></div>
                        <div class="dashboard-card" style="border-top-color:#e74c3c;"><div class="value" style="color:#e74c3c;">${totalPending.toLocaleString()}</div><div class="label">Ø§Ù„Ù…Ø³ØªØ­Ù‚ â³</div></div>
                        <div class="dashboard-card" style="border-top-color:#3498db;"><div class="value" style="color:#3498db;">${pendingInstallments.length}</div><div class="label">Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹Ù„Ù‚Ø©</div></div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-coins" style="margin-left: 8px;"></i>ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº Ù…Ø±Ù†</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input type="number" id="collectAmt" class="installment-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº..." min="0" step="0.01"></div>
                            <div><span class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„</span><input type="date" id="collectDate" class="installment-input" value="${new Date().toISOString().split('T')[0]}"></div>
                        </div>
                        <button onclick="processFlexibleCollection(${index})" style="width:100%; padding:12px; background:var(--sahab-green); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; margin-top:10px; font-size:14px;"><i class="fas fa-check-circle" style="margin-left: 8px;"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ÙˆØ§Ù„Ù…Ø³Ø¯Ø¯Ø©</h3>
                        <table class="res-table">
                            <thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody>
                                ${c.installments.map((x, i) => `
                                    <tr style="${x.status === 'paid' ? 'background:#e8f5e9; opacity:0.8;' : 'background:#fff3f3;'}">
                                        <td><strong>${i+1}</strong></td>
                                        <td><strong>${x.d}</strong></td>
                                        <td style="font-weight:bold; color:${x.status === 'paid' ? '#27ae60' : '#e74c3c'}; font-size:12px;">${x.a.toLocaleString()}</td>
                                        <td style="font-size:11px;">${x.t}</td>
                                        <td style="color:${x.status === 'paid' ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${x.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}</td>
                                        <td>
                                            <button onclick="editInstallment(${appData.customers.indexOf(c)}, ${i})" style="background:#ff9800; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:10px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function processFlexibleCollection(custIndex) {
                let amount = parseFloat(document.getElementById('collectAmt').value);
                let collectDate = document.getElementById('collectDate').value;
                if(!amount || amount <= 0) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
                if(!collectDate) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®");

                let c = appData.customers[custIndex];
                let remainingToPay = amount;
                let paidCount = 0;

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                let collectionRecord = {
                    id: Date.now(),
                    customerIndex: custIndex,
                    customerName: c.name,
                    building: c.building,
                    region: c.region,
                    unit: c.unit,
                    amount: amount,
                    date: collectDate,
                    status: 'completed',
                    createdAt: new Date().toISOString()
                };
                
                appData.collections.push(collectionRecord);

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­ØµÙŠÙ„: Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯
                for(let i=0; i<c.installments.length; i++) {
                    if(remainingToPay <= 0) break;
                    if(c.installments[i].status === 'pending') {
                        if(remainingToPay >= c.installments[i].a) {
                            // ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ø· ÙƒØ§Ù…Ù„Ø§Ù‹
                            remainingToPay -= c.installments[i].a;
                            c.installments[i].status = 'paid';
                            c.installments[i].paidDate = collectDate;
                            paidCount++;
                        } else {
                            // Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ: ÙŠÙ†Ù‚Øµ Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯
                            c.installments[i].a = Math.round((c.installments[i].a - remainingToPay) * 100) / 100;
                            c.installments[i].t = c.installments[i].t.replace(' (Ù…ØªØ¨Ù‚ÙŠ)', '') + ' (Ù…ØªØ¨Ù‚ÙŠ)';
                            remainingToPay = 0;
                        }
                    }
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                saveData();
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø¯Ø¯ ÙˆÙ…ØªØ¨Ù‚ÙŠ Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                let totalPaid = c.installments.filter(x => x.status === 'paid').reduce((s,x)=>s+x.a, 0);
                let totalPending = c.installments.filter(x => x.status === 'pending').reduce((s,x)=>s+x.a, 0);

                let message = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n`;
                message += `ğŸ“Š Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
                message += `â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${amount.toLocaleString()}\n`;
                message += `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© ÙƒØ§Ù…Ù„Ø§Ù‹: ${paidCount}\n`;
                message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯: ${totalPaid.toLocaleString()}\n`;
                message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${totalPending.toLocaleString()}\n`;
                message += `â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${collectDate}\n`;
                
                alert(message);
                viewCustomerDetail(custIndex);
            }

            // --- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø®Ø²ÙŠÙ†Ø© ---
            function renderExpenses() {
                appData.currentView = 'expenses';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ";
                let html = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:15px; margin-bottom:20px;">
                        ${appData.regions.flatMap(r => r.buildings.map(b => `
                            <div class="building-icon-card" onclick="renderBuildingExpenses('${b.name}')">
                                <i class="fas fa-building"></i>
                                <span>${b.name}</span>
                            </div>
                        `)).join('')}
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="exAmt" class="installment-input"></div>
                            <div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span>
                                <select id="exBld" class="installment-input">
                                    ${appData.regions.flatMap(r => r.buildings.map(b => `<option value="${b.name}">${b.name}</option>`)).join('')}
                                </select>
                            </div>
                            <div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="exNote" class="installment-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ø³Ø¨Ø§ÙƒØ©..."></div>
                        </div>
                        <button onclick="addExpense()" style="width:100%; padding:10px; background:var(--sahab-red); color:white; border:none; border-radius:10px; margin-top:10px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                    </div>
                    <div id="expenses-list-container">
                        ${generateExpensesTable(appData.expenses)}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingExpenses(bName) {
                let filtered = appData.expenses.filter(e => e.building === bName);
                document.getElementById('current-command-text').innerText = "Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ù…Ø§Ø±Ø©: " + bName;
                document.getElementById('main-content').innerHTML = `
                    <button onclick="renderExpenses()" style="margin-bottom:10px; padding:5px 15px; background:#eee; border:1px solid #ccc; border-radius:5px; cursor:pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙƒØ§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                    ${generateExpensesTable(filtered)}
                `;
            }

            function generateExpensesTable(data) {
                return `
                    <div class="installment-card">
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>
                                ${data.map(e => `<tr><td>${e.date}</td><td>${e.building}</td><td>${e.note}</td><td>${e.amount.toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function addExpense() {
                const amount = parseFloat(document.getElementById('exAmt').value);
                const building = document.getElementById('exBld').value;
                const note = document.getElementById('exNote').value || 'Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù…';
                if(!amount) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
                appData.expenses.push({ date: new Date().toISOString().split('T')[0], amount, building, note });
                saveData();
                renderExpenses();
            }

            function renderTreasury() {
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©";
                let totalIncome = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'paid') totalIncome += inst.a; }));
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ù…Ø±ØªØ¨Ø·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø±ØºØ¨Ø©)
                // ÙˆÙ„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ Ø­Ø¯Ø¯ "Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·"ØŒ Ù„Ø°Ø§ Ø³Ù†ÙƒØªÙÙŠ Ø¨Ù…Ø§ ØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                
                let totalOut = appData.expenses.reduce((s, e) => s + e.amount, 0);
                let balance = totalIncome - totalOut;
                
                let html = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                        <div class="dashboard-card" style="border-top-color:var(--sahab-green); cursor:pointer; transition:0.3s;" onclick="renderTreasuryDetails('income')" ondblclick="renderTreasuryDetails('income')" title="Ø§Ø¶ØºØ· Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                            <div class="value" style="color:var(--sahab-green);">ğŸ“Š ${totalIncome.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:var(--sahab-red); cursor:pointer; transition:0.3s;" onclick="renderExpenses()" title="Ø§Ø¶ØºØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª">
                            <div class="value" style="color:var(--sahab-red);">ğŸ’¸ ${totalOut.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:var(--blue);">
                            <div class="value" style="color:var(--blue);">ğŸ’° ${balance.toLocaleString()}</div>
                            <div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</div>
                        </div>
                    </div>
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-chart-bar" style="margin-left: 8px;"></i>Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                            <div style="background:#f0f8ff; padding:15px; border-radius:10px; border-left:4px solid #3498db;">
                                <small style="color:#666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>
                                <strong style="font-size:18px; color:#3498db;">${appData.customers.length}</strong>
                            </div>
                            <div style="background:#f0fff0; padding:15px; border-radius:10px; border-left:4px solid var(--sahab-green); cursor:pointer; transition:0.2s;" onclick="renderPaidInstallmentsReport()" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ">
                                <small style="color:#666;">Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</small><br>
                                <strong style="font-size:18px; color:var(--sahab-green);">${appData.customers.reduce((sum, c) => sum + c.installments.filter(x => x.status === 'paid').length, 0)}</strong>
                                <div style="font-size:10px; color:#27ae60; margin-top:4px;">ğŸ” Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderPaidInstallmentsReport() {
                document.getElementById('current-command-text').innerText = "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ";
                let paidList = [];
                appData.customers.forEach(function(c, custIdx) {
                    c.installments.forEach(function(inst) {
                        if (inst.status === 'paid') {
                            paidList.push({
                                custIdx: custIdx,
                                custName: c.name,
                                phone: c.phone,
                                region: c.region,
                                building: c.building,
                                unit: c.unit,
                                totalContract: c.total,
                                instAmt: inst.a,
                                instNote: inst.t,
                                paidDate: inst.paidDate || inst.d
                            });
                        }
                    });
                });
                paidList.sort(function(a, b) { return new Date(b.paidDate) - new Date(a.paidDate); });
                let totalPaid = paidList.reduce(function(s, x) { return s + x.instAmt; }, 0);
                let custSummary = {};
                paidList.forEach(function(p) {
                    if (!custSummary[p.custIdx]) custSummary[p.custIdx] = { name: p.custName, phone: p.phone, building: p.building, unit: p.unit, paid: 0, count: 0 };
                    custSummary[p.custIdx].paid += p.instAmt;
                    custSummary[p.custIdx].count++;
                });

                let summaryRows = Object.entries(custSummary).map(function(entry) {
                    let idx = entry[0]; let s = entry[1];
                    return '<tr>' +
                        '<td style="font-weight:bold;color:var(--sahab-red);">' + s.name + '</td>' +
                        '<td>' + s.phone + '</td>' +
                        '<td>' + s.building + ' / <strong>' + s.unit + '</strong></td>' +
                        '<td style="text-align:center;"><strong style="color:#27ae60;">' + s.count + '</strong></td>' +
                        '<td style="font-weight:bold;color:#27ae60;">' + s.paid.toLocaleString() + '</td>' +
                        '<td>' +
                            '<button onclick="viewCustomerDetail(' + idx + ')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;"><i class="fas fa-eye"></i> Ø§Ù„Ø¹Ù‚Ø¯</button> ' +
                            '<button onclick="renderCollectionForCustomer(' + idx + ')" style="background:var(--sahab-green);color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;"><i class="fas fa-coins"></i> ØªØ­ØµÙŠÙ„</button>' +
                        '</td>' +
                    '</tr>';
                }).join('');

                let detailRows = paidList.map(function(p, i) {
                    let bg = i % 2 === 0 ? '#f9f9f9' : '#fff';
                    return '<tr style="background:' + bg + ';" onmouseover="this.style.background=\'#e8f5e9\'" onmouseout="this.style.background=\'' + bg + '\'">' +
                        '<td><strong>' + (i+1) + '</strong></td>' +
                        '<td style="font-weight:bold;color:#27ae60;">' + p.paidDate + '</td>' +
                        '<td style="font-weight:bold;color:var(--sahab-red);">' + p.custName + '</td>' +
                        '<td style="font-size:11px;color:#666;">' + p.phone + '</td>' +
                        '<td style="font-size:11px;">' + p.region + '</td>' +
                        '<td>' + p.building + ' / <strong>' + p.unit + '</strong></td>' +
                        '<td style="font-size:11px;color:#555;">' + p.instNote + '</td>' +
                        '<td style="font-weight:bold;color:#27ae60;font-size:13px;">' + p.instAmt.toLocaleString() + '</td>' +
                        '<td style="color:#666;font-size:11px;">' + p.totalContract.toLocaleString() + '</td>' +
                        '<td><button onclick="viewCustomerDetail(' + p.custIdx + ')" style="background:#3498db;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;"><i class="fas fa-eye"></i> Ø§Ù„Ø¹Ù‚Ø¯</button></td>' +
                    '</tr>';
                }).join('');

                let html = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;">' +
                    '<div class="dashboard-card" style="border-top-color:var(--sahab-green);"><div class="value" style="color:var(--sahab-green);">' + totalPaid.toLocaleString() + '</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:#3498db;"><div class="value" style="color:#3498db;">' + paidList.length + '</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:#ff9800;"><div class="value" style="color:#ff9800;">' + Object.keys(custSummary).length + '</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div></div>' +
                '</div>' +
                '<div class="installment-card" style="margin-bottom:15px;">' +
                    '<h3 style="color:var(--sahab-red);margin-top:0;"><i class="fas fa-users" style="margin-left:8px;"></i>Ù…Ù„Ø®Øµ ØªØ­ØµÙŠÙ„Ø§Øª ÙƒÙ„ Ø¹Ù…ÙŠÙ„</h3>' +
                    '<div style="overflow-x:auto;"><table class="res-table">' +
                    '<thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø© / Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø£Ù‚Ø³Ø§Ø· Ù…Ø³Ø¯Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>' +
                    '<tbody>' + summaryRows + '</tbody></table></div>' +
                '</div>' +
                '<div class="installment-card">' +
                    '<h3 style="color:var(--sahab-red);margin-top:0;"><i class="fas fa-list" style="margin-left:8px;"></i>Ø¬Ø¯ÙˆÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© - Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…</h3>' +
                    '<div style="overflow-x:auto;"><table class="res-table">' +
                    '<thead><tr><th>Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©/Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>' +
                    '<tbody>' + detailRows + '</tbody></table></div>' +
                '</div>';

                document.getElementById('main-content').innerHTML = html;
            }

            function renderAvailableUnitsByBuilding() {
                document.getElementById('current-command-text').innerText = "Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©";
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-door-open" style="margin-left: 8px;"></i>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©</h3>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                        ${appData.regions.flatMap(r => r.buildings.map(b => {
                            let availableUnits = b.units.filter(u => u.status === 'available');
                            if(availableUnits.length === 0) return '';
                            return `
                                <div class="building-icon-card" onclick="renderUnits(${r.id}, ${b.id})">
                                    <i class="fas fa-building" style="color:var(--sahab-green);"></i>
                                    <strong>${b.name}</strong>
                                    <div style="margin-top:5px; font-size:12px; color:#666;">
                                        ${availableUnits.length} ÙˆØ­Ø¯Ø© Ù…ØªØ§Ø­Ø©
                                    </div>
                                    <div style="margin-top:5px; display:flex; flex-wrap:wrap; gap:2px; justify-content:center;">
                                        ${availableUnits.slice(0, 5).map(u => `<span style="font-size:9px; background:#e8f5e9; padding:2px 4px; border-radius:3px;">${u.code}</span>`).join('')}
                                        ${availableUnits.length > 5 ? '...' : ''}
                                    </div>
                                </div>
                            `;
                        })).join('')}
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function renderTreasuryDetails(type) {
                if(type === 'income') {
                    document.getElementById('current-command-text').innerText = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØµÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©";
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©
                    let buildingIncome = {};
                    appData.customers.forEach(c => {
                        const key = `${c.building} (${c.region})`;
                        if(!buildingIncome[key]) buildingIncome[key] = { income: 0, customers: [] };
                        let custIncome = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                        buildingIncome[key].income += custIncome;
                        buildingIncome[key].customers.push(c);
                    });
                    
                    let totalIncome = Object.values(buildingIncome).reduce((sum, b) => sum + b.income, 0);
                    
                    let html = `
                        <div class="installment-card">
                            <h3 style="color:var(--sahab-red);"><i class="fas fa-building" style="margin-left: 8px;"></i>Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ù…Ù† ÙƒÙ„ Ø¹Ù…Ø§Ø±Ø©</h3>
                            <p style="color:#666; font-size:12px; margin:5px 0;">âºï¸ Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† (Double Click) Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ø§Ø±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</p>
                        </div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">
                            ${Object.entries(buildingIncome).map(([building, data]) => {
                                let percentage = (data.income / totalIncome * 100).toFixed(1);
                                return `
                                    <div class="building-icon-card" style="border-bottom: 5px solid var(--sahab-green); cursor:pointer; transition:0.3s;" onclick="renderBuildingCollectionDetails('${building}')" ondblclick="renderBuildingCollectionForm('${building}')">
                                        <i class="fas fa-building" style="font-size: 40px; color: var(--sahab-green); margin-bottom: 10px;"></i>
                                        <strong style="font-size:14px; color:var(--sahab-red);">${building}</strong><br>
                                        <div style="margin-top:8px; font-size:12px; background:#e8f5e9; padding:8px; border-radius:5px; width:100%;">
                                            <strong style="color:var(--sahab-green); font-size:14px;">${data.income.toLocaleString()}</strong><br>
                                            <small style="color:#666;">${percentage}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</small>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    document.getElementById('main-content').innerHTML = html;
                }
            }

            function renderBuildingCollectionDetails(building) {
                document.getElementById('current-command-text').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØµÙˆÙ„: ${building}`;
                
                // Ø¬Ù„Ø¨ Ø¹Ù…Ù„Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø­ØµÙˆÙ„ Ù…Ù†Ù‡Ù…
                let buildingCustomers = appData.customers.filter(c => `${c.building} (${c.region})` === building);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-building" style="margin-left: 8px;"></i>${building}</h3>
                        <p style="color:#666; font-size:12px;">Ø§Ø¶ØºØ· Ù…Ø±ØªÙŠÙ† Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ù†Ù‡</p>
                    </div>
                    <div class="installment-card">
                        <table class="res-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø§Ù„Ù…Ø­ØµÙ„</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingCustomers.map((c, i) => {
                                    let paid = c.installments.filter(x => x.status === 'paid').reduce((sum, x) => sum + x.a, 0);
                                    let pending = c.installments.filter(x => x.status === 'pending').reduce((sum, x) => sum + x.a, 0);
                                    return `
                                        <tr style="cursor:pointer; transition:0.2s;" ondblclick="renderCollectionForCustomer(${appData.customers.indexOf(c)})" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                                            <td style="font-weight:bold;">${c.name}</td>
                                            <td>${c.unit}</td>
                                            <td style="color:var(--sahab-green); font-weight:bold;">${paid.toLocaleString()}</td>
                                            <td style="color:var(--sahab-red); font-weight:bold;">${pending.toLocaleString()}</td>
                                            <td>${c.total.toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingCollectionForm(building) {
                document.getElementById('current-command-text').innerText = `ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…Ø§Ø±Ø©: ${building}`;
                
                let buildingCustomers = appData.customers.filter(c => `${c.building} (${c.region})` === building);
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-cash-register" style="margin-left: 8px;"></i>ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…Ø§Ø±Ø© ${building}</h3>
                        <p style="color:#666; font-size:12px;">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                    </div>
                    <div class="installment-card">
                        <span class="field-label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                        <select id="collectionCustomer" class="installment-input" onchange="loadCustomerForCollection()">
                            <option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>
                            ${buildingCustomers.map((c, i) => 
                                `<option value="${appData.customers.indexOf(c)}">${c.name} - ${c.unit} (${c.phone})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div id="customerCollectionForm"></div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function loadCustomerForCollection() {
                const custIndex = document.getElementById('collectionCustomer').value;
                if(!custIndex) return;
                renderCollectionForCustomer(parseInt(custIndex));
            }

            function editInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const inst = c.installments[instIndex];
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ø·</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                                <div class="installment-input" style="background:#f5f5f5;">${c.name}</div>
                            </div>
                            <div>
                                <span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <div class="installment-input" style="background:#f5f5f5;">${c.building} / ${c.unit}</div>
                            </div>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                            <input type="date" id="editDate" class="installment-input" value="${inst.d}">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span>
                            <input type="number" id="editAmount" class="installment-input" value="${inst.a}" step="0.01" min="0">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span>
                            <input type="text" id="editNote" class="installment-input" value="${inst.t}">
                        </div>
                        <div style="margin-top:10px;">
                            <span class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                            <select id="editStatus" class="installment-input">
                                <option value="paid" ${inst.status === 'paid' ? 'selected' : ''}>âœ… Ù…Ø³Ø¯Ø¯</option>
                                <option value="pending" ${inst.status === 'pending' ? 'selected' : ''}>â³ Ù…Ø¹Ù„Ù‚</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="saveEditInstallment(${custIndex}, ${instIndex})" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="viewCustomerDetail(${custIndex})" style="flex:1; padding:10px; background:#ccc; color:#333; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('current-command-text').innerText = `ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ø· - ${c.name}`;
                document.getElementById('main-content').innerHTML = html;
            }

            function saveEditInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const newDate = document.getElementById('editDate').value;
                const newAmount = parseFloat(document.getElementById('editAmount').value);
                const newNote = document.getElementById('editNote').value;
                const newStatus = document.getElementById('editStatus').value;
                
                if(!newDate || !newAmount || newAmount <= 0) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldStatus = c.installments[instIndex].status;
                const oldAmount = c.installments[instIndex].a;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                c.installments[instIndex] = {
                    d: newDate,
                    a: newAmount,
                    t: newNote,
                    status: newStatus
                };
                
                saveData();
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª:\nâ€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${newDate}\nâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${newAmount.toLocaleString()}\nâ€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${newStatus === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}`);
                viewCustomerDetail(custIndex);
            }

            function deleteInstallment(custIndex, instIndex) {
                const c = appData.customers[custIndex];
                const inst = c.installments[instIndex];
                
                if(!confirm(`âš ï¸ Ù‡Ù„ ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ø·ØŸ\n\nØ§Ù„Ù…Ø¨Ù„Øº: ${inst.a.toLocaleString()}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${inst.d}\nØ§Ù„Ø­Ø§Ù„Ø©: ${inst.status === 'paid' ? 'âœ… Ù…Ø³Ø¯Ø¯' : 'â³ Ù…Ø¹Ù„Ù‚'}`)) {
                    return;
                }
                
                c.installments.splice(instIndex, 1);
                saveData();
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­');
                viewCustomerDetail(custIndex);
            }

            function renderCollectionsManager() {
                appData.currentView = 'collections';
                document.getElementById('current-command-text').innerText = "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª";

                // ===== Ø­Ø³Ø§Ø¨ Ù…Ù„Ø®Øµ ÙƒÙ„ Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø£Ù‚Ø³Ø§Ø·Ù‡ =====
                let totalAllPaid    = 0;
                let totalAllPending = 0;
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if(inst.status === 'paid') totalAllPaid += inst.a;
                        else totalAllPending += inst.a;
                    });
                });
                let totalContracts = appData.customers.reduce((s,c) => s + c.total, 0);

                // ===== Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© =====
                let totalRecorded = appData.collections.reduce((s,c) => s + c.amount, 0);
                let today = new Date().toISOString().split('T')[0];

                let html = `
                    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù… -->
                    <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-bottom:15px;">
                        <div class="dashboard-card" style="border-top-color:var(--sahab-green);">
                            <div class="value" style="color:var(--sahab-green);">${totalAllPaid.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:var(--sahab-red);">
                            <div class="value" style="color:var(--sahab-red);">${totalAllPending.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:#3498db;">
                            <div class="value" style="color:#3498db;">${totalContracts.toLocaleString()}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯</div>
                        </div>
                        <div class="dashboard-card" style="border-top-color:#ff9800;">
                            <div class="value" style="color:#ff9800;">${appData.collections.length}</div>
                            <div class="label">Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</div>
                        </div>
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ -->
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red); margin-top:0;"><i class="fas fa-users" style="margin-left:8px;"></i>Ø¨ÙŠØ§Ù† ØªØ­ØµÙŠÙ„Ø§Øª ÙƒÙ„ Ø¹Ù…ÙŠÙ„</h3>
                        <div style="overflow-x:auto;">
                        <table class="res-table">
                            <thead>
                                <tr>
                                    <th>Ù…</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø© / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th>Ø§Ù„Ù…Ø­ØµÙ„</th>
                                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
                                    <th>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</th>
                                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appData.customers.map((c, idx) => {
                                    let paid    = c.installments.filter(x => x.status === 'paid').reduce((s,x) => s+x.a, 0);
                                    let pending = c.installments.filter(x => x.status === 'pending').reduce((s,x) => s+x.a, 0);
                                    let late    = c.installments.filter(x => x.status === 'pending' && x.d < today).length;
                                    let rate    = c.total > 0 ? ((paid / c.total)*100).toFixed(0) : 0;
                                    let commitColor = late > 0 ? '#e74c3c' : '#27ae60';
                                    let commitLabel = late > 0 ? `âš ï¸ Ù…ØªØ£Ø®Ø± (${late})` : 'âœ… Ù…Ù„ØªØ²Ù…';
                                    return `
                                        <tr style="cursor:pointer;" ondblclick="viewCustomerDetail(${idx})" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background=''">
                                            <td><strong>${idx+1}</strong></td>
                                            <td style="font-weight:bold; color:var(--sahab-red);">${c.name}<br><small style="color:#999; font-weight:normal;">${c.phone}</small></td>
                                            <td>${c.building} / <strong>${c.unit}</strong></td>
                                            <td style="font-weight:bold;">${c.total.toLocaleString()}</td>
                                            <td style="font-weight:bold; color:#27ae60;">${paid.toLocaleString()}</td>
                                            <td style="font-weight:bold; color:#e74c3c;">${pending.toLocaleString()}</td>
                                            <td>
                                                <div style="background:#eee; border-radius:10px; height:8px; width:80px; overflow:hidden; margin:0 auto;">
                                                    <div style="background:${rate>=100?'#27ae60':'#3498db'}; height:100%; width:${Math.min(rate,100)}%;"></div>
                                                </div>
                                                <small>${rate}%</small>
                                            </td>
                                            <td style="color:${commitColor}; font-weight:bold; font-size:12px;">${commitLabel}</td>
                                            <td>
                                                <button onclick="renderCollectionForCustomer(${idx})" style="background:var(--sahab-green); color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:11px; margin-bottom:3px; display:block; width:100%;"><i class="fas fa-coins"></i> ØªØ­ØµÙŠÙ„</button>
                                                <button onclick="viewCustomerDetail(${idx})" style="background:#3498db; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:11px; display:block; width:100%;"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© -->
                    <div class="installment-card" style="margin-top:15px;">
                        <h3 style="color:var(--sahab-red); margin-top:0;"><i class="fas fa-history" style="margin-left:8px;"></i>Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ (${appData.collections.length})</h3>
                        ${appData.collections.length === 0 ?
                            '<div style="text-align:center; color:#999; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­ØµÙŠÙ„ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</div>' :
                            `<div style="overflow-x:auto;"><table class="res-table">
                                <thead>
                                    <tr><th>Ù…</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø© / Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                                </thead>
                                <tbody>
                                    ${[...appData.collections].reverse().map((col, idx) => `
                                        <tr>
                                            <td><strong>${appData.collections.length - idx}</strong></td>
                                            <td style="font-weight:bold;">${col.customerName}</td>
                                            <td>${col.building} / ${col.unit}</td>
                                            <td style="font-weight:bold; color:var(--sahab-green);">${col.amount.toLocaleString()}</td>
                                            <td>${col.date}</td>
                                            <td style="display:flex; gap:5px;">
                                                <button onclick="editCollection(${col.id})" style="background:#ff9800; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                                <button onclick="deleteCollection(${col.id})" style="background:#e74c3c; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table></div>`
                        }
                    </div>
                `;

                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildingCollectionsDetails(building) {
                document.getElementById('current-command-text').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${building}`;
                
                let buildingCollections = appData.collections.filter(c => `${c.building} (${c.region})` === building);
                buildingCollections.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalAmount = buildingCollections.reduce((sum, c) => sum + c.amount, 0);
                
                let html = `
                    <div class="installment-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h3 style="color:var(--sahab-red); margin:0;"><i class="fas fa-building" style="margin-left: 8px;"></i>${building}</h3>
                                <small style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: <strong style="color:var(--sahab-green);">${totalAmount.toLocaleString()}</strong></small>
                            </div>
                            <button onclick="renderCollectionsManager()" style="padding:8px 15px; background:#ddd; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Ø±Ø¬ÙˆØ¹</button>
                        </div>
                    </div>
                    
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h3>
                        <table class="res-table">
                            <thead>
                                <tr>
                                    <th>Ù…</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingCollections.map((col, idx) => `
                                    <tr style="background:#f9f9f9;">
                                        <td><strong>${idx+1}</strong></td>
                                        <td style="font-weight:bold; color:var(--sahab-red);">${col.customerName}</td>
                                        <td>${col.unit}</td>
                                        <td style="font-weight:bold; color:var(--sahab-green); font-size:13px;">${col.amount.toLocaleString()}</td>
                                        <td>${col.date}</td>
                                        <td style="display:flex; gap:5px;">
                                            <button onclick="editCollection(${col.id})" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteCollection(${col.id})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px;"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            }

            function editCollection(collectionId) {
                let collection = appData.collections.find(c => c.id === collectionId);
                if(!collection) return alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„');
                
                let html = `
                    <div class="installment-card">
                        <h3 style="color:var(--sahab-red);"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„</h3>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                                <div class="installment-input" style="background:#f5f5f5;">${collection.customerName}</div>
                            </div>
                            <div>
                                <span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <div class="installment-input" style="background:#f5f5f5;">${collection.building} / ${collection.unit}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
                            <input type="number" id="editColAmount" class="installment-input" value="${collection.amount}" step="0.01" min="0">
                        </div>
                        
                        <div style="margin-top:10px;">
                            <span class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„</span>
                            <input type="date" id="editColDate" class="installment-input" value="${collection.date}">
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="saveEditCollection(${collectionId})" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="renderCollectionsManager()" style="flex:1; padding:10px; background:#ccc; color:#333; border:none; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('current-command-text').innerText = `ØªØ¹Ø¯ÙŠÙ„ ØªØ­ØµÙŠÙ„ - ${collection.customerName}`;
                document.getElementById('main-content').innerHTML = html;
            }

            function saveEditCollection(collectionId) {
                let newAmount = parseFloat(document.getElementById('editColAmount').value);
                let newDate = document.getElementById('editColDate').value;
                
                if(!newAmount || newAmount <= 0) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                }
                if(!newDate) {
                    return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®');
                }
                
                let collection = appData.collections.find(c => c.id === collectionId);
                let oldAmount = collection.amount;
                
                collection.amount = newAmount;
                collection.date = newDate;
                
                saveData();
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„ØªØºÙŠÙŠØ±Ø§Øª:\nâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${oldAmount.toLocaleString()} â†’ ${newAmount.toLocaleString()}\nâ€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${newDate}`);
                renderCollectionsManager();
            }

            function deleteCollection(collectionId) {
                let collection = appData.collections.find(c => c.id === collectionId);
                if(!collection) return alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„');
                
                if(!confirm(`âš ï¸ Ù‡Ù„ ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ\n\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${collection.customerName}\nØ§Ù„Ù…Ø¨Ù„Øº: ${collection.amount.toLocaleString()}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${collection.date}`)) {
                    return;
                }
                
                appData.collections = appData.collections.filter(c => c.id !== collectionId);
                saveData();
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                renderCollectionsManager();
            }

            // --- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ---
            function renderExternalExpenses() {
                appData.currentView = 'external';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©)";
                let html = `
                    <div class="installment-card">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <div><span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input type="date" id="ext-date" class="installment-input" value="${new Date().toISOString().split('T')[0]}"></div>
                            <div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="ext-desc" class="installment-input"></div>
                            <div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="ext-amount" class="installment-input"></div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="addExternalRow()" style="flex:2; padding:10px; background:var(--sahab-red); color:white; border:none; border-radius:10px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                            <button onclick="exportExternalToExcel()" style="flex:1; padding:10px; background:var(--sahab-green); color:white; border:none; border-radius:10px; cursor:pointer;"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„</button>
                        </div>
                    </div>
                    <div class="installment-card">
                        <table class="res-table">
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="ext-table-body">
                                ${appData.externalExpenses.map((ex, i) => `
                                    <tr>
                                        <td>${ex.d}</td><td>${ex.t}</td><td>${ex.a.toLocaleString()}</td>
                                        <td><button onclick="deleteExternalExpense(${i})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = html;
            }

            function addExternalRow() {
                const d = document.getElementById('ext-date').value;
                const t = document.getElementById('ext-desc').value;
                const a = parseFloat(document.getElementById('ext-amount').value);
                if(d && t && a) {
                    appData.externalExpenses.unshift({ d, t, a });
                    saveData();
                    renderExternalExpenses();
                } else {
                    alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                }
            }

            function deleteExternalExpense(index) {
                if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) {
                    appData.externalExpenses.splice(index, 1);
                    saveData();
                    renderExternalExpenses();
                }
            }

            async function exportExternalToExcel() {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©');
                worksheet.columns = [
                    { header: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', key: 'd', width: 15 },
                    { header: 'Ø§Ù„Ø¨ÙŠØ§Ù†', key: 't', width: 30 },
                    { header: 'Ø§Ù„Ù…Ø¨Ù„Øº', key: 'a', width: 15 }
                ];
                appData.externalExpenses.forEach(ex => worksheet.addRow(ex));
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `Ù…ØµØ±ÙˆÙØ§Øª_Ø®Ø§Ø±Ø¬ÙŠØ©_${new Date().getMonth()+1}_${new Date().getFullYear()}.xlsx`);
            }

            // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ---
            function executeAction(name) {
                if (currentUser !== 'admin' && ['Ø¥Ø¶Ø§ÙØ©', 'ØªØ¹Ø¯ÙŠÙ„', 'Ø­Ø°Ù', 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·', 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„', 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©', 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ø§Ø±Ø©'].includes(name)) {
                    return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·)");
                }
                if (name === 'Ø¥Ø¶Ø§ÙØ©') {
                    if (appData.currentView === 'regions') addRegion();
                    else if (appData.currentView === 'buildings') addBuilding();
                    else renderInstallmentForm();
                } else if (name === 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„') {
                    renderInstallmentForm();
                } else if (name === 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡') {
                    renderCustomerRegistry();
                } else if (name === 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ') {
                    renderExpenses();
                } else if (name === 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·') {
                    renderCollection();
                } else if (name === 'ØªØ¹Ø¯ÙŠÙ„') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') renderInstallmentForm(appData.selected.index);
                    else if (appData.selected.type === 'region') editRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') editBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø­Ø°Ù') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') deleteCustomer(appData.selected.index);
                    else if (appData.selected.type === 'region') deleteRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') deleteBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„Ù‰') {
                    renderInstallmentReport('month');
                } else if (name === 'Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©') {
                    renderInstallmentReport('late');
                } else if (name === 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©') {
                    renderTreasury();
                }
            }

            function addRegion() {
                let name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if(name) { appData.regions.push({ id: Date.now(), name, buildings: [] }); saveData(); renderRegions(); }
            }

            function addBuilding() {
                let rid = appData.selected.rid;
                if(!rid && appData.regions.length > 0) {
                    let choice = prompt("Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:\n" + appData.regions.map((r, i) => `${i+1}- ${r.name}`).join('\n'));
                    if(choice && appData.regions[choice-1]) rid = appData.regions[choice-1].id;
                }
                if(!rid) return alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹");
                let name = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if(!name) return;

                const reg = appData.regions.find(r => r.id === rid);

                let allBuildings = appData.regions.flatMap(r => r.buildings);
                let units;

                if(allBuildings.length > 0) {
                    let copyChoice = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø¹Ù…Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ\nØ§Ø®ØªØ± (Ù…ÙˆØ§ÙÙ‚) Ù„Ù„Ù†Ø³Ø®ØŒ Ø£Ùˆ (Ø¥Ù„ØºØ§Ø¡) Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙŠØ¯.");
                    if(copyChoice) {
                        let buildingList = allBuildings.map((b, i) => `${i+1}- ${b.name} (${b.units.length} ÙˆØ­Ø¯Ø©)`).join('\n');
                        let bChoice = prompt("Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ù„Ù„Ù†Ø³Ø® Ù…Ù†Ù‡Ø§:\n" + buildingList);
                        let srcBuilding = allBuildings[parseInt(bChoice)-1];
                        if(srcBuilding) {
                            units = srcBuilding.units.map(u => ({ code: u.code, type: u.type, status: 'available' }));
                        } else {
                            alert("Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙŠØ¯.");
                        }
                    }
                }

                if(!units) {
                    let gCount = parseInt(prompt("Ø¹Ø¯Ø¯ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ø¶ÙŠ:\n(Ø§ÙƒØªØ¨ 0 Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø±Ø¶ÙŠ)", "2")) || 0;
                    let floors  = parseInt(prompt("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©:", "4")) || 0;
                    let unitsPerFloor = parseInt(prompt("Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ±:", "2")) || 0;
                    let rCount  = parseInt(prompt("Ø¹Ø¯Ø¯ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±ÙˆÙˆÙ:\n(Ø§ÙƒØªØ¨ 0 Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±ÙˆÙˆÙ)", "2")) || 0;

                    let gPrefix = gCount > 0 ? (prompt("Ø¨Ø§Ø¯Ø¦Ø© ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ø¶ÙŠ (Ù…Ø«Ø§Ù„: G Ø£Ùˆ B Ø£Ùˆ A):", "G") || "G") : "";
                    let rPrefix = rCount > 0 ? (prompt("Ø¨Ø§Ø¯Ø¦Ø© ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±ÙˆÙˆÙ (Ù…Ø«Ø§Ù„: R Ø£Ùˆ RH):", "R") || "R") : "";

                    units = [];
                    // Ø£Ø±Ø¶ÙŠ: G1, G2, ...
                    for(let i=1; i<=gCount; i++) units.push({ code: `${gPrefix}${i}`, type: 'Ø£Ø±Ø¶ÙŠ', status: 'available' });
                    // Ù…ØªÙƒØ±Ø±: ØªØ±Ù‚ÙŠÙ… ØªØ³Ù„Ø³Ù„ÙŠ Ù…Ø³ØªÙ…Ø± 1, 2, 3, 4, ...
                    let unitCounter = 1;
                    for(let f=1; f<=floors; f++) {
                        for(let u=1; u<=unitsPerFloor; u++) {
                            units.push({ code: `${unitCounter}`, type: `Ù…ØªÙƒØ±Ø± - Ø¯ÙˆØ± ${f}`, status: 'available' });
                            unitCounter++;
                        }
                    }
                    // Ø±ÙˆÙˆÙ: R1, R2, ...
                    for(let i=1; i<=rCount; i++) units.push({ code: `${rPrefix}${i}`, type: 'Ø±ÙˆÙˆÙ', status: 'available' });

                    if(units.length === 0) return alert("Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ ÙˆØ­Ø¯Ø§Øª. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.");
                }

                reg.buildings.push({ id: Date.now(), name, units });
                saveData();
                renderBuildings(rid);
            }

            function editRegion(id) {
                let reg = appData.regions.find(r => r.id === id);
                let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:", reg.name);
                if (newName) { reg.name = newName; saveData(); renderRegions(); }
            }

            function editBuilding(rid, bid) {
                let reg = appData.regions.find(r => r.id === rid);
                let bld = reg.buildings.find(b => b.id === bid);
                let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©:", bld.name);
                if (newName) { bld.name = newName; saveData(); renderBuildings(rid); }
            }

            function deleteRegion(id) {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { appData.regions = appData.regions.filter(r => r.id !== id); saveData(); renderRegions(); }
            }

            function deleteBuilding(rid, bid) {
                if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©ØŸ")) {
                    let reg = appData.regions.find(r => r.id === rid);
                    reg.buildings = reg.buildings.filter(b => b.id !== bid);
                    saveData();
                    renderBuildings(rid);
                }
            }

            function deleteCustomer(index) {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    const c = appData.customers[index];
                    appData.regions.forEach(r => r.buildings.forEach(b => {
                        let u = b.units.find(u => u.code === c.unit && b.name === c.building);
                        if(u) u.status = 'available';
                    }));
                    appData.customers.splice(index, 1);
                    saveData();
                    renderCustomerRegistry();
                }
            }

            function renderInstallmentReport(type) {
                const today = new Date();
                document.getElementById('current-command-text').innerText = type === 'month' ? "Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ" : "Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©";
                let list = [];
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if(inst.status === 'pending') {
                            const d = new Date(inst.d);
                            if(type === 'month' && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear()) list.push({ ...inst, cust: c.name, unit: c.unit });
                            if(type === 'late' && d < today) list.push({ ...inst, cust: c.name, unit: c.unit });
                        }
                    });
                });
                let html = `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody>
                        ${list.map(x => `<tr><td>${x.cust}</td><td>${x.unit}</td><td>${x.d}</td><td>${x.a.toLocaleString()}</td></tr>`).join('')}
                    </tbody>
                </table>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function checkNotifications() {
                let today = new Date().toISOString().split('T')[0];
                let count = 0;
                appData.customers.forEach(c => c.installments.forEach(inst => { if(inst.status === 'pending' && inst.d <= today) count++; }));
                const badge = document.getElementById('notif-count');
                if(badge) { badge.innerText = count; badge.style.display = count > 0 ? 'block' : 'none'; }
            }

            function showNotifications() {
                let today = new Date().toISOString().split('T')[0];
                let notifications = [];
                appData.customers.forEach(c => {
                    c.installments.forEach(inst => {
                        if(inst.status === 'pending' && inst.d <= today) {
                            notifications.push({ cust: c.name, unit: c.unit, date: inst.d, amount: inst.a });
                        }
                    });
                });
                
                if(notifications.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù…Ø³ØªØ­Ù‚Ø©');
                    return;
                }
                
                document.getElementById('current-command-text').innerText = 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©';
                let html = `<table class="res-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody>
                        ${notifications.map(n => `<tr><td>${n.cust}</td><td>${n.unit}</td><td>${n.date}</td><td>${n.amount.toLocaleString()}</td></tr>`).join('')}
                    </tbody>
                </table>`;
                document.getElementById('main-content').innerHTML = html;
            }

            function goBack() {
                if(appData.currentView === 'units') renderBuildings(appData.selected.rid);
                else if(appData.currentView === 'buildings') renderRegions();
                else renderDashboard();
            }

            function updateClock() {
                const now = new Date();
                const clockEl = document.getElementById('clock');
                const dateEl = document.getElementById('date');
                if(clockEl) clockEl.innerText = now.toLocaleTimeString('ar-EG');
                if(dateEl) dateEl.innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            setInterval(updateClock, 1000);
            updateClock();

            function exportBackup() {
                // ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù…Ù„Ù JSON
  const dataToExport = {
  timestamp: new Date().toISOString(),
  regions: appData.regions,
  customers: appData.customers,
  expenses: appData.expenses,
  externalExpenses: appData.externalExpenses,
  collections: appData.collections || []
  };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'sahab_backup_' + new Date().toISOString().split('T')[0] + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            }

            function saveDataToFile() {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù HTML Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
                alert('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø¢Ø®Ø± Ø­Ø§Ù„Ø©
                let finalEmbeddedData = {
                    regions: appData.regions,
                    customers: appData.customers,
                    expenses: appData.expenses,
                    externalExpenses: appData.externalExpenses,
                    collections: appData.collections,
                    lastUpdate: new Date().toISOString()
                };
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
                fetch(window.location.href)
                    .then(response => response.text())
                    .then(htmlContent => {
                        // ØªØ­Ø¯ÙŠØ« embeddedDataJson ÙÙŠ Ø§Ù„Ù…Ù„Ù
                        const escapedData = JSON.stringify(finalEmbeddedData, null, 2)
                            .replace(/`/g, '\\`')
                            .replace(/\$/g, '\\$');
                        
                        let updatedHtml = htmlContent.replace(
                            /let embeddedDataJson = `[\s\S]*?`;/,
                            `let embeddedDataJson = \`${escapedData}\`;`
                        );
                        
                        // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«
                        const blob = new Blob([updatedHtml], { type: 'text/html;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `sahab_data_${new Date().toISOString().split('T')[0]}.html`;
                        link.click();
                        
                        alert(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø©:\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª: ${appData.regions.length}\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${appData.customers.length}\nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${appData.collections.length}\n\nğŸ“¤ Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„\n\nğŸ’¡ Ø§Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø£ÙŠ Ø¬Ù‡Ø§Ø² ÙˆÙØªØ­Ù‡ = Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©!`);
                    })
                    .catch(err => {
                        console.error(err);
                        // Ø¨Ø¯ÙŠÙ„: ØªØµØ¯ÙŠØ± ÙƒÙ€ JSON Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                        const dataToExport = finalEmbeddedData;
                        const dataStr = JSON.stringify(dataToExport, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', `sahab_data_${new Date().toISOString().split('T')[0]}.json`);
                        linkElement.click();
                        alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON\n\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø­Ù‚Ø§Ù‹');
                    });
            }

            function handleImport(event) {
                // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù
                        if (imported.regions !== undefined && imported.customers !== undefined) {
  appData.regions = imported.regions || [];
  appData.customers = imported.customers || [];
  appData.expenses = imported.expenses || [];
  appData.externalExpenses = imported.externalExpenses || [];
  appData.collections = imported.collections || [];
                            
  saveData();
  renderDashboard();
  alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");
                            // Ø­Ø°ÙÙ†Ø§ Ø³Ø·Ø± location.reload() Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ·Ø±Ø¯Ùƒ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        } else {
                            alert("âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯");
                        }
                    } catch (err) { 
                        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message); 
                    }
                };
                reader.readAsText(file);}
                
            // 
            function showAutoSaveStatus() {
                // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const lastSaveTime = new Date().toLocaleString('ar-EG');
                const statsHtml = `
                    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.2); max-width:500px; z-index:10000; border:3px solid #27ae60;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="font-size:48px; color:#27ae60; margin-bottom:10px;">âœ…</div>
                            <strong style="font-size:18px; color:#27ae60;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</strong>
                        </div>
                        
                        <div style="background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:20px;">
                            <strong style="color:#1b5e20; display:block; margin-bottom:10px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:13px;">
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #27ae60;">
                                    <small style="color:#666;">ğŸ¢ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</small><br>
                                    <strong style="color:#27ae60; font-size:16px;">${appData.regions.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #27ae60;">
                                    <small style="color:#666;">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small><br>
                                    <strong style="color:#27ae60; font-size:16px;">${appData.customers.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #ff9800;">
                                    <small style="color:#666;">ğŸ’° Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</small><br>
                                    <strong style="color:#ff9800; font-size:16px;">${appData.collections.length}</strong>
                                </div>
                                <div style="background:white; padding:10px; border-radius:5px; border-left:3px solid #2196F3;">
                                    <small style="color:#666;">ğŸ’³ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©</small><br>
                                    <strong style="color:#2196F3; font-size:16px;">${appData.customers.reduce((sum, c) => sum + (c.installments ? c.installments.length : 0), 0)}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:10px; margin-bottom:20px; border-left:4px solid #ff9800;">
                            <strong style="color:#e65100;">â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong>
                            <div style="color:#666; margin-top:5px; font-size:12px;">${lastSaveTime}</div>
                        </div>
                        
                        <div style="background:#e3f2fd; padding:12px; border-radius:10px; margin-bottom:20px;">
                            <strong style="color:#1976d2; display:block; margin-bottom:8px;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong>
                            <small style="color:#666; line-height:1.6;">
                                âœ“ ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ<br>
                                âœ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„<br>
                                âœ“ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­Ù„ÙŠ<br>
                                âœ“ Ø§Ø³ØªØ®Ø¯Ù… "Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©" Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
                            </small>
                        </div>
                        
                        <button onclick="document.querySelector('[style*=\"position:fixed\"]').remove()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">Ø£ØºÙ„Ù‚ âœ“</button>
                    </div>
                `;
                // Ø¥Ù†Ø´Ø§Ø¡ overlay Ø´ÙØ§Ù
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;';
                overlay.onclick = () => overlay.remove();
                document.body.appendChild(overlay);
                
                const popup = document.createElement('div');
                popup.innerHTML = statsHtml;
                document.body.appendChild(popup.firstElementChild);
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ overlay
                overlay.addEventListener('click', () => {
                    overlay.remove();
                    document.querySelector('[style*="position:fixed"][style*="top:50%"]')?.remove();
                });
            }


                // ===== Ù‚Ø³Ù… Admin ÙÙ‚Ø· =====
                let adminHtml = '';
                if (currentUser === 'admin') {
                    adminHtml =
                        '<div class="installment-card">' +
                            '<h3 style="color:var(--sahab-red);">âš™ï¸ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</h3>' +
                            '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">' +
                                '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± Admin</span><input type="password" id="new-admin-pass" class="installment-input" value="' + passwords.admin + '"></div>' +
                                '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± User</span><input type="password" id="new-viewer-pass" class="installment-input" value="' + passwords.viewer + '"></div>' +
                            '</div>' +
                            '<button onclick="updatePasswords()" style="width:100%;padding:12px;background:var(--sahab-green);color:white;border:none;border-radius:10px;font-weight:900;cursor:pointer;margin-top:20px;"><i class="fas fa-check" style="margin-left:8px;"></i>Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</button>' +
                        '</div>' +
                        '<div class="installment-card">' +
                            '<h3 style="color:var(--sahab-red);">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>' +
                            '<div style="display:flex;flex-direction:column;gap:10px;">' +
                                '<button onclick="exportBackup()" style="width:100%;padding:12px;background:#9b59b6;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">ğŸ“¥ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>' +
                                '<button onclick="document.getElementById(\'settingsImportFile\').click()" style="width:100%;padding:12px;background:#e67e22;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>' +
                                '<input type="file" id="settingsImportFile" style="display:none" accept=".json" onchange="handleImport(event)">' +
                            '</div>' +
                        '</div>';
                }

                document.getElementById('main-content').innerHTML = sharedHtml + adminHtml;
            
                
            function updateStats() {
                const totalBuildings = appData.regions.reduce((sum, region) => sum + region.buildings.length, 0);
                const elRegions = document.getElementById('stat-regions');
                if (elRegions) elRegions.innerText = totalBuildings;
                
                const elCustomers = document.getElementById('stat-customers');
                if (elCustomers) elCustomers.innerText = appData.customers.length;
                
                const elCollections = document.getElementById('stat-collections');
                if (elCollections) elCollections.innerText = appData.collections.length;
                
                const elLastUpdate = document.getElementById('stat-lastupdate');
                if (elLastUpdate) elLastUpdate.innerText = new Date().toLocaleTimeString('ar-EG');
            }
            function updatePasswords() {
                const adminP = document.getElementById('new-admin-pass').value;
                const viewerP = document.getElementById('new-viewer-pass').value;
                if (!adminP || !viewerP) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±");
                passwords.admin = adminP; 
                passwords.viewer = viewerP;
                localStorage.setItem('sahab_passwords', JSON.stringify(passwords));
                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­');
            }

  window.onload = () => {
  checkNotifications();
  };
        </script>
    </body>
    </html>
