<!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>Ø´Ø±ÙƒØ© Ø³Ø­Ø§Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ù‰ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© v2</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <style>
            :root { --sahab-red: #8b1a1a; --border: #e2e8f0; --sahab-green: #2ecc71; --gold: #ffd700; --blue: #3498db; }
            * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
            
            body { 
                margin: 0; padding: 10px; background: #f4f7f6; 
                height: 100vh; width: 100vw; overflow: hidden;
                display: grid;
                grid-template-columns: 1fr 380px;
                grid-template-rows: 1fr 100px;
                gap: 10px;
                direction: ltr;
            }

            #login-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #f4f7f6; z-index: 9999; display: flex; align-items: center; justify-content: center;
                direction: rtl;
            }
            .login-box {
                background: white; padding: 40px; border-radius: 25px; border-top: 10px solid var(--sahab-red);
                box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 400px; text-align: center;
            }
            .login-input {
                width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px;
                font-size: 16px; text-align: center; outline: none;
            }
            .login-btn {
                width: 100%; padding: 12px; background: var(--sahab-red); color: white; border: none;
                border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px;
            }

            #sector-1 {
                grid-column: 1; grid-row: 1;
                background: #fff; border-radius: 20px; border: 1px solid #ddd;
                display: flex; flex-direction: column; overflow: hidden;
                direction: rtl;
            }

            #sector-2 {
                grid-column: 2; grid-row: 1;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--sahab-red);
                padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
                direction: rtl;
            }

            #sector-3 {
                grid-column: 2; grid-row: 2;
                background: #fff; border-radius: 20px; border-right: 12px solid var(--gold);
                padding: 10px; display: flex; flex-direction: column; gap: 5px;
                direction: rtl;
            }

            #sector-4 {
                grid-column: 1; grid-row: 2;
                background: #fff; border-radius: 20px; border-bottom: 8px solid var(--sahab-red);
                display: flex; align-items: center; justify-content: space-evenly; padding: 0 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                direction: rtl;
            }

            .cmd-btn { 
                width: 100%; padding: 14px; margin-bottom: 10px; 
                border: 2px solid var(--border); border-right: 8px solid var(--sahab-red); 
                border-radius: 12px; background: white; text-align: right; 
                cursor: pointer; font-weight: 900; font-size: 14px;
                display: flex; align-items: center; justify-content: flex-end;
            }
            .action-btn-main {
                flex: 1; margin: 0 5px; height: 50px; font-weight: 900; 
                cursor: pointer; background: white; border: 1px solid #ddd; 
                border-radius: 10px; transition: 0.2s;
                display: flex; align-items: center; justify-content: center; font-size: 13px;
            }
            .action-btn-main:hover:not(:disabled) { background: #f9f9f9; border-color: var(--sahab-red); }
            .action-btn-main:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
            
            .cmd-btn i, .action-btn-main i { transition: all 0.3s ease; }
            .cmd-btn:hover i { color: var(--sahab-red); transform: scale(1.2); }
            .action-btn-main:hover:not(:disabled) i { color: var(--sahab-red); transform: scale(1.15); }
            
            #sector-3 button:hover { background: #f5f5f5 !important; border-color: var(--sahab-red) !important; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(139, 26, 26, 0.15); }
            #sector-3 button:hover i { color: #c71616; transform: scale(1.3); }

            .installment-card { background: white; border-radius: 15px; padding: 15px; border: 1px solid var(--border); margin-bottom: 10px; }
            .field-label { color: var(--sahab-red); margin-bottom: 3px; display: block; font-size: 13px; font-weight: 900; }
            .installment-input { width: 100%; padding: 8px; border: 1px solid var(--sahab-red); border-radius: 8px; font-weight: 900; text-align: center; font-size: 14px; }
            .res-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
            .res-table th { background: var(--sahab-red); color: white; padding: 8px; border: 1px solid #ddd; font-size: 12px; }
            .res-table td { padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; }

            .card-item { 
                background: #fff; border: 2px solid #eee; border-right: 10px solid var(--sahab-red); 
                padding: 15px; border-radius: 15px; cursor: pointer; transition: 0.2s; 
            }
            .card-item.selected { border-color: var(--gold); background: #fffdf0; }
            
            /* âœ… Ø¥ØµÙ„Ø§Ø­: ØªØ£ÙƒÙŠØ¯ Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¨Ø­Ø« */
            .search-result-card {
                cursor: pointer !important;
                transition: all 0.2s ease;
            }
            .search-result-card:hover {
                background: #f0fff0 !important;
                border-color: var(--sahab-green) !important;
                transform: translateX(-3px);
                box-shadow: 0 3px 10px rgba(46, 204, 113, 0.2);
            }
            .search-result-card * {
                pointer-events: none;
            }

            .unit-box {
                width: 80px; height: 80px; color: white; border-radius: 12px; 
                cursor: pointer; display: flex; flex-direction: column; 
                align-items: center; justify-content: center; font-weight: bold;
            }
            .unit-box.selected { border: 3px solid var(--gold); transform: scale(1.05); }

            .dashboard-card {
                background: #fff; border: 1px solid #ddd; border-radius: 15px; padding: 15px; text-align: center;
                border-top: 5px solid var(--sahab-red); cursor: pointer; transition: 0.3s;
            }
            .dashboard-card .value { font-size: 20px; font-weight: 900; color: var(--sahab-red); }
            .dashboard-card .label { font-size: 11px; font-weight: bold; color: #666; margin-top: 5px; }

            .tree-item { margin-right: 20px; border-right: 2px solid #eee; padding-right: 10px; margin-top: 5px; }
            .tree-header { cursor: pointer; font-weight: bold; color: var(--sahab-red); display: flex; align-items: center; gap: 5px; }
            .tree-content { display: none; margin-top: 5px; }
            .tree-content.active { display: block; }

            @media print { .no-print { display: none !important; } body { display: block; } }
            .card-item-row.selected { background: #fff5f5 !important; border-right: 4px solid var(--sahab-red); }
            
            .building-icon-card {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                padding: 20px; background: white; border: 2px solid #eee; border-radius: 15px;
                cursor: pointer; transition: 0.3s; border-bottom: 5px solid var(--sahab-red);
            }
            .building-icon-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            .building-icon-card i { font-size: 40px; color: var(--sahab-red); margin-bottom: 10px; }
            .building-icon-card span { font-weight: bold; font-size: 16px; }
            
            .cmd-btn:hover { background: #f0f0f0; border-right-color: var(--sahab-red); }
            
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        </style>
    </head>
    <body>

        <div id="login-screen">
            <div class="login-box">
                <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:120px; margin-bottom:20px;">
                <h2 style="color:var(--sahab-red); margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <select id="user-type" class="login-input">
                    <option value="admin">Admin </option>
                    <option value="viewer">User </option>
                </select>
                <input type="password" id="login-pass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                <p id="login-error" style="color:red; font-size:12px; margin-top:10px; display:none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</p>
            </div>
        </div>

        <div id="sector-1">
            <div class="no-print" style="padding: 15px; border-bottom: 2px solid #e74c3c; display: flex; align-items: center; justify-content: space-between; background: #fff;">
                <div style="font-weight: 900; color: #333; font-size: 18px;">
                    <i class="fas fa-chevron-left" style="color: #e74c3c; margin-left: 10px; cursor:pointer;" onclick="goBack()"></i>
                    <span id="current-command-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; direction: ltr;">
                    <div style="text-align: right;">
                        <div style="font-weight: 900; color: #e74c3c; font-size: 18px; line-height: 1;">Ø´Ø±ÙƒØ© Ø³Ø­Ø§Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</div>
                        <div style="font-size: 9px; color: #666; font-weight: bold;">SAHAB REAL ESTATES DEV </div>
                    </div>
                    <div style="width:60px; height:60px; background: #fff; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eee;">
                        <img src="https://i.postimg.cc/xqSdpmBX/lqtt-shasht-2026-02-12-035734.png" alt="Logo" style="width:100%; height:100%; object-fit:contain;">
                    </div>
                </div>
            </div>
            <div id="main-content" style="flex: 1; padding:20px; background: #fafafa; overflow-y: auto;"></div>
        </div>

        <div id="sector-4" class="no-print">
            <button class="action-btn-main" id="btn-add" onclick="executeAction('Ø¥Ø¶Ø§ÙØ©')" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©"><i class="fas fa-plus" style="margin-left: 8px;"></i>Ø¥Ø¶Ø§ÙØ©</button>
            <button class="action-btn-main" id="btn-edit" onclick="executeAction('ØªØ¹Ø¯ÙŠÙ„')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"><i class="fas fa-edit" style="margin-left: 8px;"></i>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action-btn-main" id="btn-delete" style="color:#e74c3c;" onclick="executeAction('Ø­Ø°Ù')" title="Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯"><i class="fas fa-trash" style="margin-left: 8px;"></i>Ø­Ø°Ù</button>
            <button class="action-btn-main" style="color:#3498db;" onclick="window.print()" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"><i class="fas fa-print" style="margin-left: 8px;"></i>Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="action-btn-main" style="color:#666;" onclick="goBack()" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"><i class="fas fa-arrow-left" style="margin-left: 8px;"></i>Ø±Ø¬ÙˆØ¹</button>
            <button onclick="renderExternalExpenses()" style="padding: 10px 20px; background: var(--sahab-green); color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©"><i class="fas fa-wallet" style="margin-left: 5px;"></i>Ù…ØµØ±ÙˆÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</button>
            <button onclick="showNotifications()" style="width:60px; height:50px; color:#e74c3c; background:white; border:1px solid #ddd; border-radius:10px; position:relative; transition: 0.3s;" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
                <i class="fas fa-bell" style="font-size: 20px;"></i>
                <span id="notif-count" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:9px; position:absolute; top:5px; right:5px; display:none; font-weight: bold;">0</span>
            </button>
        </div>

        <div id="sector-2" class="no-print">
            <div style="font-weight: 900; color: #e74c3c; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</div>
            <div style="background: #fff; border: 3px solid #e74c3c; border-radius: 12px; padding: 10px; text-align: center;">
                <div id="clock" style="font-size: 28px; font-weight: 900; color: #e74c3c;">00:00:00</div>
                <div id="date" style="font-size: 12px; font-weight: 900; color: #555;">--/--/----</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px; flex: 1; margin-top: 10px;">
                <button class="cmd-btn" onclick="renderDashboard()" title="Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-chart-line" style="margin-left: 8px;"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <button class="cmd-btn" onclick="executeAction('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')" title="Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-list" style="margin-left: 8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="cmd-btn" id="btn-collect" onclick="executeAction('ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·')" style="border-right-color: var(--sahab-green);" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"><i class="fas fa-coins" style="margin-left: 8px;"></i>ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·</button>
                <button class="cmd-btn" onclick="renderCollectionsManager()" style="border-right-color: #ff9800;" title="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª"><i class="fas fa-file-invoice-dollar" style="margin-left: 8px;"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</button>
                <button class="cmd-btn" id="btn-settings" onclick="renderSettings()" style="border-right-color: #666;" title="ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-cog" style="margin-left: 8px;"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button class="cmd-btn" onclick="logout()" style="border-right-color: #000; background: #f9f9f9;" title="Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…"><i class="fas fa-sign-out-alt" style="margin-left: 8px; color: #e74c3c;"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div id="sector-3" class="no-print">
            <div style="font-weight: 900; font-size: 14px; text-align: center;">Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="protectedRegions();" ondblclick="quickAddRegion();" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;"><i class="fas fa-map" style="color: #e74c3c;"></i>Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´Ø±ÙƒØ©</button>
                <button onclick="protectedInstallmentForm();" ondblclick="quickShowCustomers();" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;"><i class="fas fa-user-plus" style="color: #e74c3c;"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
                <button onclick="protectedExpenses();" ondblclick="quickAddExpense();" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;"><i class="fas fa-receipt" style="color: #e74c3c;"></i>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
                <button onclick="renderTreasury();" ondblclick="renderCollectionsManager();" style="font-size: 11px; padding: 10px 0; cursor:pointer; font-weight:bold; background:#fff; border:1px solid #ddd; border-radius:5px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s;"><i class="fas fa-vault" style="color: #e74c3c;"></i>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
            </div>
            <div id="tree-container" style="overflow-y: auto; flex: 1; margin-top: 5px; border-top: 1px solid #eee;"></div>
        </div>

        <script>
            let currentUser = null; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            let passwords = JSON.parse(localStorage.getItem('sahab_passwords')) || { admin: '123', viewer: '456' };
            let cloudEditMode = false; // Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©

            let upstashConfig = JSON.parse(localStorage.getItem('sahab_upstash_config')) || {
                enabled: true,
                url: 'https://distinct-bull-37854.upstash.io',
                token: 'AZPeAAIncDFmMTBlMGE5YzBlNmI0ZTgwYTkxNWRmOGYzMjk4NTYwY3AxMzc4NTQ',
                key: 'sahab_data'
            };

            let lastCloudSync = localStorage.getItem('sahab_last_sync') || null;
            let cloudSyncInProgress = false;

            async function loadFromUpstash() {
                try {
                    const response = await fetch(`${upstashConfig.url}/get/${upstashConfig.key}`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${upstashConfig.token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.result) return JSON.parse(data.result);
                    }
                    return null;
                } catch (error) {
                    console.error('Upstash Load Error:', error);
                    throw error;
                }
            }

            async function saveToUpstash() {
                if (!upstashConfig.enabled || !upstashConfig.url || !upstashConfig.token) return;
                if (cloudSyncInProgress) return;
                cloudSyncInProgress = true;
                showCloudSyncIndicator('syncing');
                try {
                    const dataToSave = {
                        regions: appData.regions, customers: appData.customers,
                        expenses: appData.expenses, externalExpenses: appData.externalExpenses,
                        collections: appData.collections, lastUpdate: new Date().toISOString()
                    };
                    const response = await fetch(`${upstashConfig.url}/set/${upstashConfig.key}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${upstashConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });
                    if (response.ok) {
                        lastCloudSync = new Date().toISOString();
                        localStorage.setItem('sahab_last_sync', lastCloudSync);
                        showCloudSyncIndicator('success');
                    } else {
                        showCloudSyncIndicator('error');
                    }
                } catch (error) {
                    showCloudSyncIndicator('error', error.message);
                } finally {
                    cloudSyncInProgress = false;
                }
            }

            function showCloudSyncIndicator(status, message) {
                const oldIndicator = document.getElementById('cloud-sync-indicator');
                if (oldIndicator) oldIndicator.remove();
                let colors = {
                    'syncing': { bg: '#3498db', text: 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...' },
                    'success': { bg: '#27ae60', text: 'â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' },
                    'error': { bg: '#e74c3c', text: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸' }
                };
                const config = colors[status] || colors['syncing'];
                const indicator = document.createElement('div');
                indicator.id = 'cloud-sync-indicator';
                indicator.style.cssText = `position:fixed;bottom:60px;right:20px;background:${config.bg};color:white;padding:12px 18px;border-radius:25px;font-size:12px;font-weight:bold;box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease;z-index:10001;`;
                indicator.innerHTML = config.text;
                document.body.appendChild(indicator);
                if (status !== 'syncing') {
                    setTimeout(() => { indicator.style.animation='slideOut 0.3s ease'; setTimeout(() => indicator.remove(), 300); }, 3000);
                }
            }

            async function initializeData() {
                try {
                    if (upstashConfig.enabled && upstashConfig.url && upstashConfig.token) {
                        try {
                            const cloudData = await loadFromUpstash();
                            if (cloudData && cloudData.regions) {
                                appData.regions = cloudData.regions || [];
                                appData.customers = cloudData.customers || [];
                                appData.expenses = cloudData.expenses || [];
                                appData.externalExpenses = cloudData.externalExpenses || [];
                                appData.collections = cloudData.collections || [];
                                appData.customers.forEach(c => {
                                    if (!c.masterInstallments && c.installments) {
                                        c.masterInstallments = ensureInstallmentIds(JSON.parse(JSON.stringify(c.installments)), c.unit || c.name);
                                    }
                                });
                                migrateInstallmentsToCollections();
                                saveToLocalStorage();
                                if (cloudData.lastUpdate) { lastCloudSync = cloudData.lastUpdate; localStorage.setItem('sahab_last_sync', lastCloudSync); }
                                showCloudSyncIndicator('success');
                                renderDashboard(); renderTree();
                                return;
                            }
                        } catch (e) {
                            console.error("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Upstash:", e.message);
                            showCloudSyncIndicator('error', e.message);
                        }
                    }
                    try {
                        const localRegions = localStorage.getItem('sahab_regions');
                        const localCustomers = localStorage.getItem('sahab_customers');
                        const localExpenses = localStorage.getItem('sahab_expenses');
                        const localExtExpenses = localStorage.getItem('sahab_external_expenses');
                        const localCollections = localStorage.getItem('sahab_collections');
                        if (localRegions) appData.regions = JSON.parse(localRegions);
                        if (localCustomers) appData.customers = JSON.parse(localCustomers);
                        if (localExpenses) appData.expenses = JSON.parse(localExpenses);
                        if (localExtExpenses) appData.externalExpenses = JSON.parse(localExtExpenses);
                        if (localCollections) appData.collections = JSON.parse(localCollections);
                        appData.customers.forEach(c => {
                            if (!c.masterInstallments && c.installments) {
                                c.masterInstallments = ensureInstallmentIds(JSON.parse(JSON.stringify(c.installments)), c.unit || c.name);
                            }
                        });
                        migrateInstallmentsToCollections();
                    } catch (e) {
                        console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:", e.message);
                    }
                    renderDashboard(); renderTree(); checkNotifications();
                } catch (error) {
                    console.error("âŒ Ø®Ø·Ø£ Ø­Ø±Ø¬ ÙÙŠ initializeData:", error);
                    renderDashboard(); renderTree(); checkNotifications();
                }
            }

            function saveToLocalStorage() {
                try {
                    localStorage.setItem('sahab_regions', JSON.stringify(appData.regions));
                    localStorage.setItem('sahab_customers', JSON.stringify(appData.customers));
                    localStorage.setItem('sahab_expenses', JSON.stringify(appData.expenses));
                    localStorage.setItem('sahab_external_expenses', JSON.stringify(appData.externalExpenses));
                    localStorage.setItem('sahab_collections', JSON.stringify(appData.collections));
                    localStorage.setItem('sahab_last_modified', new Date().toISOString());
                } catch (error) { console.error('LocalStorage Save Error:', error); }
            }

            function saveData() {
                try {
                    saveToLocalStorage();
                    showAutoSaveIndicator();
                    if (upstashConfig.enabled) {
                        clearTimeout(window._syncTimeout);
                        window._syncTimeout = setTimeout(() => saveToUpstash(), 3000);
                    }
                    checkNotifications();
                    renderTree();
                    return true;
                } catch (error) {
                    console.error('Save Error:', error);
                    return false;
                }
            }

            function showAutoSaveIndicator() {
                const oldIndicator = document.getElementById('auto-save-indicator');
                if (oldIndicator) oldIndicator.remove();
                const indicator = document.createElement('div');
                indicator.id = 'auto-save-indicator';
                indicator.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#27ae60;color:white;padding:10px 15px;border-radius:25px;font-size:12px;font-weight:bold;box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease;z-index:10001;';
                indicator.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
                document.body.appendChild(indicator);
                setTimeout(() => { indicator.style.animation = 'slideOut 0.3s ease'; setTimeout(() => indicator.remove(), 300); }, 2000);
            }

            function verifyAdminPassword(actionName) {
                if (currentUser !== 'admin') { alert('âŒ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„Ù„Ù€ Admin'); return false; }
                const password = prompt('ğŸ” ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + actionName + '\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Admin Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:');
                if (!password) return false;
                if (password !== passwords.admin) { alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!\n\nØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.'); return false; }
                return true;
            }

            function login() {
                const type = document.getElementById('user-type').value;
                const pass = document.getElementById('login-pass').value;
                if (!pass) { document.getElementById('login-error').innerText = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!'; document.getElementById('login-error').style.display = 'block'; return; }
                if (pass === passwords[type]) {
                    currentUser = type;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('login-error').style.display = 'none';
                    applyPermissions();
                    showCloudLoadingScreen();
                    initializeData().then(function() {
                        checkNotifications();
                    });
                } else {
                    document.getElementById('login-error').innerText = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!';
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-pass').value = '';
                    document.getElementById('login-pass').focus();
                }
            }

            function showCloudLoadingScreen() {
                document.getElementById('main-content').innerHTML =
                    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;gap:20px;">' +
                    '<div style="font-size:48px;">â˜ï¸</div>' +
                    '<div style="font-size:18px;font-weight:bold;color:var(--sahab-red);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>' +
                    '</div>';
            }

            function logout() {
                currentUser = null;
                document.getElementById('login-pass').value = '';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('login-error').style.display = 'none';
            }

            function applyPermissions() {
                const isAdmin = currentUser === 'admin';
                ['btn-add', 'btn-edit', 'btn-delete', 'btn-collect'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) { btn.disabled = !isAdmin; if (!isAdmin) btn.title = "Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©"; }
                });
            }

            function protectedRegions() { renderRegions(); }
            function protectedInstallmentForm() { renderInstallmentForm(); }
            function protectedExpenses() { renderExpenses(); }

            let appData = {
                regions: [], customers: [], expenses: [], externalExpenses: [], collections: [],
                selected: { type: null, id: null, rid: null, bid: null, ucode: null, index: null },
                currentView: 'dashboard'
            };

            function ensureInstallmentIds(installments, prefix) {
                if (!installments) return [];
                return installments.map((inst, i) => {
                    const copy = Object.assign({}, inst);
                    if (!copy.id) {
                        const idSuffix = Date.now().toString().slice(-5) + Math.random().toString(36).slice(2,6);
                        copy.id = (prefix||'inst') + '_' + i + '_' + idSuffix;
                    }
                    return copy;
                });
            }

            function migrateInstallmentsToCollections() {
                if (!appData.collections) appData.collections = [];
                if (appData.collections.length > 0) return 0;
                let created = 0;
                appData.customers.forEach((c, custIdx) => {
                    let master = c.masterInstallments || c.installments || [];
                    master = ensureInstallmentIds(master, c.unit || c.name);
                    c.masterInstallments = JSON.parse(JSON.stringify(master));
                    master.forEach(inst => {
                        if (inst.status && inst.status.toLowerCase() === 'paid') {
                            let exists = appData.collections.some(col => Array.isArray(col.appliedInstallments) && col.appliedInstallments.some(ap => ap.installmentId === inst.id && col.customerIndex === custIdx));
                            if (!exists) {
                                appData.collections.push({
                                    id: 'migr_' + Date.now().toString() + Math.random().toString(36).slice(2,6),
                                    customerIndex: custIdx, customerName: c.name, building: c.building,
                                    region: c.region, unit: c.unit, type: 'payment', amount: inst.a,
                                    date: inst.d || new Date().toISOString().split('T')[0],
                                    time: '00:00:00', status: 'completed', createdAt: new Date().toISOString(),
                                    appliedInstallments: [{ installmentId: inst.id, amount: inst.a }]
                                });
                                created++;
                            }
                        }
                    });
                });
                if (created > 0) saveData();
                return created;
            }

            function generateSahabUnits(hasBasement, floors, unitsPerFloor, hasRoof, roofCount) {
                var units = [];
                // Ø¨ÙŠØ³Ù…Ù†Øª B
                if (hasBasement) {
                    units.push({ code: 'B', type: 'Ø¨ÙŠØ³Ù…Ù†Øª', status: 'available' });
                }
                // Ø£Ø¯ÙˆØ§Ø± Ù…ØªÙƒØ±Ø±Ø© A-1 Ø¥Ù„Ù‰ A-N (ØªØ±Ù‚ÙŠÙ… Ù…ØªØ³Ù„Ø³Ù„ Ù…Ø³ØªÙ…Ø±)
                var totalRepeatedUnits = (floors || 4) * (unitsPerFloor || 2);
                for (var i = 1; i <= totalRepeatedUnits; i++) {
                    units.push({ code: 'A-' + i, type: 'Ù…ØªÙƒØ±Ø±', status: 'available' });
                }
                // Ø±ÙˆÙ R
                if (hasRoof !== false) {
                    var rCount = roofCount || 1;
                    for (var r = 1; r <= rCount; r++) {
                        units.push({ code: rCount > 1 ? ('R-' + r) : 'R', type: 'Ø±ÙˆÙˆÙ', status: 'available' });
                    }
                }
                return units;
            }

            function renderDashboard() {
                appData.currentView = 'dashboard';
                document.getElementById('current-command-text').innerText = "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
                let totalSold = appData.customers.length;
                let totalUnits = appData.regions.reduce((s, r) => s + r.buildings.reduce((ss, b) => ss + b.units.length, 0), 0);
                let totalIncome = 0;
                appData.collections.forEach(col => { if (col.type === 'payment') totalIncome += col.amount; });

                let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">' +
                    '<div class="dashboard-card" onclick="renderRegions()"><div class="value">' + appData.regions.length + '</div><div class="label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div></div>' +
                    '<div class="dashboard-card" onclick="executeAction(\'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡\')"><div class="value">' + totalSold + '</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</div></div>' +
                    '<div class="dashboard-card" onclick="showAvailableUnits()" style="cursor:pointer;"><div class="value">' + (totalUnits - totalSold) + '</div><div class="label">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ğŸ¢</div></div>' +
                    '<div class="dashboard-card" onclick="renderTreasury()"><div class="value">' + totalIncome.toLocaleString() + '</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div></div>' +
                    '<div class="dashboard-card"><div class="value">' + appData.customers.length + '</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div></div>' +
                    '<div class="dashboard-card" onclick="renderCollectionsManager()"><div class="value">' + appData.collections.length + '</div><div class="label">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</div></div>' +
                    '</div>' +
                    '<div style="margin-top:20px; background:white; padding:20px; border-radius:15px; border:1px solid #ddd;">' +
                    '<h3 style="color:var(--sahab-red); margin-top:0;">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>' +
                    '<table class="res-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>' +
                    appData.customers.slice(-5).reverse().map(c => '<tr><td>' + c.qStart + '</td><td>ØªØ¹Ø§Ù‚Ø¯: ' + c.name + '</td><td>' + c.total.toLocaleString() + '</td></tr>').join('') +
                    '</tbody></table></div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function renderTree() {
                let html = '';
                appData.regions.forEach(r => {
                    html += '<div class="tree-item"><div class="tree-header" onclick="toggleTree(this)"><i class="fas fa-folder"></i> ' + r.name + '</div><div class="tree-content">' +
                        r.buildings.map(b => '<div class="tree-item" style="margin-right:15px;"><div class="tree-header" onclick="renderUnits(' + r.id + ',' + b.id + ')"><i class="fas fa-building"></i> ' + b.name + '</div></div>').join('') +
                        '</div></div>';
                });
                document.getElementById('tree-container').innerHTML = html;
            }

            function toggleTree(el) {
                const content = el.nextElementSibling;
                content.classList.toggle('active');
                el.querySelector('i').classList.toggle('fa-folder-open');
            }

            function handleItemClick(el, type, id, rid, bid) {
                document.querySelectorAll('.card-item, .card-item-row, .unit-box').forEach(x => x.classList.remove('selected'));
                el.classList.add('selected');
                appData.selected = { type: type, id: id, rid: rid||null, bid: bid||null, ucode: type === 'unit' ? id : null, index: type === 'customer' ? id : null };
            }

            function renderRegions() {
                appData.currentView = 'regions';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©";
                let html = '<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">' +
                    appData.regions.map(r => '<div class="card-item" onclick="handleItemClick(this,\'region\',' + r.id + ')" ondblclick="renderBuildings(' + r.id + ')"><div style="font-weight:900; color:var(--sahab-red);">' + r.name + '</div><div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª: ' + r.buildings.length + '</div></div>').join('') +
                    '</div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function renderBuildings(rid) {
                appData.currentView = 'buildings';
                appData.selected.rid = rid;
                const reg = appData.regions.find(r => r.id === rid);
                document.getElementById('current-command-text').innerText = "Ø¹Ù…Ø§Ø±Ø§Øª Ù…Ù†Ø·Ù‚Ø©: " + reg.name;
                let html = '<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">' +
                    reg.buildings.map(b => '<div class="card-item" onclick="handleItemClick(this,\'building\',' + b.id + ',' + rid + ')" ondblclick="renderUnits(' + rid + ',' + b.id + ')"><div style="font-weight:900; color:var(--sahab-red);">' + b.name + '</div><div style="font-size:12px; color:#666; margin-top:5px;">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ' + b.units.length + '</div></div>').join('') +
                    '</div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function renderUnits(rid, bid) {
                appData.currentView = 'units';
                appData.selected.rid = rid; appData.selected.bid = bid;
                const b = appData.regions.find(r => r.id === rid).buildings.find(b => b.id === bid);
                document.getElementById('current-command-text').innerText = "ÙˆØ­Ø¯Ø§Øª Ø¹Ù…Ø§Ø±Ø©: " + b.name;
                let groundUnits = b.units.filter(u => u.type === 'Ø£Ø±Ø¶ÙŠ');
                let roofUnits = b.units.filter(u => u.type === 'Ø±ÙˆÙˆÙ');
                let basementUnits = b.units.filter(u => u.type === 'Ø¨ÙŠØ³Ù…Ù†Øª');
                let typicalUnits = b.units.filter(u => u.type !== 'Ø£Ø±Ø¶ÙŠ' && u.type !== 'Ø±ÙˆÙˆÙ' && u.type !== 'Ø¨ÙŠØ³Ù…Ù†Øª');
                let unitsHtml = '';
                if (roofUnits.length) unitsHtml += '<div style="margin-bottom:20px;"><div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:8px 15px;border-radius:10px 10px 0 0;font-weight:bold;text-align:center;">ğŸ  Ø±ÙˆÙˆÙ</div><div style="display:flex;gap:10px;justify-content:center;padding:15px;background:#f8f9fa;border:2px solid #667eea;border-top:none;border-radius:0 0 10px 10px;">' + roofUnits.map(u => renderUnitBox(u, rid, bid)).join('') + '</div></div>';
                if (typicalUnits.length) unitsHtml += '<div style="margin-bottom:20px;"><div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:8px 15px;border-radius:10px 10px 0 0;font-weight:bold;text-align:center;">ğŸ¢ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;padding:15px;background:#f8f9fa;border:2px solid #f093fb;border-top:none;border-radius:0 0 10px 10px;">' + typicalUnits.map(u => renderUnitBox(u, rid, bid)).join('') + '</div></div>';
                if (groundUnits.length) unitsHtml += '<div style="margin-bottom:20px;"><div style="background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:8px 15px;border-radius:10px 10px 0 0;font-weight:bold;text-align:center;">ğŸ—ï¸ Ø£Ø±Ø¶ÙŠ</div><div style="display:flex;gap:10px;justify-content:center;padding:15px;background:#f8f9fa;border:2px solid #4facfe;border-top:none;border-radius:0 0 10px 10px;">' + groundUnits.map(u => renderUnitBox(u, rid, bid)).join('') + '</div></div>';
                if (basementUnits.length) unitsHtml += '<div style="margin-bottom:20px;"><div style="background:linear-gradient(135deg,#434343,#000000);color:white;padding:8px 15px;border-radius:10px 10px 0 0;font-weight:bold;text-align:center;">ğŸ…±ï¸ Ø¨ÙŠØ³Ù…Ù†Øª</div><div style="display:flex;gap:10px;justify-content:center;padding:15px;background:#f8f9fa;border:2px solid #434343;border-top:none;border-radius:0 0 10px 10px;">' + basementUnits.map(u => renderUnitBox(u, rid, bid)).join('') + '</div></div>';
                let availableCount = b.units.filter(u => u.status === 'available').length;
                let soldCount = b.units.filter(u => u.status === 'sold').length;
                let html = '<div style="background:#fff;padding:25px;border-radius:20px;border:1px solid #ddd;">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">' +
                    '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;border-radius:15px;text-align:center;"><div style="font-size:28px;font-weight:900;">' + b.units.length + '</div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
                    '<div style="background:var(--sahab-green);color:white;padding:15px;border-radius:15px;text-align:center;"><div style="font-size:24px;font-weight:900;">' + availableCount + '</div><div style="font-size:10px;">Ù…ØªØ§Ø­Ø©</div></div>' +
                    '<div style="background:var(--sahab-red);color:white;padding:15px;border-radius:15px;text-align:center;"><div style="font-size:24px;font-weight:900;">' + soldCount + '</div><div style="font-size:10px;">Ù…Ø¨Ø§Ø¹Ø©</div></div>' +
                    '</div></div>' + unitsHtml + '</div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function renderUnitBox(u, rid, bid) {
                let color = u.status === 'available' ? 'var(--sahab-green)' : 'var(--sahab-red)';
                let region = appData.regions.find(r => r.id === rid);
                let building = region ? region.buildings.find(b => b.id === bid) : null;
                let buildingName = building ? building.name : '';
                let customer = appData.customers.find(c => c.unit === u.code && c.building === buildingName);
                let dblClick = u.status === 'available' ? "executeAction('Ø¥Ø¶Ø§ÙØ©')" : 'viewCustomerDetail(' + appData.customers.indexOf(customer) + ')';
                return '<div class="unit-box" style="background:' + color + ';box-shadow:0 3px 10px rgba(0,0,0,0.15);transition:all 0.3s ease;" onclick="handleItemClick(this,\'unit\',\'' + u.code + '\',' + rid + ',' + bid + ')" ondblclick="' + dblClick + '" onmouseover="this.style.transform=\'translateY(-3px) scale(1.05)\'" onmouseout="this.style.transform=\'\'"><div style="font-size:16px;font-weight:900;margin-bottom:3px;">' + u.code + '</div><div style="font-size:9px;opacity:0.9;">' + u.type + '</div></div>';
            }

            // ============================================================
            // âœ… FIXED: renderCollection - Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ØªØ­ØµÙŠÙ„
            // ============================================================
            function renderCollection() {
                document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·";
                let html = '<div class="installment-card">' +
                    '<h3 style="color:var(--sahab-red);"><i class="fas fa-search" style="margin-left:8px;"></i>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªØ­ØµÙŠÙ„</h3>' +
                    '<div style="background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;padding:10px;margin-bottom:10px;font-size:12px;color:#1565c0;">' +
                    'ğŸ’¡ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙ‡ Ø£Ùˆ Ø±Ù‚Ù… ÙˆØ­Ø¯ØªÙ‡ Ù„Ù„Ø¨Ø­Ø«ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« Ù„ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ØµÙŠÙ„' +
                    '</div>' +
                    '<input type="text" id="searchInput" class="installment-input" placeholder="ğŸ” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©..." style="font-size:15px;padding:12px;">' +
                    '</div>' +
                    '<div id="searchResult" style="margin-top:10px;"></div>';
                document.getElementById('main-content').innerHTML = html;
                
                // âœ… Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ HTML
                setTimeout(function() {
                    var searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.addEventListener('input', function() {
                            searchCollection(this.value);
                        });
                        searchInput.focus();
                    }
                }, 50);
            }

            // ============================================================
            // âœ… FIXED: searchCollection - Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¨Ø­Ø«
            // ============================================================
            function searchCollection(val) {
                console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø«:', val, '- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', appData.customers.length);
                var searchResult = document.getElementById('searchResult');
                if (!searchResult) return;
                
                if (!val || val.trim() === '') {
                    searchResult.innerHTML = '';
                    return;
                }

                var searchVal = val.trim().toLowerCase();

                // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ù†Ø¨Ù†ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø§Ù„Ù€ index Ø§Ù„ØµØ­ÙŠØ­ Ù…Ø¨Ø§Ø´Ø±Ø©
                var filteredWithIndex = [];
                for (var i = 0; i < appData.customers.length; i++) {
                    var c = appData.customers[i];
                    var name = (c.name || '').toLowerCase();
                    var phone = (c.phone || '').toLowerCase();
                    var unit = (c.unit || '').toLowerCase();
                    var building = (c.building || '').toLowerCase();
                    if (name.indexOf(searchVal) !== -1 || phone.indexOf(searchVal) !== -1 ||
                        unit.indexOf(searchVal) !== -1 || building.indexOf(searchVal) !== -1) {
                        filteredWithIndex.push({ c: c, idx: i });
                    }
                }

                console.log('âœ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:', filteredWithIndex.length);

                if (filteredWithIndex.length === 0) {
                    searchResult.innerHTML = '<div style="padding:20px;text-align:center;color:#999;background:#f9f9f9;border-radius:10px;border:2px dashed #ddd;">' +
                        '<div style="font-size:30px;margin-bottom:10px;">ğŸ”</div>' +
                        '<strong>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</strong><br>' +
                        '<small>ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨ÙŠÙ† ' + appData.customers.length + ' Ø¹Ù…ÙŠÙ„</small></div>';
                    return;
                }

                // âœ… Ø¨Ù†Ø§Ø¡ HTML Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… concatenation (Ù„Ø§ template literals) Ù…Ø¹ data-idx
                var html = '';
                for (var j = 0; j < filteredWithIndex.length; j++) {
                    var item = filteredWithIndex[j];
                    var c = item.c;
                    var idx = item.idx;

                    var totalPaid = 0, totalDeductions = 0;
                    for (var k = 0; k < appData.collections.length; k++) {
                        var col = appData.collections[k];
                        if (col.customerIndex === idx) {
                            if (col.type === 'payment') totalPaid += col.amount;
                            else if (col.type === 'deduction') totalDeductions += col.amount;
                        }
                    }
                    var masterTotal = c.masterInstallments ? c.masterInstallments.reduce(function(s, x) { return s + x.a; }, 0) : (c.total || 0);
                    var totalPending = Math.round((masterTotal - totalPaid + totalDeductions) * 100) / 100;

                    html += '<div class="search-result-card" data-customer-idx="' + idx + '" style="background:#fff;border:2px solid #eee;border-right:10px solid var(--sahab-green);padding:15px;border-radius:15px;cursor:pointer;margin-bottom:8px;">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                            '<div>' +
                                '<strong style="color:var(--sahab-red);font-size:15px;display:block;margin-bottom:4px;">' + c.name + '</strong>' +
                                '<span style="color:#666;font-size:12px;">ğŸ“ ' + c.phone + '&nbsp;&nbsp;|&nbsp;&nbsp;ğŸ  ' + c.building + ' / ' + c.unit + '</span>' +
                            '</div>' +
                            '<div style="text-align:center;background:#f9f9f9;padding:10px 15px;border-radius:10px;min-width:100px;">' +
                                '<div style="color:#999;font-size:11px;margin-bottom:3px;">Ø§Ù„Ù…Ø³ØªØ­Ù‚</div>' +
                                '<div style="color:var(--sahab-red);font-size:16px;font-weight:900;">' + totalPending.toLocaleString() + '</div>' +
                                '<div style="color:#27ae60;font-size:10px;margin-top:4px;font-weight:bold;">â–¶ Ø§Ø¶ØºØ· Ù„Ù„ØªØ­ØµÙŠÙ„</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                searchResult.innerHTML = html;

                // âœ… Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± - Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†Ù‚Ø±
                var cards = searchResult.querySelectorAll('.search-result-card');
                cards.forEach(function(card) {
                    card.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var customerIdx = parseInt(this.getAttribute('data-customer-idx'));
                        console.log('ğŸ–±ï¸ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù…:', customerIdx, '-', (appData.customers[customerIdx] ? appData.customers[customerIdx].name : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'));
                        safeOpenCollection(customerIdx);
                    });
                });
            }

            // ============================================================
            // âœ… NEW: safeOpenCollection - Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„ÙØªØ­ Ø§Ù„ØªØ­ØµÙŠÙ„
            // ============================================================
            function safeOpenCollection(idx) {
                try {
                    idx = Number(idx);
                    console.log('ğŸ”“ ÙØªØ­ Ø§Ù„ØªØ­ØµÙŠÙ„:', idx);
                    if (isNaN(idx) || idx < 0) {
                        return alert('âŒ Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­ (' + idx + ')');
                    }
                    if (!appData.customers[idx]) {
                        return alert('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ' + idx + '\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ' + appData.customers.length);
                    }
                    renderCollectionForCustomer(idx);
                } catch (err) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ØªØ­ØµÙŠÙ„:', err);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ØµÙŠÙ„:\n' + err.message);
                }
            }

            // ============================================================
            // renderCollectionForCustomer - Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            // ============================================================
            function renderCollectionForCustomer(index) {
                try {
                    var c = appData.customers[index];
                    if (!c) return alert('âŒ Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    
                    document.getElementById('current-command-text').innerText = "ØªØ­ØµÙŠÙ„ Ù…Ù†: " + c.name;

                    var totalPaid = 0, totalDeductions = 0;
                    appData.collections.forEach(function(col) {
                        if (col.customerIndex === index) {
                            if (col.type === 'payment') totalPaid += col.amount;
                            else if (col.type === 'deduction') totalDeductions += col.amount;
                        }
                    });
                    
                    var masterInst = c.masterInstallments || c.installments || [];
                    masterInst = ensureInstallmentIds(masterInst, c.unit || c.name);
                    c.masterInstallments = JSON.parse(JSON.stringify(masterInst));
                    
                    var masterTotal = masterInst.reduce(function(s, x) { return s + x.a; }, 0);
                    var totalPending = Math.round((masterTotal - totalPaid + totalDeductions) * 100) / 100;
                    var pendingCount = masterInst.filter(function(x) {
                        var rs = getInstallmentRealStatus(index, x.id, x.a);
                        return rs === 'pending' || rs === 'partial';
                    }).length;

                    var today = new Date().toISOString().split('T')[0];

                    var customerCollections = appData.collections.filter(function(col) { return col.customerIndex === index; }).reverse();
                    var collectionsHtml = '';
                    if (customerCollections.length > 0) {
                        collectionsHtml = '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø±ØªØ¨ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®)</h3>' +
                            '<table class="res-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„ØªÙˆØ²ÙŠØ¹</th></tr></thead><tbody>' +
                            customerCollections.map(function(col) {
                                var distributionInfo = '';
                                if (col.type === 'payment' && Array.isArray(col.appliedInstallments) && col.appliedInstallments.length > 0) {
                                    distributionInfo = col.appliedInstallments.map(function(ap) {
                                        var inst = masterInst.find(function(i) { return i.id === ap.installmentId; });
                                        return (inst ? inst.t : 'Ù‚Ø³Ø·') + ': ' + ap.amount.toLocaleString();
                                    }).join('<br>');
                                } else {
                                    distributionInfo = '-';
                                }
                                return '<tr style="background:' + (col.type === 'payment' ? '#e8f5e9' : '#ffe8e8') + ';">' +
                                    '<td style="color:' + (col.type === 'payment' ? '#27ae60' : '#e74c3c') + ';font-weight:bold;">' + (col.type === 'payment' ? 'ğŸ’° Ø³Ø¯Ø§Ø¯' : 'ğŸ“‰ ØªÙ†Ø²ÙŠÙ„') + '</td>' +
                                    '<td style="font-weight:bold;color:' + (col.type === 'payment' ? '#27ae60' : '#e74c3c') + ';">' + col.amount.toLocaleString() + '</td>' +
                                    '<td>' + col.date + '</td>' +
                                    '<td style="font-size:11px;">' + (col.reason || col.deductionReason || 'Ø¹Ø§Ø¯ÙŠ') + '</td>' +
                                    '<td style="font-size:10px;text-align:right;">' + distributionInfo + '</td>' +
                                    '</tr>';
                            }).join('') +
                            '</tbody></table></div>';
                    }

                    var instTableHtml = '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>' +
                        // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                        masterInst.sort(function(a, b) { return (a.d || '').localeCompare(b.d || ''); }).map(function(inst, idx) {
                            var applied = 0;
                            appData.collections.forEach(function(col) {
                                if (col.type === 'payment' && Array.isArray(col.appliedInstallments)) {
                                    col.appliedInstallments.forEach(function(ap) { if (ap.installmentId === inst.id && col.customerIndex === index) applied += ap.amount; });
                                }
                            });
                            var remaining = Math.max(0, inst.a - applied);
                            var isPaid = applied >= inst.a;
                            var isLate = inst.d < today && !isPaid;
                            var bgColor = isPaid ? '#e8f5e9' : (isLate ? '#fff0f0' : '#fafafa');
                            var statusColor = isPaid ? '#27ae60' : (isLate ? '#e74c3c' : '#e67e22');
                            var statusText = isPaid ? 'âœ… Ù…Ø³Ø¯Ø¯' : (isLate ? 'ğŸ”´ Ù…ØªØ£Ø®Ø±' : 'â³ Ù…Ø¹Ù„Ù‚');
                            return '<tr style="background:' + bgColor + ';border-right:5px solid ' + statusColor + ';">' +
                                '<td><strong>' + (idx+1) + '</strong></td>' +
                                '<td>' + inst.d + '</td>' +
                                '<td>' + inst.t + '</td>' +
                                '<td style="font-weight:bold;">' + inst.a.toLocaleString() + '</td>' +
                                '<td style="font-weight:bold;color:#27ae60;">' + applied.toLocaleString() + '</td>' +
                                '<td style="font-weight:bold;color:' + (remaining > 0 ? '#e74c3c' : '#27ae60') + ';">' + remaining.toLocaleString() + '</td>' +
                                '<td style="color:' + statusColor + ';font-weight:bold;">' + statusText + '</td>' +
                                '</tr>';
                        }).join('') +
                        '</tbody></table>';

                    var html = '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:10px;">' +
                        '<div style="padding:10px;background:#f5f5f5;border-radius:5px;text-align:center;"><small>Ø§Ù„Ø§Ø³Ù…</small><br><strong>' + c.name + '</strong></div>' +
                        '<div style="padding:10px;background:#f5f5f5;border-radius:5px;text-align:center;"><small>Ø§Ù„Ù‡Ø§ØªÙ</small><br><strong>' + c.phone + '</strong></div>' +
                        '<div style="padding:10px;background:#f5f5f5;border-radius:5px;text-align:center;"><small>Ø§Ù„ÙˆØ­Ø¯Ø©</small><br><strong>' + c.building + ' / ' + c.unit + '</strong></div>' +
                        '<div style="padding:10px;background:#f5f5f5;border-radius:5px;text-align:center;"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</small><br><strong>' + c.total.toLocaleString() + '</strong></div>' +
                        '</div></div>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">' +
                        '<div class="dashboard-card" style="border-top-color:#27ae60;"><div class="value" style="color:#27ae60;">' + totalPaid.toLocaleString() + '</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯ âœ…</div></div>' +
                        '<div class="dashboard-card" style="border-top-color:#e74c3c;"><div class="value" style="color:#e74c3c;">' + totalPending.toLocaleString() + '</div><div class="label">Ø§Ù„Ù…Ø³ØªØ­Ù‚ â³</div></div>' +
                        '<div class="dashboard-card" style="border-top-color:#3498db;"><div class="value" style="color:#3498db;">' + pendingCount + '</div><div class="label">Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹Ù„Ù‚Ø©</div></div>' +
                        '</div>' +
                        '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø£Ù…Ø± ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
                        '<div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input type="number" id="collectAmt" class="installment-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº..." min="0" step="0.01"></div>' +
                        '<div><span class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„</span><input type="date" id="collectDate" class="installment-input" value="' + today + '"></div>' +
                        '</div>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;border-top:1px solid #eee;padding-top:10px;">' +
                        '<div><span class="field-label">Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ†Ø²ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input type="number" id="deductionAmt" class="installment-input" placeholder="0" min="0"></div>' +
                        '<div><span class="field-label">Ø³Ø¨Ø¨ Ø§Ù„ØªÙ†Ø²ÙŠÙ„</span><input type="text" id="deductionReason" class="installment-input" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… Ù„Ù„Ø¯Ù‡Ø§Ù†"></div>' +
                        '</div>' +
                        '<button onclick="processFlexibleCollection(' + index + ')" style="width:100%;padding:14px;background:var(--sahab-green);color:white;border:none;border-radius:10px;font-weight:900;cursor:pointer;margin-top:12px;font-size:15px;">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ¥ØµØ¯Ø§Ø± Ø£Ù…Ø±</button>' +
                        '</div>' +
                        collectionsHtml +
                        '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ù…Ø±ØªØ¨ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®)</h3>' +
                        instTableHtml + '</div>';

                    document.getElementById('main-content').innerHTML = html;
                } catch (err) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ renderCollectionForCustomer:', err);
                    document.getElementById('main-content').innerHTML = '<div style="padding:30px;text-align:center;color:#e74c3c;"><div style="font-size:40px;">âŒ</div><strong>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</strong><br><small>' + err.message + '</small><br><button onclick="renderCollection()" style="margin-top:20px;padding:10px 20px;background:var(--sahab-red);color:white;border:none;border-radius:8px;cursor:pointer;">â†© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø­Ø«</button></div>';
                }
            }

            function processFlexibleCollection(custIndex) {
                if (!verifyAdminPassword('ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„')) return;

                var amount = parseFloat(document.getElementById('collectAmt').value);
                var collectDate = document.getElementById('collectDate').value;
                var deductionAmount = parseFloat(document.getElementById('deductionAmt') && document.getElementById('deductionAmt').value || 0) || 0;
                var deductionReason = document.getElementById('deductionReason') && document.getElementById('deductionReason').value || '';

                if (!amount || amount <= 0) return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                if (!collectDate) return alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®');

                var c = appData.customers[custIndex];
                var masterInst = c.masterInstallments || c.installments || [];
                masterInst = ensureInstallmentIds(masterInst, c.unit || c.name);
                c.masterInstallments = JSON.parse(JSON.stringify(masterInst));

                var sortedInstallments = masterInst.map(function(inst, idx) { return { inst: inst, idx: idx }; }).sort(function(a, b) { return new Date(a.inst.d) - new Date(b.inst.d); });
                var remainingAmount = amount;
                var appliedInstallments = [];

                function alreadyAppliedFor(installmentId) {
                    var s = 0;
                    appData.collections.forEach(function(col) {
                        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­ØµÙŠÙ„ ÙŠØ®Øµ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„
                        if (col.type === 'payment' && col.customerIndex === custIndex && Array.isArray(col.appliedInstallments)) {
                            col.appliedInstallments.forEach(function(ap) { if (ap.installmentId === installmentId) s += ap.amount; });
                        }
                    });
                    return s;
                }

                sortedInstallments.forEach(function(item) {
                    if (remainingAmount <= 0) return;
                    // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ status
                    var already = alreadyAppliedFor(item.inst.id);
                    var outstanding = Math.max(0, item.inst.a - already);
                    if (outstanding <= 0) return;
                    var apply = Math.min(remainingAmount, outstanding);
                    remainingAmount -= apply;
                    appliedInstallments.push({ installmentId: item.inst.id, amount: apply });
                });

                var baseId = Date.now().toString() + Math.random().toString(36).slice(2,6);
                var collectionRecord = {
                    id: baseId, customerIndex: custIndex, customerName: c.name,
                    building: c.building, region: c.region, unit: c.unit,
                    type: 'payment', amount: amount, deduction: deductionAmount,
                    deductionReason: deductionReason, date: collectDate,
                    time: new Date().toLocaleTimeString('ar-EG'), status: 'completed',
                    createdAt: new Date().toISOString(), appliedInstallments: appliedInstallments
                };

                if (deductionAmount > 0) {
                    appData.collections.push({
                        id: baseId + '_d', customerIndex: custIndex, customerName: c.name,
                        building: c.building, region: c.region, unit: c.unit,
                        type: 'deduction', amount: deductionAmount, reason: deductionReason,
                        date: collectDate, time: new Date().toLocaleTimeString('ar-EG'),
                        status: 'completed', createdAt: new Date().toISOString()
                    });
                }

                appData.collections.push(collectionRecord);
                saveData();

                var totalPaid = 0;
                appData.collections.forEach(function(col) { if (col.customerIndex === custIndex && col.type === 'payment') totalPaid += col.amount; });
                var masterTotal = masterInst.reduce(function(s, x) { return s + x.a; }, 0);
                var totalRemaining = Math.round((masterTotal - totalPaid) * 100) / 100;

                alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ' + amount.toLocaleString() + ' Ø¬Ù†ÙŠÙ‡\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + collectDate + '\nğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯: ' + totalPaid.toLocaleString() + '\nâ³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ' + totalRemaining.toLocaleString());
                renderCollectionForCustomer(custIndex);
            }

            function toggleInstallmentStatus(customerIndex, installmentIndex) {
                if (!verifyAdminPassword('ØªØ³Ø¯ÙŠØ¯/Ø¥Ø±Ø¬Ø§Ø¹ Ù‚Ø³Ø·')) return;
                var c = appData.customers[customerIndex];
                var masterInst = c.masterInstallments || c.installments || [];
                masterInst = ensureInstallmentIds(masterInst, c.unit || c.name);
                c.masterInstallments = JSON.parse(JSON.stringify(masterInst));
                var inst = masterInst[installmentIndex];
                if (!inst) return alert('âŒ Ø§Ù„Ù‚Ø³Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

                var totalApplied = 0;
                appData.collections.forEach(function(col) {
                    if (col.type === 'payment' && Array.isArray(col.appliedInstallments)) {
                        col.appliedInstallments.forEach(function(ap) { if (ap.installmentId === inst.id) totalApplied += ap.amount; });
                    }
                });

                if (totalApplied >= inst.a) {
                    if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚Ø³Ø· "' + inst.t + '" (' + inst.d + ')ØŸ\nØ§Ù„Ù…Ø¨Ù„Øº: ' + inst.a.toLocaleString())) return;
                    var needed = inst.a;
                    for (var i = appData.collections.length - 1; i >= 0 && needed > 0; i--) {
                        var col = appData.collections[i];
                        if (col.type !== 'payment' || col.customerIndex !== customerIndex) continue;
                        if (!Array.isArray(col.appliedInstallments)) continue;
                        for (var j = col.appliedInstallments.length - 1; j >= 0 && needed > 0; j--) {
                            var ap = col.appliedInstallments[j];
                            if (ap.installmentId === inst.id) {
                                var take = Math.min(ap.amount, needed);
                                ap.amount -= take; col.amount -= take; needed -= take;
                                if (ap.amount <= 0) col.appliedInstallments.splice(j, 1);
                            }
                        }
                        if (col.amount <= 0) appData.collections.splice(i, 1);
                    }
                    alert('âœ… ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    var today = new Date().toISOString().split('T')[0];
                    var outstanding = Math.max(0, inst.a - totalApplied);
                    var collection = {
                        id: Date.now().toString() + Math.random().toString(36).slice(2,6),
                        customerIndex: customerIndex, customerName: c.name, building: c.building,
                        region: c.region, unit: c.unit, type: 'payment', amount: outstanding,
                        date: today, time: new Date().toLocaleTimeString('ar-EG'),
                        status: 'completed', createdAt: new Date().toISOString(),
                        appliedInstallments: [{ installmentId: inst.id, amount: outstanding }]
                    };
                    appData.collections.push(collection);
                    alert('âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ø·!\nØ§Ù„Ù…Ø¨Ù„Øº: ' + outstanding.toLocaleString() + ' Ø¬Ù†ÙŠÙ‡');
                }
                saveData();
                renderCollectionForCustomer(customerIndex);
            }

            function renderCustomerRegistry() {
                appData.currentView = 'registry';
                document.getElementById('current-command-text').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡";
                var html = '<div class="installment-card" style="margin-bottom:10px;"><input type="text" class="installment-input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©..." oninput="filterCustomerRegistry(this.value)"></div>' +
                    '<div id="registry-table-container">' + generateRegistryTable(appData.customers) + '</div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function filterCustomerRegistry(val) {
                var filtered = appData.customers.filter(function(c) { return c.name.includes(val) || c.phone.includes(val) || c.unit.includes(val) || (c.building||'').includes(val); });
                document.getElementById('registry-table-container').innerHTML = generateRegistryTable(filtered);
            }

            function generateRegistryTable(data) {
                var today = new Date().toISOString().split('T')[0];
                return '<table class="res-table"><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th><th>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</th></tr></thead><tbody>' +
                    data.map(function(c, i) {
                        var custIndex = appData.customers.indexOf(c);
                        var masterInst = c.masterInstallments || c.installments || [];
                        var lateCount = masterInst.filter(function(x) {
                            if (!x.d || x.d >= today) return false;
                            var rs = getInstallmentRealStatus(custIndex, x.id, x.a);
                            return rs === 'pending' || rs === 'partial';
                        }).length;
                        var commitColor = lateCount === 0 ? '#27ae60' : '#e74c3c';
                        var commitText = lateCount === 0 ? 'âœ… Ù…Ù„ØªØ²Ù…' : 'âš ï¸ Ù…ØªØ£Ø®Ø±';
                        return '<tr class="card-item-row" onclick="handleItemClick(this,\'customer\',' + custIndex + ')" ondblclick="viewCustomerDetail(' + custIndex + ')" style="cursor:pointer;">' +
                            '<td style="font-weight:bold;background:#f5f5f5;">' + (i+1) + '</td>' +
                            '<td>' + c.name + '</td><td>' + c.phone + '</td><td>' + (c.region||'') + '</td><td>' + c.building + '</td><td>' + c.unit + '</td>' +
                            '<td>' + c.total.toLocaleString() + '</td>' +
                            '<td style="color:' + commitColor + ';font-weight:bold;">' + commitText + '</td>' +
                            '</tr>';
                    }).join('') + '</tbody></table>';
            }

            function viewCustomerDetail(index) {
                var c = appData.customers[index];
                if (!c) return alert('âŒ Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                document.getElementById('current-command-text').innerText = "ØªÙØ§ØµÙŠÙ„: " + c.name;

                var totalPaid = 0, totalDeductions = 0;
                appData.collections.forEach(function(col) {
                    if (col.customerIndex === index) {
                        if (col.type === 'payment') totalPaid += col.amount;
                        else if (col.type === 'deduction') totalDeductions += col.amount;
                    }
                });
                var masterInst = c.masterInstallments || c.installments || [];
                masterInst = ensureInstallmentIds(masterInst, c.unit || c.name);
                c.masterInstallments = JSON.parse(JSON.stringify(masterInst));
                var masterTotal = masterInst.reduce(function(s, x) { return s + x.a; }, 0);
                var totalPending = Math.round((masterTotal - totalPaid + totalDeductions) * 100) / 100;
                var payRate = masterTotal > 0 ? ((totalPaid / masterTotal) * 100).toFixed(1) : 0;
                var today = new Date().toISOString().split('T')[0];
                var lateCount = masterInst.filter(function(inst) {
                    if (!inst.d || inst.d >= today) return false;
                    var rs = getInstallmentRealStatus(index, inst.id, inst.a);
                    return rs === 'pending' || rs === 'partial';
                }).length;

                var html = '<div class="installment-card">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
                    '<div><span class="field-label">Ø§Ù„Ø§Ø³Ù…</span><div class="installment-input">' + c.name + '</div></div>' +
                    '<div><span class="field-label">Ø§Ù„Ù‡Ø§ØªÙ</span><div class="installment-input">' + c.phone + '</div></div>' +
                    '<div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span><div class="installment-input">' + c.building + ' / ' + c.unit + '</div></div>' +
                    '<div><span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</span><div class="installment-input">' + c.total.toLocaleString() + '</div></div>' +
                    '</div>' +
                    (currentUser === 'admin' ? '<div style="margin-top:15px;display:flex;gap:10px;"><button onclick="renderInstallmentForm(' + index + ')" style="flex:1;padding:10px;background:var(--gold);border:none;border-radius:8px;font-weight:bold;cursor:pointer;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button onclick="renderCollectionForCustomer(' + index + ')" style="flex:1;padding:10px;background:var(--sahab-green);color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">ğŸ’° ØªØ­ØµÙŠÙ„</button></div>' : '') +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:10px;">' +
                    '<div class="dashboard-card" style="border-top-color:var(--sahab-green);"><div class="value">' + totalPaid.toLocaleString() + '</div><div class="label">Ø§Ù„Ù…Ø³Ø¯Ø¯</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:var(--sahab-red);"><div class="value">' + totalPending.toLocaleString() + '</div><div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:var(--blue);"><div class="value" style="font-size:16px;">' + payRate + '%</div><div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:' + (lateCount > 0 ? '#e74c3c' : '#27ae60') + ';"><div class="value" style="font-size:13px;color:' + (lateCount > 0 ? '#e74c3c' : '#27ae60') + ';">' + (lateCount > 0 ? 'âš ï¸ ' + lateCount + ' Ù…ØªØ£Ø®Ø±' : 'âœ… Ù…Ù„ØªØ²Ù…') + '</div><div class="label">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div></div>' +
                    '</div>' +
                    '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø£ØµÙ„ÙŠ</h3>' +
                    '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th></tr></thead><tbody>' +
                    masterInst.map(function(inst, i) { return '<tr><td>' + (i+1) + '</td><td>' + inst.d + '</td><td>' + inst.a.toLocaleString() + '</td><td>' + inst.t + '</td></tr>'; }).join('') +
                    '</tbody></table></div>';

                document.getElementById('main-content').innerHTML = html;
            }

            function renderInstallmentForm(editIndex) {
                if (currentUser !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Admin ÙÙ‚Ø·");
                var editData = editIndex !== null && editIndex !== undefined ? appData.customers[editIndex] : null;

                if (editData) {
                    var region = appData.regions.find(function(r) { return r.name === editData.region; });
                    if (region) {
                        appData.selected.rid = region.id;
                        var building = region.buildings.find(function(b) { return b.name === editData.building; });
                        if (building) appData.selected.bid = building.id;
                    }
                }

                var unitCode = editData ? editData.unit : (appData.selected.ucode || '');
                var buildingName = editData ? editData.building : '';
                var regionName = editData ? editData.region : '';

                var unitOptions = '';
                if (appData.selected.bid) {
                    var bldForUnits = appData.regions.find(function(r) { return r.id == appData.selected.rid; }).buildings.find(function(b) { return b.id == appData.selected.bid; });
                    var unitsToShow = editData ? bldForUnits.units : bldForUnits.units.filter(function(u) { return u.status === 'available'; });
                    unitOptions = unitsToShow.map(function(u) { return '<option value="' + u.code + '" ' + (unitCode === u.code ? 'selected' : '') + '>' + u.code + ' (' + u.type + ')</option>'; }).join('');
                }

                document.getElementById('current-command-text').innerText = editData ? "ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ø§Ù‚Ø¯" : "Ø¬Ø¯ÙˆÙ„Ø© Ø£Ù‚Ø³Ø§Ø·";

                // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                var currentInstallmentsHtml = '';
                if (editData && editData.installments && editData.installments.length > 0) {
                    currentInstallmentsHtml = '<div class="installment-card" style="background:#f5f5f5;margin-bottom:10px;"><h4 style="color:var(--sahab-red);margin-top:0;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</h4>' +
                        '<table class="res-table" style="font-size:11px;"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>' +
                        editData.installments.map(function(inst, idx) { 
                            return '<tr><td>' + (idx+1) + '</td><td>' + inst.d + '</td><td>' + inst.a.toLocaleString() + '</td><td>' + inst.t + '</td><td>' + (inst.status || 'pending') + '</td></tr>'; 
                        }).join('') +
                        '</tbody></table></div>';
                }

                var html = currentInstallmentsHtml + '<div class="installment-card">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
                    '<div><span class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span><input type="text" id="custName" class="installment-input" value="' + (editData ? editData.name : '') + '"></div>' +
                    '<div><span class="field-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span><input type="text" id="phone" class="installment-input" value="' + (editData ? editData.phone : '') + '"></div>' +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;">' +
                    '<div><span class="field-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span><select id="selRegion" class="installment-input" onchange="updateBuildingSelect(this.value,null,null)"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>' +
                    appData.regions.map(function(r) { return '<option value="' + r.id + '" ' + (regionName === r.name ? 'selected' : '') + '>' + r.name + '</option>'; }).join('') +
                    '</select></div>' +
                    '<div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span><select id="selBuilding" class="installment-input" onchange="updateUnitSelect(this.value,' + (editData ? "'" + editData.unit + "'" : 'null') + ')"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>' +
                    (appData.selected.rid ? appData.regions.find(function(r) { return r.id == appData.selected.rid; }).buildings.map(function(b) { return '<option value="' + b.id + '" ' + (buildingName === b.name ? 'selected' : '') + '>' + b.name + '</option>'; }).join('') : '') +
                    '</select></div>' +
                    '<div><span class="field-label">Ø§Ù„ÙˆØ­Ø¯Ø©</span><select id="selUnit" class="installment-input"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>' + unitOptions + '</select></div>' +
                    '</div>' +
                    '<div style="margin-top:10px;"><span class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</span><input type="number" id="totalPrice" class="installment-input" value="' + (editData ? editData.total : '') + '"></div>' +
                    '</div>' +
                    '<div class="installment-card"><span class="field-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</span>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;">' +
                    '<div><small>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</small><input type="number" id="qCount" class="installment-input" value="' + (editData ? editData.qCount : 28) + '"></div>' +
                    '<div><small>Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø³Ø·</small><select id="qFreq" class="installment-input"><option value="1" ' + (editData && editData.qFreq==1 ? 'selected' : '') + '>Ø´Ù‡Ø±ÙŠ</option><option value="3" ' + (editData && editData.qFreq==3 ? 'selected' : '') + '>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option></select></div>' +
                    '<div><small>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù‚Ø³Ø·</small><input type="date" id="qStart" class="installment-input" value="' + (editData ? editData.qStart : new Date().toISOString().split('T')[0]) + '"></div>' +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">' +
                    '<div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="number" id="downPayment" class="installment-input" value="' + (editData ? editData.downPayment : '') + '"></div>' +
                    '<div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</span><input type="date" id="downPaymentDate" class="installment-input" value="' + (editData ? editData.downPaymentDate : new Date().toISOString().split('T')[0]) + '"></div>' +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:5px;">' +
                    '<div><span class="field-label">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="number" id="deliveryPayment" class="installment-input" value="' + (editData ? editData.deliveryPayment : '') + '"></div>' +
                    '<div><span class="field-label">ØªØ§Ø±ÙŠØ® Ù…Ù‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span><input type="date" id="deliveryPaymentDate" class="installment-input" value="' + (editData ? editData.deliveryPaymentDate : '') + '"></div>' +
                    '</div>' +
                    '<div style="margin-top:10px;border-top:1px solid #eee;padding-top:10px;">' +
                    '<span class="field-label">ğŸ’° Ø¯ÙØ¹Ø§Øª/Ù…Ù‚Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>' +
                    '<div id="extra-payments-container">' +
                    (editData && editData.extraPayments && editData.extraPayments.length > 0 ? 
                        editData.extraPayments.map(function(ex, i) { 
                            return '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:5px;margin-bottom:5px;">' +
                                '<input type="date" class="installment-input ex-date" value="' + ex.d + '">' +
                                '<input type="number" class="installment-input ex-amt" value="' + ex.a + '" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">' +
                                '<input type="text" class="installment-input ex-note" value="' + (ex.t || '') + '" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ù‚Ø¯Ù…/Ø¯ÙØ¹Ø©)">' +
                                '<button onclick="this.parentElement.remove()" style="color:red;border:none;background:none;cursor:pointer;font-weight:bold;">âœ• Ø­Ø°Ù</button>' +
                            '</div>'; 
                        }).join('') 
                        : ''
                    ) +
                    '</div>' +
                    '<button onclick="addExtraPaymentRow()" style="width:100%;padding:8px;background:#eee;border:1px dashed #ccc;border-radius:5px;cursor:pointer;font-size:12px;font-weight:bold;margin-top:5px;">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©/Ù…Ù‚Ø¯Ù…</button>' +
                    '</div>' +
                    '<button onclick="processInstallments(' + (editIndex !== undefined ? editIndex : 'null') + ')" style="width:100%;padding:12px;background:var(--sahab-red);color:white;border:none;border-radius:10px;font-weight:900;cursor:pointer;margin-top:10px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</button>' +
                    '</div>';

                document.getElementById('main-content').innerHTML = html;
            }

            function addExtraPaymentRow() {
                var container = document.getElementById('extra-payments-container');
                var row = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:5px;margin-bottom:5px;">' +
                    '<input type="date" class="installment-input ex-date" placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®">' +
                    '<input type="number" class="installment-input ex-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="0" step="0.01">' +
                    '<input type="text" class="installment-input ex-note" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ù‚Ø¯Ù…/Ø¯ÙØ¹Ø©)">' +
                    '<button onclick="this.parentElement.remove()" style="color:red;border:none;background:none;cursor:pointer;font-weight:bold;">âœ• Ø­Ø°Ù</button>' +
                    '</div>';
                container.insertAdjacentHTML('beforeend', row);
            }

            function updateBuildingSelect(rid, editBuildingName, editUnitCode) {
                var reg = appData.regions.find(function(r) { return r.id == rid; });
                var sel = document.getElementById('selBuilding');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</option>' + reg.buildings.map(function(b) { return '<option value="' + b.id + '" ' + (editBuildingName === b.name ? 'selected' : '') + '>' + b.name + '</option>'; }).join('');
                appData.selected.rid = rid;
            }

            function updateUnitSelect(bid, editUnit) {
                var rid = document.getElementById('selRegion').value;
                var reg = appData.regions.find(function(r) { return r.id == rid; });
                var bld = reg.buildings.find(function(b) { return b.id == bid; });
                var sel = document.getElementById('selUnit');
                var filteredUnits = editUnit ? bld.units : bld.units.filter(function(u) { return u.status === 'available'; });
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>' + filteredUnits.map(function(u) { return '<option value="' + u.code + '" ' + (editUnit === u.code ? 'selected' : '') + '>' + u.code + ' (' + u.type + ')</option>'; }).join('');
                appData.selected.bid = bid;
            }

            function processInstallments(editIndex) {
                if (!verifyAdminPassword(editIndex !== null && editIndex !== undefined ? "ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯ Ø¹Ù…ÙŠÙ„" : "ØªØ³Ø¬ÙŠÙ„ Ø¹Ù‚Ø¯ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯")) return;
                var name = document.getElementById('custName').value;
                var phone = document.getElementById('phone').value;
                var total = parseFloat(document.getElementById('totalPrice').value) || 0;
                var rid = document.getElementById('selRegion').value;
                var bid = document.getElementById('selBuilding').value;
                var ucode = document.getElementById('selUnit').value;
                if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
                if (!phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
                if (!rid) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");
                if (!bid) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ø§Ø±Ø©");
                if (!ucode) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø©");
                if (!total || total <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©");
                var regionObj = appData.regions.find(function(r) { return r.id == rid; });
                var buildingObj = regionObj.buildings.find(function(b) { return b.id == bid; });
                var qCount = parseInt(document.getElementById('qCount').value) || 1;
                var qFreq = parseInt(document.getElementById('qFreq').value);
                var qStart = document.getElementById('qStart').value;
                var downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                var downPaymentDate = document.getElementById('downPaymentDate').value;
                var deliveryPayment = parseFloat(document.getElementById('deliveryPayment').value) || 0;
                var deliveryPaymentDate = document.getElementById('deliveryPaymentDate').value;
                
                // Ø¬Ù…Ø¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
                var extraPayments = [];
                var extraPaymentRows = document.querySelectorAll('#extra-payments-container > div');
                extraPaymentRows.forEach(function(row) {
                    var d = row.querySelector('.ex-date').value;
                    var a = parseFloat(row.querySelector('.ex-amt').value) || 0;
                    var t = row.querySelector('.ex-note').value || 'Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©';
                    if (d && a > 0) {
                        extraPayments.push({ d: d, a: a, t: t, status: 'pending' });
                    }
                });
                
                var installments = [];
                if (downPayment > 0 && downPaymentDate) installments.push({ d: downPaymentDate, a: downPayment, t: "Ù…Ù‚Ø¯Ù… ØªØ¹Ø§Ù‚Ø¯", status: 'pending' });
                if (deliveryPayment > 0 && deliveryPaymentDate) installments.push({ d: deliveryPaymentDate, a: deliveryPayment, t: "Ù…Ù‚Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…", status: 'pending' });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ù‚Ø³Ø§Ø·
                extraPayments.forEach(function(ex) { 
                    installments.push({ d: ex.d, a: ex.a, t: ex.t, status: 'pending' }); 
                });
                
                var extraTotal = downPayment + deliveryPayment + extraPayments.reduce(function(sum, ex) { return sum + ex.a; }, 0);
                var remaining = total - extraTotal;
                var instAmt = Math.round((remaining / qCount) * 100) / 100;
                for (var i = 0; i < qCount; i++) {
                    var d = new Date(qStart);
                    d.setMonth(d.getMonth() + (i * qFreq));
                    installments.push({ d: d.toISOString().split('T')[0], a: instAmt, t: "Ù‚Ø³Ø· Ø¯ÙˆØ±ÙŠ", status: 'pending' });
                }
                installments.sort(function(a, b) { return new Date(a.d) - new Date(b.d); });
                var installmentsWithIds = ensureInstallmentIds(installments, ucode || name);
                if (editIndex !== null && editIndex !== undefined) {
                    var old = appData.customers[editIndex];
                    if (old.unit !== ucode || old.building !== buildingObj.name) {
                        appData.regions.forEach(function(r) { r.buildings.forEach(function(b) { var u = b.units.find(function(u) { return u.code === old.unit && b.name === old.building; }); if (u) u.status = 'available'; }); });
                    }
                    appData.customers[editIndex] = { name: name, phone: phone, total: total, qCount: qCount, qFreq: qFreq, qStart: qStart, downPayment: downPayment, downPaymentDate: downPaymentDate, deliveryPayment: deliveryPayment, deliveryPaymentDate: deliveryPaymentDate, region: regionObj.name, building: buildingObj.name, unit: ucode, installments: installmentsWithIds, masterInstallments: JSON.parse(JSON.stringify(installmentsWithIds)), extraPayments: extraPayments };
                } else {
                    appData.customers.push({ name: name, phone: phone, total: total, qCount: qCount, qFreq: qFreq, qStart: qStart, downPayment: downPayment, downPaymentDate: downPaymentDate, deliveryPayment: deliveryPayment, deliveryPaymentDate: deliveryPaymentDate, region: regionObj.name, building: buildingObj.name, unit: ucode, installments: installmentsWithIds, masterInstallments: JSON.parse(JSON.stringify(installmentsWithIds)), extraPayments: extraPayments });
                }
                buildingObj.units.find(function(u) { return u.code === ucode; }).status = 'sold';
                saveData();
                renderCustomerRegistry();
            }

            function renderExpenses() {
                appData.currentView = 'expenses';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ";
                var html = '<div class="installment-card"><h3 style="color:var(--sahab-red);">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">' +
                    '<div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="exAmt" class="installment-input"></div>' +
                    '<div><span class="field-label">Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</span><select id="exBld" class="installment-input">' + appData.regions.flatMap(function(r) { return r.buildings.map(function(b) { return '<option value="' + b.name + '">' + b.name + '</option>'; }); }).join('') + '</select></div>' +
                    '<div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="exNote" class="installment-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙƒÙ‡Ø±Ø¨Ø§Ø¡..."></div>' +
                    '</div><button onclick="addExpense()" style="width:100%;padding:10px;background:var(--sahab-red);color:white;border:none;border-radius:10px;margin-top:10px;cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>' +
                    '<div class="installment-card"><table class="res-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>' +
                    appData.expenses.map(function(e) { return '<tr><td>' + e.date + '</td><td>' + e.building + '</td><td>' + e.note + '</td><td>' + e.amount.toLocaleString() + '</td></tr>'; }).join('') +
                    '</tbody></table></div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function addExpense() {
                if (!verifyAdminPassword('Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯')) return;
                var amount = parseFloat(document.getElementById('exAmt').value);
                var building = document.getElementById('exBld').value;
                var note = document.getElementById('exNote').value || 'Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù…';
                if (!amount) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
                appData.expenses.push({ date: new Date().toISOString().split('T')[0], amount: amount, building: building, note: note });
                saveData(); renderExpenses();
            }

            function renderTreasury() {
                document.getElementById('current-command-text').innerText = "ğŸ’° Ø§Ù„Ø®Ø²ÙŠÙ†Ø©";
                var totalIncome = 0, totalDeductions = 0;
                appData.collections.forEach(function(col) { if (col.type === 'payment') totalIncome += col.amount; else if (col.type === 'deduction') totalDeductions += col.amount; });
                var totalOut = appData.expenses.reduce(function(s, e) { return s + e.amount; }, 0);
                var balance = totalIncome - totalDeductions - totalOut;
                
                var html = '<div style="background:#e3f2fd;border:2px solid #2196f3;border-radius:12px;padding:15px;margin-bottom:15px;text-align:center;">' +
                    '<h3 style="color:#2196f3;margin:0;">ğŸ’° Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h3></div>';
                
                html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-bottom:20px;">' +
                    '<div class="dashboard-card" style="border-top-color:#27ae60;"><div class="value" style="color:#27ae60;">' + totalIncome.toLocaleString() + '</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¯Ø§Ø¯ÙŠØ§Øª âœ…</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:#e74c3c;"><div class="value" style="color:#e74c3c;">' + totalDeductions.toLocaleString() + '</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª ğŸ“‰</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:#ff9800;"><div class="value" style="color:#ff9800;">' + totalOut.toLocaleString() + '</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ğŸ’¸</div></div>' +
                    '<div class="dashboard-card" style="border-top-color:#2196f3;"><div class="value" style="color:' + (balance >= 0 ? '#27ae60' : '#e74c3c') + ';">' + balance.toLocaleString() + '</div><div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ğŸ’µ</div></div>' +
                    '</div>';
                
                // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ±
                html += '<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-bottom:15px;">' +
                    '<select id="treasuryFilterRegion" onchange="filterTreasury()" class="installment-input" style="padding:10px;"><option value="">ğŸŒ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>' +
                    appData.regions.map(function(r) { return '<option value="' + r.name + '">' + r.name + '</option>'; }).join('') +
                    '</select>' +
                    '<select id="treasuryFilterBuilding" onchange="filterTreasury()" class="installment-input" style="padding:10px;"><option value="">ğŸ¢ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</option></select>' +
                    '<button onclick="exportTreasuryExcel()" style="padding:10px;background:#27ae60;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;"><i class="fas fa-file-excel"></i>&nbsp;&nbsp;ØªØµØ¯ÙŠØ± Excel</button>' +
                    '</div>';
                
                // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØµÙ„
                html += '<div class="installment-card" style="background:#e8f5e9;border:2px solid #27ae60;margin-bottom:15px;">' +
                    '<h4 style="color:#27ae60;margin-top:0;"><i class="fas fa-hand-holding-usd"></i>&nbsp;&nbsp;ğŸ’µ Ø§Ù„Ù…Ø­ØµÙ„ (Ø§Ù„Ø³Ø¯Ø§Ø¯ÙŠØ§Øª)</h4>' +
                    '<div id="treasuryIncomeTable"></div></div>';
                
                // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ
                html += '<div class="installment-card" style="background:#ffe8e8;border:2px solid #e74c3c;">' +
                    '<h4 style="color:#e74c3c;margin-top:0;"><i class="fas fa-money-bill-wave"></i>&nbsp;&nbsp;ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙ‚Ø·)</h4>' +
                    '<div id="treasuryExpenseTable"></div></div>';
                
                document.getElementById('main-content').innerHTML = html;
                filterTreasury();
            }

            function filterTreasury() {
                var selectedRegion = document.getElementById('treasuryFilterRegion').value;
                var selectedBuilding = document.getElementById('treasuryFilterBuilding').value;
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                if (selectedRegion) {
                    var region = appData.regions.find(function(r) { return r.name === selectedRegion; });
                    var buildingSelect = document.getElementById('treasuryFilterBuilding');
                    buildingSelect.innerHTML = '<option value="">ğŸ¢ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª</option>' +
                        (region ? region.buildings.map(function(b) { return '<option value="' + b.name + '">' + b.name + '</option>'; }).join('') : '');
                }
                
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ÙŠØ§Øª
                var filteredIncome = appData.collections.filter(function(col) {
                    if (col.type !== 'payment') return false;
                    if (selectedRegion && col.region !== selectedRegion) return false;
                    if (selectedBuilding && col.building !== selectedBuilding) return false;
                    return true;
                });
                
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙÙ‚Ø· - Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª)
                var filteredExpenses = appData.expenses.filter(function(exp) {
                    if (selectedRegion && exp.region !== selectedRegion) return false;
                    if (selectedBuilding && exp.building !== selectedBuilding) return false;
                    return true;
                });
                
                // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØµÙ„
                var incomeHtml = '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th></tr></thead><tbody>';
                filteredIncome.slice().reverse().forEach(function(col, idx) {
                    incomeHtml += '<tr style="background:#f1f8f4;">' +
                        '<td>' + (idx + 1) + '</td>' +
                        '<td>' + col.date + '</td>' +
                        '<td><strong>' + (col.customerName || '') + '</strong></td>' +
                        '<td>' + (col.region || '') + '</td>' +
                        '<td>' + (col.building || '') + '</td>' +
                        '<td>' + (col.unit || '') + '</td>' +
                        '<td style="color:#27ae60;font-weight:bold;">' + col.amount.toLocaleString() + '</td>' +
                        '<td style="font-size:11px;">' + (col.reason || '-') + '</td>' +
                        '</tr>';
                });
                incomeHtml += '</tbody></table>';
                document.getElementById('treasuryIncomeTable').innerHTML = incomeHtml;
                
                // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙ‚Ø·)
                var expenseHtml = '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>';
                filteredExpenses.slice().reverse().forEach(function(exp, idx) {
                    expenseHtml += '<tr style="background:#fff5f5;">' +
                        '<td>' + (idx + 1) + '</td>' +
                        '<td>' + exp.date + '</td>' +
                        '<td>' + (exp.region || '') + '</td>' +
                        '<td>' + (exp.building || '') + '</td>' +
                        '<td>' + exp.description + '</td>' +
                        '<td style="color:#e74c3c;font-weight:bold;">' + exp.amount.toLocaleString() + '</td>' +
                        '</tr>';
                });
                
                expenseHtml += '</tbody></table>';
                document.getElementById('treasuryExpenseTable').innerHTML = expenseHtml;
            }

            function exportTreasuryExcel() {
                var selectedRegion = document.getElementById('treasuryFilterRegion').value;
                var selectedBuilding = document.getElementById('treasuryFilterBuilding').value;
                
                var workbook = new ExcelJS.Workbook();
                
                // ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø­ØµÙ„
                var incomeSheet = workbook.addWorksheet('Ø§Ù„Ù…Ø­ØµÙ„');
                incomeSheet.columns = [
                    { header: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', key: 'date', width: 12 },
                    { header: 'Ø§Ù„Ø¹Ù…ÙŠÙ„', key: 'customer', width: 20 },
                    { header: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', key: 'region', width: 15 },
                    { header: 'Ø§Ù„Ø¹Ù…Ø§Ø±Ø©', key: 'building', width: 15 },
                    { header: 'Ø§Ù„ÙˆØ­Ø¯Ø©', key: 'unit', width: 10 },
                    { header: 'Ø§Ù„Ù…Ø¨Ù„Øº', key: 'amount', width: 15 },
                    { header: 'Ø§Ù„Ø¨ÙŠØ§Ù†', key: 'reason', width: 25 }
                ];
                
                incomeSheet.getRow(1).font = { bold: true, size: 12 };
                incomeSheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF27AE60' } };
                incomeSheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
                incomeSheet.getRow(1).alignment = { horizontal: 'center', vertical: 'middle' };
                
                var filteredIncome = appData.collections.filter(function(col) {
                    if (col.type !== 'payment') return false;
                    if (selectedRegion && col.region !== selectedRegion) return false;
                    if (selectedBuilding && col.building !== selectedBuilding) return false;
                    return true;
                });
                
                filteredIncome.forEach(function(col) {
                    incomeSheet.addRow({
                        date: col.date,
                        customer: col.customerName || '',
                        region: col.region || '',
                        building: col.building || '',
                        unit: col.unit || '',
                        amount: col.amount,
                        reason: col.reason || ''
                    });
                });
                
                // ÙˆØ±Ù‚Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ (Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙ‚Ø·)
                var expenseSheet = workbook.addWorksheet('Ø§Ù„Ù…ØµØ±ÙˆÙ');
                expenseSheet.columns = [
                    { header: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', key: 'date', width: 12 },
                    { header: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', key: 'region', width: 15 },
                    { header: 'Ø§Ù„Ø¹Ù…Ø§Ø±Ø©', key: 'building', width: 15 },
                    { header: 'Ø§Ù„Ø¨ÙŠØ§Ù†', key: 'description', width: 30 },
                    { header: 'Ø§Ù„Ù…Ø¨Ù„Øº', key: 'amount', width: 15 }
                ];
                
                expenseSheet.getRow(1).font = { bold: true, size: 12 };
                expenseSheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE74C3C' } };
                expenseSheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
                expenseSheet.getRow(1).alignment = { horizontal: 'center', vertical: 'middle' };
                
                var filteredExpenses = appData.expenses.filter(function(exp) {
                    if (selectedRegion && exp.region !== selectedRegion) return false;
                    if (selectedBuilding && exp.building !== selectedBuilding) return false;
                    return true;
                });
                
                filteredExpenses.forEach(function(exp) {
                    expenseSheet.addRow({
                        date: exp.date,
                        region: exp.region || '',
                        building: exp.building || '',
                        description: exp.description,
                        amount: exp.amount
                    });
                });
                
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    var fileName = 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©_' + (selectedRegion || 'Ø§Ù„ÙƒÙ„') + '_' + new Date().toISOString().split('T')[0] + '.xlsx';
                    saveAs(new Blob([buffer]), fileName);
                    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø¥Ù„Ù‰ Excel');
                });
            }

            function renderCollectionsManager() {
                appData.currentView = 'collections';
                document.getElementById('current-command-text').innerText = "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª";
                var today = new Date().toISOString().split('T')[0];
                
                // Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                var html = '<div class="installment-card" style="background:#fff8e1;border:2px solid #ff9800;"><h3 style="color:#ff9800;margin-top:0;"><i class="fas fa-list"></i>&nbsp;&nbsp;Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>';
                html += '<button onclick="exportAllCollectionsExcel()" style="width:100%;padding:10px;background:#27ae60;color:white;border:none;border-radius:8px;font-weight:bold;margin-bottom:10px;cursor:pointer;"><i class="fas fa-file-excel"></i>&nbsp;&nbsp;ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø¥Ù„Ù‰ Excel</button>';
                html += '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©/Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
                
                appData.collections.slice().reverse().forEach(function(col, idx) {
                    var actualIdx = appData.collections.length - 1 - idx;
                    var typeIcon = col.type === 'payment' ? 'ğŸ’° Ø³Ø¯Ø§Ø¯' : 'ğŸ“‰ ØªÙ†Ø²ÙŠÙ„';
                    var typeColor = col.type === 'payment' ? '#27ae60' : '#e74c3c';
                    html += '<tr style="background:' + (col.type === 'payment' ? '#e8f5e9' : '#ffe8e8') + ';">' +
                        '<td>' + (idx + 1) + '</td>' +
                        '<td>' + col.date + '</td>' +
                        '<td><strong>' + (col.customerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</strong></td>' +
                        '<td>' + (col.building || '') + '/' + (col.unit || '') + '</td>' +
                        '<td style="color:' + typeColor + ';font-weight:bold;">' + typeIcon + '</td>' +
                        '<td style="color:' + typeColor + ';font-weight:bold;">' + col.amount.toLocaleString() + '</td>' +
                        '<td style="font-size:11px;">' + (col.reason || col.deductionReason || '-') + '</td>' +
                        '<td>' +
                        '<button onclick="editCollection(' + actualIdx + ')" style="background:#3498db;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;margin-left:3px;"><i class="fas fa-edit"></i></button>' +
                        '<button onclick="deleteCollection(' + actualIdx + ')" style="background:#e74c3c;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;"><i class="fas fa-trash"></i></button>' +
                        '</td></tr>';
                });
                
                html += '</tbody></table></div>';
                
                // Ù‚Ø³Ù… Ø¨ÙŠØ§Ù† ØªØ­ØµÙŠÙ„Ø§Øª ÙƒÙ„ Ø¹Ù…ÙŠÙ„
                html += '<div class="installment-card" style="margin-top:15px;"><h3 style="color:var(--sahab-red);">ğŸ“Š Ø¨ÙŠØ§Ù† ØªØ­ØµÙŠÙ„Ø§Øª ÙƒÙ„ Ø¹Ù…ÙŠÙ„</h3>' +
                    '<table class="res-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¹Ù…Ø§Ø±Ø©/Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯</th><th>Ø§Ù„Ù…Ø­ØµÙ„</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>' +
                    appData.customers.map(function(c, idx) {
                        var paid = 0;
                        appData.collections.forEach(function(col) { if (col.customerIndex === idx && col.type === 'payment') paid += col.amount; });
                        var masterTotal = (c.masterInstallments || c.installments || []).reduce(function(s,x) { return s+x.a; }, 0);
                        var remaining = masterTotal - paid;
                        var lateCount = (c.masterInstallments || c.installments || []).filter(function(x) {
                            if (!x.d || x.d >= today) return false;
                            var rs = getInstallmentRealStatus(idx, x.id, x.a);
                            return rs === 'pending' || rs === 'partial';
                        }).length;
                        return '<tr>' +
                            '<td>' + (idx+1) + '</td>' +
                            '<td style="font-weight:bold;">' + c.name + '<br><small style="color:#999;">' + c.phone + '</small></td>' +
                            '<td>' + c.building + '/' + c.unit + '</td>' +
                            '<td>' + c.total.toLocaleString() + '</td>' +
                            '<td style="color:#27ae60;font-weight:bold;">' + paid.toLocaleString() + '</td>' +
                            '<td style="color:#e74c3c;font-weight:bold;">' + remaining.toLocaleString() + '</td>' +
                            '<td style="color:' + (lateCount > 0 ? '#e74c3c' : '#27ae60') + ';font-weight:bold;">' + (lateCount > 0 ? 'âš ï¸ Ù…ØªØ£Ø®Ø±(' + lateCount + ')' : 'âœ… Ù…Ù„ØªØ²Ù…') + '</td>' +
                            '<td><button onclick="renderCollectionForCustomer(' + idx + ')" style="background:var(--sahab-green);color:white;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;font-size:11px;">ğŸ’° ØªØ­ØµÙŠÙ„</button> <button onclick="viewCustomerDetail(' + idx + ')" style="background:#3498db;color:white;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;font-size:11px;">ğŸ‘ Ø¹Ø±Ø¶</button></td>' +
                            '</tr>';
                    }).join('') + '</tbody></table></div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function editCollection(collectionIdx) {
                if (!verifyAdminPassword('ØªØ¹Ø¯ÙŠÙ„ ØªØ­ØµÙŠÙ„')) return;
                
                var col = appData.collections[collectionIdx];
                var newAmount = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯:', col.amount);
                if (newAmount === null) return;
                
                newAmount = parseFloat(newAmount);
                if (isNaN(newAmount) || newAmount <= 0) {
                    alert('âŒ Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­');
                    return;
                }
                
                col.amount = newAmount;
                saveData();
                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­');
                renderCollectionsManager();
            }

            function deleteCollection(collectionIdx) {
                if (!verifyAdminPassword('Ø­Ø°Ù ØªØ­ØµÙŠÙ„')) return;
                
                if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
                
                appData.collections.splice(collectionIdx, 1);
                saveData();
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                renderCollectionsManager();
            }

            function exportAllCollectionsExcel() {
                var workbook = new ExcelJS.Workbook();
                var worksheet = workbook.addWorksheet('Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª');
                
                worksheet.columns = [
                    { header: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', key: 'date', width: 12 },
                    { header: 'Ø§Ù„Ø¹Ù…ÙŠÙ„', key: 'customer', width: 20 },
                    { header: 'Ø§Ù„Ø¹Ù…Ø§Ø±Ø©', key: 'building', width: 15 },
                    { header: 'Ø§Ù„ÙˆØ­Ø¯Ø©', key: 'unit', width: 10 },
                    { header: 'Ø§Ù„Ù†ÙˆØ¹', key: 'type', width: 12 },
                    { header: 'Ø§Ù„Ù…Ø¨Ù„Øº', key: 'amount', width: 15 },
                    { header: 'Ø§Ù„Ø¨ÙŠØ§Ù†', key: 'reason', width: 25 }
                ];
                
                worksheet.getRow(1).font = { bold: true, size: 12 };
                worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF8B1A1A' } };
                worksheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
                worksheet.getRow(1).alignment = { horizontal: 'center', vertical: 'middle' };
                
                var rowIndex = 2;
                appData.collections.forEach(function(col) {
                    worksheet.addRow({
                        date: col.date,
                        customer: col.customerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        building: col.building || '',
                        unit: col.unit || '',
                        type: col.type === 'payment' ? 'Ø³Ø¯Ø§Ø¯' : 'ØªÙ†Ø²ÙŠÙ„',
                        amount: col.amount,
                        reason: col.reason || col.deductionReason || ''
                    });
                    
                    var row = worksheet.getRow(rowIndex);
                    row.alignment = { horizontal: 'center', vertical: 'middle' };
                    var bgColor = col.type === 'payment' ? 'FFE8F5E9' : 'FFFFE8E8';
                    row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
                    rowIndex++;
                });
                
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    saveAs(new Blob([buffer]), 'Ø¬Ù…ÙŠØ¹_Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª_' + new Date().toISOString().split('T')[0] + '.xlsx');
                    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø¥Ù„Ù‰ Excel');
                });
            }

            function renderExternalExpenses() {
                appData.currentView = 'external';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©";
                var html = '<div class="installment-card"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">' +
                    '<div><span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input type="date" id="ext-date" class="installment-input" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
                    '<div><span class="field-label">Ø§Ù„Ø¨ÙŠØ§Ù†</span><input type="text" id="ext-desc" class="installment-input"></div>' +
                    '<div><span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº</span><input type="number" id="ext-amount" class="installment-input"></div>' +
                    '</div><button onclick="addExternalRow()" style="width:100%;padding:10px;background:var(--sahab-red);color:white;border:none;border-radius:10px;cursor:pointer;margin-top:10px;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>' +
                    '<div class="installment-card"><table class="res-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>' +
                    appData.externalExpenses.map(function(ex, i) { return '<tr><td>' + ex.d + '</td><td>' + ex.t + '</td><td>' + ex.a.toLocaleString() + '</td><td><button onclick="deleteExternalExpense(' + i + ')" style="color:red;border:none;background:none;cursor:pointer;"><i class="fas fa-trash"></i></button></td></tr>'; }).join('') +
                    '</tbody></table></div>';
                document.getElementById('main-content').innerHTML = html;
            }

            function addExternalRow() {
                var d = document.getElementById('ext-date').value;
                var t = document.getElementById('ext-desc').value;
                var a = parseFloat(document.getElementById('ext-amount').value);
                if (d && t && a) { appData.externalExpenses.unshift({ d: d, t: t, a: a }); saveData(); renderExternalExpenses(); }
                else alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }

            function deleteExternalExpense(index) {
                if (confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) { appData.externalExpenses.splice(index, 1); saveData(); renderExternalExpenses(); }
            }

            function renderSettings() {
                appData.currentView = 'settings';
                document.getElementById('current-command-text').innerText = "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
                var syncStatus = lastCloudSync ? '<span style="color:#27ae60;">âœ… Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ' + new Date(lastCloudSync).toLocaleString('ar-EG') + '</span>' : '<span style="color:#ff9800;">âš ï¸ Ù„Ù… ØªØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¹Ø¯</span>';
                
                var html = '<div class="installment-card"><h3 style="color:var(--sahab-red);">â˜ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</h3>' +
                    '<div style="background:#f0f8ff;border:2px solid #3498db;border-radius:12px;padding:15px;margin-bottom:15px;">' + syncStatus + '</div>' +
                    '<button onclick="manualSyncFromCloud()" style="width:100%;padding:12px;background:var(--sahab-red);color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">â˜ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>' +
                    '</div>';
                
                // Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Admin ÙÙ‚Ø·)
                if (currentUser === 'admin') {
                    html += '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>' +
                        '<div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:10px;margin-bottom:15px;font-size:12px;color:#856404;">' +
                        '<strong>ğŸ”’ Ù…Ø­Ù…ÙŠØ©:</strong> Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‚ÙÙ„Ø©. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" Ù„ØªØºÙŠÙŠØ±Ù‡Ø§' +
                        '</div>' +
                        '<div style="display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:15px;">' +
                        '<div><span class="field-label">URL Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Upstash)</span><input type="text" id="cloud-url" class="installment-input" value="' + upstashConfig.url + '" placeholder="https://..." disabled></div>' +
                        '<div><span class="field-label">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (Token)</span><input type="password" id="cloud-token" class="installment-input" value="' + upstashConfig.token + '" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ Token" disabled></div>' +
                        '<div><span class="field-label">Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Key)</span><input type="text" id="cloud-key" class="installment-input" value="' + upstashConfig.key + '" placeholder="sahab_data" disabled></div>' +
                        '</div>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">' +
                        '<label style="display:flex;align-items:center;gap:10px;cursor:pointer;">' +
                        '<input type="checkbox" id="cloud-enabled" ' + (upstashConfig.enabled ? 'checked' : '') + ' style="width:18px;height:18px;cursor:pointer;" disabled>' +
                        '<span style="font-weight:bold;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</span>' +
                        '</label>' +
                        '</div>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">' +
                        '<button onclick="enableCloudEdit()" style="padding:12px;background:#ff9800;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">ğŸ”“ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>' +
                        '<button id="test-cloud-btn" onclick="testCloudConnection()" style="padding:12px;background:#3498db;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">' +
                        'ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„' +
                        '</button>' +
                        '</div>' +
                        '<button id="save-cloud-btn" onclick="saveCloudSettings()" style="width:100%;padding:12px;background:var(--sahab-green);color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;display:none;">' +
                        'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' +
                        '</button>' +
                        '</div>';
                }
                
                if (currentUser === 'admin') {
                    html += '<div class="installment-card"><h3 style="color:var(--sahab-red);">âš™ï¸ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</h3>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">' +
                        '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± Admin</span><input type="password" id="new-admin-pass" class="installment-input" value="' + passwords.admin + '"></div>' +
                        '<div><span class="field-label">ÙƒÙ„Ù…Ø© Ø³Ø± User</span><input type="password" id="new-viewer-pass" class="installment-input" value="' + passwords.viewer + '"></div>' +
                        '</div><button onclick="updatePasswords()" style="width:100%;padding:12px;background:var(--sahab-green);color:white;border:none;border-radius:10px;font-weight:900;cursor:pointer;margin-top:20px;">Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±</button></div>' +
                        '<div class="installment-card"><h3 style="color:var(--sahab-red);">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>' +
                        '<button onclick="exportBackup()" style="width:100%;padding:12px;background:#9b59b6;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:10px;">ğŸ“¥ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>' +
                        '<button onclick="document.getElementById(\'settingsImportFile\').click()" style="width:100%;padding:12px;background:#e67e22;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>' +
                        '<input type="file" id="settingsImportFile" style="display:none" accept=".json" onchange="handleImport(event)">' +
                        '</div>';
                }
                
                document.getElementById('main-content').innerHTML = html;
            }

            function enableCloudEdit() {
                if (!verifyAdminPassword('ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©')) return;
                
                cloudEditMode = true;
                document.getElementById('cloud-url').disabled = false;
                document.getElementById('cloud-token').disabled = false;
                document.getElementById('cloud-key').disabled = false;
                document.getElementById('cloud-enabled').disabled = false;
                
                document.getElementById('test-cloud-btn').style.display = 'none';
                document.getElementById('save-cloud-btn').style.display = 'block';
                
                alert('âœ… ØªÙ… ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"');
            }

            function testCloudConnection() {
                var url = document.getElementById('cloud-url').value;
                var token = document.getElementById('cloud-token').value;
                var key = document.getElementById('cloud-key').value;
                
                if (!url || !token || !key) {
                    alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                    return;
                }
                
                showCloudSyncIndicator('syncing', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
                
                fetch(url + '/get/' + key, {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(function(response) {
                    if (response.ok) {
                        showCloudSyncIndicator('success', 'âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
                        alert('âœ… Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©!\n\nâœ“ Ø§Ù„Ù€ URL ØµØ­ÙŠØ­\nâœ“ Ø§Ù„Ù€ Token ØµØ­ÙŠØ­\nâœ“ Ø§Ù„Ù€ Key ØµØ­ÙŠØ­');
                    } else {
                        showCloudSyncIndicator('error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„!\n\nÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£: ' + response.status + '\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:\n- Ø§Ù„Ù€ URL ØµØ­ÙŠØ­\n- Ø§Ù„Ù€ Token ØµØ­ÙŠØ­\n- Ø§Ù„Ù€ Key Ù…ÙˆØ¬ÙˆØ¯');
                    }
                })
                .catch(function(err) {
                    showCloudSyncIndicator('error', 'âŒ Ø®Ø·Ø£: ' + err.message);
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:\n\n' + err.message);
                });
            }

            function saveCloudSettings() {
                var url = document.getElementById('cloud-url').value;
                var token = document.getElementById('cloud-token').value;
                var key = document.getElementById('cloud-key').value;
                var enabled = document.getElementById('cloud-enabled').checked;
                
                if (!url || !token || !key) {
                    alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                    return;
                }
                
                upstashConfig = {
                    enabled: enabled,
                    url: url,
                    token: token,
                    key: key
                };
                
                localStorage.setItem('sahab_upstash_config', JSON.stringify(upstashConfig));
                cloudEditMode = false;
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\n' + 
                      (enabled ? 'ğŸŸ¢ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù…ÙØ¹Ù„Ø©' : 'ğŸ”´ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù…Ø¹Ø·Ù„Ø©'));
                renderSettings();
            }

            async function manualSyncFromCloud() {
                try {
                    var cloudData = await loadFromUpstash();
                    if (cloudData && cloudData.regions) {
                        appData.regions = cloudData.regions; appData.customers = cloudData.customers;
                        appData.expenses = cloudData.expenses; appData.externalExpenses = cloudData.externalExpenses;
                        appData.collections = cloudData.collections;
                        appData.customers.forEach(function(c) { if (!c.masterInstallments && c.installments) c.masterInstallments = ensureInstallmentIds(JSON.parse(JSON.stringify(c.installments)), c.unit || c.name); });
                        lastCloudSync = cloudData.lastUpdate || new Date().toISOString();
                        localStorage.setItem('sahab_last_sync', lastCloudSync);
                        saveToLocalStorage();
                        renderDashboard(); renderTree(); checkNotifications();
                        alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                    } else { alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©'); }
                } catch(e) { alert('âŒ Ø®Ø·Ø£: ' + e.message); }
            }

            function executeAction(name) {
                if (currentUser !== 'admin' && ['Ø¥Ø¶Ø§ÙØ©', 'ØªØ¹Ø¯ÙŠÙ„', 'Ø­Ø°Ù', 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·'].includes(name)) {
                    return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡");
                }
                if (name === 'Ø¥Ø¶Ø§ÙØ©') {
                    if (appData.currentView === 'regions') addRegion();
                    else if (appData.currentView === 'buildings') addBuilding();
                    else renderInstallmentForm();
                } else if (name === 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡') { renderCustomerRegistry(); }
                else if (name === 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ') { renderExpenses(); }
                else if (name === 'ØªØ­ØµÙŠÙ„ Ù‚Ø³Ø·') { renderCollection(); }
                else if (name === 'ØªØ¹Ø¯ÙŠÙ„') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') renderInstallmentForm(appData.selected.index);
                    else if (appData.selected.type === 'region') editRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') editBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø­Ø°Ù') {
                    if (!appData.selected.type) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹");
                    if (appData.selected.type === 'customer') deleteCustomer(appData.selected.index);
                    else if (appData.selected.type === 'region') deleteRegion(appData.selected.id);
                    else if (appData.selected.type === 'building') deleteBuilding(appData.selected.rid, appData.selected.id);
                } else if (name === 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©') { renderTreasury(); }
            }

            function addRegion() {
                if (!verifyAdminPassword('Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©')) return;
                var name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if (!name) return;
                name = name.trim();
                if (appData.regions.some(function(r) { return r.name.toLowerCase() === name.toLowerCase(); })) return alert('âŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!');
                appData.regions.push({ id: Date.now(), name: name, buildings: [] });
                saveData(); renderRegions();
            }

            function quickAddRegion() {
                var name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:");
                if (!name) return;
                name = name.trim();
                if (appData.regions.some(function(r) { return r.name.toLowerCase() === name.toLowerCase(); })) return alert('âŒ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!');
                appData.regions.push({ id: Date.now(), name: name, buildings: [] });
                saveData(); renderRegions();
            }

            function quickShowCustomers() { renderCustomerRegistry(); }
            function quickAddExpense() { renderExpenses(); }

            function addBuilding() {
                if (!verifyAdminPassword('Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©')) return;
                var rid = appData.selected.rid;
                if (!rid) return alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹");

                var name = prompt("ğŸ“‹ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©:");
                if (!name) return;

                // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                var floorsInput = prompt("ğŸ¢ ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©ØŸ (Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ A-1 Ø¥Ù„Ù‰ A-N)", "8");
                if (!floorsInput) return;
                var floors = parseInt(floorsInput);
                if (isNaN(floors) || floors < 1) return alert("âŒ Ø¹Ø¯Ø¯ Ø£Ø¯ÙˆØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­");

                // Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚ ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ±
                var unitsInput = prompt("ğŸšª ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚ ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ± Ù…ØªÙƒØ±Ø±ØŸ", "2");
                if (!unitsInput) return;
                var unitsPerFloor = parseInt(unitsInput);
                if (isNaN(unitsPerFloor) || unitsPerFloor < 1) return alert("âŒ Ø¹Ø¯Ø¯ Ø´Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­");

                // Ø¨ÙŠØ³Ù…Ù†Øª
                var hasBasement = confirm("ğŸ…±ï¸ Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ³Ù…Ù†Øª (B)ØŸ");

                // Ø±ÙˆÙ
                var hasRoof = confirm("ğŸ  Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø±ÙˆÙ (R)ØŸ");
                var roofCount = 1;
                if (hasRoof) {
                    var roofInput = prompt("ÙƒÙ… Ø¹Ø¯Ø¯ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø±ÙˆÙØŸ", "1");
                    roofCount = parseInt(roofInput) || 1;
                }

                var reg = appData.regions.find(function(r) { return r.id === rid; });
                var units = generateSahabUnits(hasBasement, floors, unitsPerFloor, hasRoof, roofCount);
                reg.buildings.push({ id: Date.now(), name: name, units: units });
                saveData(); renderBuildings(rid);

                // Ù…Ù„Ø®Øµ Ù…Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
                var summary = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…Ø§Ø±Ø© "' + name + '" Ø¨Ù†Ø¬Ø§Ø­!\n\n';
                if (hasBasement) summary += 'â—¾ Ø¨ÙŠØ³Ù…Ù†Øª: B\n';
                summary += 'â—¾ Ø£Ø¯ÙˆØ§Ø± Ù…ØªÙƒØ±Ø±Ø©: A-1 Ø¥Ù„Ù‰ A-' + floors + ' (' + (floors * unitsPerFloor) + ' Ø´Ù‚Ø©)\n';
                if (hasRoof) summary += 'â—¾ Ø±ÙˆÙ: ' + roofCount + ' ÙˆØ­Ø¯Ø©\n';
                summary += '\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ' + units.length;
                alert(summary);
            }

            function editRegion(id) {
                if (!verifyAdminPassword('ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚Ø©')) return;
                var reg = appData.regions.find(function(r) { return r.id === id; });
                var newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:", reg.name);
                if (newName) { reg.name = newName; saveData(); renderRegions(); }
            }

            function editBuilding(rid, bid) {
                if (!verifyAdminPassword('ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ø§Ø±Ø©')) return;
                var reg = appData.regions.find(function(r) { return r.id === rid; });
                var bld = reg.buildings.find(function(b) { return b.id === bid; });
                var newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©:", bld.name);
                if (newName) { bld.name = newName; saveData(); renderBuildings(rid); }
            }

            function deleteRegion(id) {
                if (!verifyAdminPassword('Ø­Ø°Ù Ù…Ù†Ø·Ù‚Ø©')) return;
                if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { appData.regions = appData.regions.filter(function(r) { return r.id !== id; }); saveData(); renderRegions(); }
            }

            function deleteBuilding(rid, bid) {
                if (!verifyAdminPassword('Ø­Ø°Ù Ø¹Ù…Ø§Ø±Ø©')) return;
                if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    var reg = appData.regions.find(function(r) { return r.id === rid; });
                    reg.buildings = reg.buildings.filter(function(b) { return b.id !== bid; });
                    saveData(); renderBuildings(rid);
                }
            }

            function deleteCustomer(index) {
                var c = appData.customers[index];
                if (!confirm('âš ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + c.name + 'ØŸ')) return;
                if (!verifyAdminPassword('Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + c.name)) return;
                appData.regions.forEach(function(r) { r.buildings.forEach(function(b) { var u = b.units.find(function(u) { return u.code === c.unit && b.name === c.building; }); if (u) u.status = 'available'; }); });
                for (var i = appData.collections.length - 1; i >= 0; i--) { if (appData.collections[i].customerIndex === index) appData.collections.splice(i, 1); }
                appData.customers.splice(index, 1);
                saveData(); renderCustomerRegistry();
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ù‚Ø³Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
            function getInstallmentRealStatus(custIdx, instId, instAmount) {
                var totalPaid = 0;
                appData.collections.forEach(function(col) {
                    if (col.customerIndex !== custIdx || col.type !== 'payment') return;
                    // Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ÙÙŠÙ‡Ø§ appliedInstallments (Ù…ØµÙÙˆÙØ© ØªÙˆØ²ÙŠØ¹)
                    if (Array.isArray(col.appliedInstallments)) {
                        col.appliedInstallments.forEach(function(ap) {
                            if (ap.installmentId === instId) totalPaid += (ap.amount || 0);
                        });
                    }
                    // Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ÙÙŠÙ‡Ø§ installmentId Ù…Ø¨Ø§Ø´Ø±Ø©
                    else if (col.installmentId === instId) {
                        totalPaid += (col.amount || 0);
                    }
                });
                if (totalPaid >= instAmount * 0.999) return 'paid'; // Ù‡Ø§Ù…Ø´ ØµØºÙŠØ± Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
                if (totalPaid > 0) return 'partial';
                return 'pending';
            }

            function checkNotifications() {
                var today = new Date().toISOString().split('T')[0];
                var lateCount = 0;
                appData.customers.forEach(function(c, custIdx) {
                    var masterInst = c.masterInstallments || c.installments || [];
                    var hasLate = masterInst.some(function(inst) {
                        if (!inst.d || inst.d > today) return false;
                        var realStatus = getInstallmentRealStatus(custIdx, inst.id, inst.a);
                        return realStatus === 'pending' || realStatus === 'partial';
                    });
                    if (hasLate) lateCount++;
                });
                var badge = document.getElementById('notif-count');
                if (badge) { badge.innerText = lateCount; badge.style.display = lateCount > 0 ? 'flex' : 'none'; }
            }

            function showNotifications() {
                var today = new Date().toISOString().split('T')[0];
                var lateCustomers = [];
                appData.customers.forEach(function(c, custIdx) {
                    var masterInst = c.masterInstallments || c.installments || [];
                    var lateInst = masterInst.filter(function(inst) {
                        if (!inst.d || inst.d > today) return false;
                        var realStatus = getInstallmentRealStatus(custIdx, inst.id, inst.a);
                        return realStatus === 'pending' || realStatus === 'partial';
                    });
                    if (lateInst.length > 0) {
                        lateCustomers.push({ idx: custIdx, name: c.name, phone: c.phone, building: c.building, unit: c.unit, lateCount: lateInst.length, lateAmount: lateInst.reduce(function(s,x) { return s+x.a; }, 0) });
                    }
                });
                if (lateCustomers.length === 0) { alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©!'); return; }
                document.getElementById('current-command-text').innerText = 'â° Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (' + lateCustomers.length + ' Ø¹Ù…ÙŠÙ„)';
                var html = '<div style="background:#fff3cd;border:2px solid #ff9800;border-radius:12px;padding:15px;margin-bottom:15px;text-align:center;"><strong style="color:#856404;">âš ï¸ ÙŠÙˆØ¬Ø¯ ' + lateCustomers.length + ' Ø¹Ù…ÙŠÙ„ Ù„Ø¯ÙŠÙ‡Ù… Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ£Ø®Ø±Ø©</strong></div>';
                lateCustomers.forEach(function(cust) {
                    html += '<div class="installment-card" style="border-left:5px solid #e74c3c;cursor:pointer;" onclick="renderCollectionForCustomer(' + cust.idx + ')">' +
                        '<strong style="color:var(--sahab-red);">' + cust.name + '</strong> - ' + cust.building + '/' + cust.unit + '<br>' +
                        '<small>ğŸ“ ' + cust.phone + '</small>&nbsp;&nbsp;<strong style="color:#e74c3c;">' + cust.lateCount + ' Ù‚Ø³Ø· - ' + cust.lateAmount.toLocaleString() + ' Ø¬Ù†ÙŠÙ‡</strong>' +
                        '<br><button onclick="renderCollectionForCustomer(' + cust.idx + ')" style="margin-top:8px;padding:6px 15px;background:var(--sahab-green);color:white;border:none;border-radius:6px;cursor:pointer;">ğŸ’³ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¢Ù†</button>' +
                        '</div>';
                });
                document.getElementById('main-content').innerHTML = html;
            }

            function goBack() {
                if (appData.currentView === 'units') renderBuildings(appData.selected.rid);
                else if (appData.currentView === 'buildings') renderRegions();
                else renderDashboard();
            }

            function exportBackup() {
                var dataToExport = { timestamp: new Date().toISOString(), regions: appData.regions, customers: appData.customers, expenses: appData.expenses, externalExpenses: appData.externalExpenses, collections: appData.collections };
                var dataStr = JSON.stringify(dataToExport, null, 2);
                var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                var link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', 'sahab_backup_' + new Date().toISOString().split('T')[0] + '.json');
                link.click();
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
            }

            function handleImport(event) {
                var file = event.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var imported = JSON.parse(e.target.result);
                        if (imported.regions !== undefined && imported.customers !== undefined) {
                            appData.regions = imported.regions || []; appData.customers = imported.customers || [];
                            appData.expenses = imported.expenses || []; appData.externalExpenses = imported.externalExpenses || [];
                            appData.collections = imported.collections || [];
                            appData.customers.forEach(function(c) { if (!c.masterInstallments && c.installments) c.masterInstallments = ensureInstallmentIds(JSON.parse(JSON.stringify(c.installments)), c.unit || c.name); });
                            saveData(); renderDashboard(); checkNotifications();
                            alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ' + appData.customers.length);
                        } else { alert('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­'); }
                    } catch(err) { alert('âŒ Ø®Ø·Ø£: ' + err.message); }
                };
                reader.readAsText(file);
            }

            function updatePasswords() {
                var adminP = document.getElementById('new-admin-pass').value;
                var viewerP = document.getElementById('new-viewer-pass').value;
                if (!adminP || !viewerP) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±");
                passwords.admin = adminP; passwords.viewer = viewerP;
                localStorage.setItem('sahab_passwords', JSON.stringify(passwords));
                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±');
            }

            function updateClock() {
                var now = new Date();
                var clockEl = document.getElementById('clock');
                var dateEl = document.getElementById('date');
                if (clockEl) clockEl.innerText = now.toLocaleTimeString('ar-EG');
                if (dateEl) dateEl.innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            setInterval(updateClock, 1000);
            updateClock();

            function removeDuplicateRegions() {
                var seen = new Set(); var before = appData.regions.length;
                appData.regions = appData.regions.filter(function(r) { var key = r.name.toLowerCase().trim(); if (seen.has(key)) return false; seen.add(key); return true; });
                var removed = before - appData.regions.length;
                if (removed > 0) { saveData(); alert('âœ… ØªÙ… Ø­Ø°Ù ' + removed + ' Ù…Ù†Ø·Ù‚Ø© Ù…ÙƒØ±Ø±Ø©'); renderRegions(); }
                else alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…ÙƒØ±Ø±Ø©');
            }

            function showAvailableUnits() {
                document.getElementById('current-command-text').innerText = 'ğŸ¢ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©';
                
                var html = '<div style="background:#e8f5e9;border:2px solid var(--sahab-green);border-radius:12px;padding:15px;margin-bottom:15px;text-align:center;">' +
                    '<h3 style="color:var(--sahab-green);margin:0;">ğŸ¢ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3></div>';
                
                html += '<button onclick="exportAvailableUnitsExcel()" style="width:100%;padding:12px;background:#27ae60;color:white;border:none;border-radius:10px;font-weight:bold;margin-bottom:15px;cursor:pointer;"><i class="fas fa-file-excel"></i>&nbsp;&nbsp;ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¥Ù„Ù‰ Excel</button>';
                
                appData.regions.forEach(function(region) {
                    var availableInRegion = [];
                    region.buildings.forEach(function(building) {
                        var availableUnits = building.units.filter(function(u) { return u.status === 'available'; });
                        if (availableUnits.length > 0) {
                            availableInRegion.push({ building: building.name, units: availableUnits });
                        }
                    });
                    
                    if (availableInRegion.length > 0) {
                        html += '<div class="installment-card" style="margin-bottom:15px;">' +
                            '<h4 style="color:var(--sahab-red);margin-top:0;"><i class="fas fa-map-marker-alt"></i>&nbsp;&nbsp;' + region.name + ' (' + availableInRegion.reduce(function(s,b) { return s + b.units.length; }, 0) + ' ÙˆØ­Ø¯Ø© Ù…ØªØ§Ø­Ø©)</h4>';
                        
                        availableInRegion.forEach(function(bld) {
                            html += '<div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:10px;border-right:5px solid var(--sahab-green);">' +
                                '<strong style="color:var(--sahab-red);"><i class="fas fa-building"></i>&nbsp;&nbsp;' + bld.building + '</strong>' +
                                ' <span style="color:var(--sahab-green);font-weight:bold;">(' + bld.units.length + ' ÙˆØ­Ø¯Ø©)</span><br>' +
                                '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;">';
                            
                            bld.units.forEach(function(unit) {
                                html += '<span style="background:var(--sahab-green);color:white;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:bold;">' + unit.code + '</span>';
                            });
                            
                            html += '</div></div>';
                        });
                        
                        html += '</div>';
                    }
                });
                
                document.getElementById('main-content').innerHTML = html;
            }

            function exportAvailableUnitsExcel() {
                var workbook = new ExcelJS.Workbook();
                var worksheet = workbook.addWorksheet('Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©');
                
                worksheet.columns = [
                    { header: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', key: 'region', width: 20 },
                    { header: 'Ø§Ù„Ø¹Ù…Ø§Ø±Ø©', key: 'building', width: 20 },
                    { header: 'ÙƒÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø©', key: 'code', width: 15 },
                    { header: 'Ø§Ù„Ù†ÙˆØ¹', key: 'type', width: 15 }
                ];
                
                worksheet.getRow(1).font = { bold: true, size: 12 };
                worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF8B1A1A' } };
                worksheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
                worksheet.getRow(1).alignment = { horizontal: 'center', vertical: 'middle' };
                
                var rowIndex = 2;
                appData.regions.forEach(function(region) {
                    region.buildings.forEach(function(building) {
                        var availableUnits = building.units.filter(function(u) { return u.status === 'available'; });
                        availableUnits.forEach(function(unit) {
                            worksheet.addRow({
                                region: region.name,
                                building: building.name,
                                code: unit.code,
                                type: unit.type
                            });
                            
                            var row = worksheet.getRow(rowIndex);
                            row.alignment = { horizontal: 'center', vertical: 'middle' };
                            row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowIndex % 2 === 0 ? 'FFE8F5E9' : 'FFFFFFFF' } };
                            rowIndex++;
                        });
                    });
                });
                
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    saveAs(new Blob([buffer]), 'Ø§Ù„ÙˆØ­Ø¯Ø§Øª_Ø§Ù„Ù…ØªØ§Ø­Ø©_' + new Date().toISOString().split('T')[0] + '.xlsx');
                    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¥Ù„Ù‰ Excel');
                });
            }

            window.onload = function() {
                // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                document.getElementById('login-screen').style.display = 'flex';
                // Ø¶ØºØ· Enter Ù„Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('login-pass').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            };
        </script>
    </body>
    </html>
